<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>报销预支单审批</title>
<link rel="stylesheet" type="text/css" href="../../css/iconFont/iconfont.css">
<link rel="stylesheet" type="text/css" href="../../layui/css/layui.css">
<link rel="stylesheet" type="text/css" href="../../layui/css/admin.css">
<script src="../../js/jquery.min.js"></script>
</head>
	
<body layadmin-themealias="default">
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-card-header"><i class="iconfont mr-5 icon-xiujiashenqing"></i>我的报销付款单</div>
            <div class="layui-card-body">
                <div  class="layui-form">
                    <div class="layui-form-item">
                         <div class="layui-inline mb-5">
                            <label class="layui-form-label" style="width: 60px;">ID</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="ID" name="ID"
                                        placeholder="请输入ID">
                            </div>
                        </div>
                       <div class="layui-inline mb-5">
                           <label class="layui-form-label">选择状态</label>
                           <div class="layui-input-inline">
                                <select class="slct"  name="myfinanDescSel" lay-filter="myfinanDescSel"  id="myfinanDescSel"><option value="-1">全部</option><option value="0">待审批</option><option value="1">未批准</option><option value="2">已批准</option></select>
                           </div>
                       </div>
                       <div class="layui-inline">
                            <label class="layui-form-label">申请时间</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="sqSTime">
                            </div>
                             <span  class="layui-inline" style="float: left;line-height: 38px;"> ~ </span> 
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input" id="sqETime">
                            </div>
                        </div>
                       <div class="layui-inline">
                            <button class="layui-btn" id="sqFinancial" title="查询">查询</button>
                            <button class="layui-btn" id="Empty" title="查询">清空</button>
                        </div>
                    </div>
                </div>
                <table class="layui-table layui-form" id="financialTable" lay-filter="financialTable"></table>
            </div>
        </div>
    </div>
   
</body>
<style>
pre{
    display:block;
    visibility:hidden;
}
.expandingArea textarea.layui-textarea{
    position:absolute;
    top:0;
    left:0;
    border:none;
    height:100% !important;
}
.expandingArea{
    position:relative;
} 
.expandingArea .layui-textarea{
    min-height:auto;
}
</style>
<script src="../../layui/layui.js"></script>
<script src="../../js/jquery.jqprint-0.3.js?v=201902190"></script>
<script src="../../js/common.js?0.1"></script>
<!-- <script src="../../js/clipboard.min.js"></script> -->
<script>
$(function(){
    layui.config({
        base: '../../../layui/' //静态资源所在路径
    }).extend({
        index: 'index' //主入口模块
    }).use(['index','table','laydate','form','laypage','upload'], function(){
        var $ = layui.$
        ,admin = layui.admin
        ,element = layui.element
        ,router = layui.router();
        element.render();

        var laydate = layui.laydate
        ,form = layui.form
        ,layer = layui.layer
        ,table=layui.table
        ,laypage=layui.laypage;
        form.render('select');
        laydate.render({ 
            elem: '#sqSTime'
            ,type: 'datetime'
        });
    
        laydate.render({ 
            elem: '#sqETime'
            ,type: 'datetime'
        });

        var urlTab = location.href.split('?tab=')[1]?location.href.split('?tab=')[1]:false;
        var tabId=urlTab?urlTab.split('?')[0]:false;
        var dataId = location.href.split('?id=')[1]?location.href.split('?id=')[1]:false;

        if(dataId){
            var tableSub={
                ApprovalResult:'-1',
                ID:dataId
            }
            detailFun(dataId);
            
        }else{
            var tableSub={
                ApprovalResult:'-1'
            }
        }
       
        $("#sqFinancial").on("click",function(){
            var st=$('#sqSTime').val();
            var et=$('#sqETime').val();
            var ApplyResult = $("#myfinanDescSel").val();
            var ID = $("#ID").val();
            ReimTable.reload({
                where: {
                    ID:ID,
                    ApplyResult: ApplyResult,
                    EndTime:et,
                    StartTime:st,
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        })
        $("#Empty").on("click",function(){
            $('#sqSTime').val('');
            $('#sqETime').val('');
            $('#ID').val('');
            var ApplyResult = $("#myfinanDescSel").val();
            ReimTable.reload({
                where: {
                    ID:'',                    
                    ApplyResult: ApplyResult,
                    EndTime:'',
                    StartTime:'',
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        })
        // 数据表格渲染
        // financialTable
        var ReimTable = table.render({
            elem: '#financialTable',
            url: window.urls + '/gateway/financial/myapply',
            limits:[10,20,30,40,50,60,70,80,90,100,200,500,1000,5000],
            toolbar:true,
            defaultToolbar: ['filter', 'print', 'exports'],
            where:tableSub,
            method: 'post',
            contentType: 'application/json',
            page: true,
            loading: true,
            toolbar:true,
            // defaultToolbar: '',
            text: {
                none: '暂无数据' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
            },
            cols: [
                [{
                    sort:true,
                    field: 'id',
                    title: 'ID',
                    minWidth:160,
                    unresize: true
                }, {
                    sort:true,
                    field: 'created_at',
                    title: '申请时间',
                    minWidth:160,
                    unresize: true
                }, {
                    sort:true,
                    field: 'process_type_name',
                    unresize: true,
                    minWidth: 100,
                    title: '流程类型'
                },{sort: true,
                        field: 'yz_to_bx_desc',
                        title: '预支转报销',
                        minWidth: 110,
                        
                    }, {
                    sort:true,
                    field: 'baoxiao_type_name',
                    unresize: true,
                    minWidth: 90,
                    title: '类型'
                },{//
                    sort:true,
                    field: 'fee_type_name',
                    unresize: true,
                    minWidth: 90,
                    title: '子类型'
                },{//
                        sort:true,
                        field: 'finan_dept_name',
                        unresize: true,
                        minWidth: 90,
                        title: '费用部门'
                    }, {
                    // symbol
                    sort:true,
                    field: 'amount',
                    title: '金额',
                    minWidth: 110,
                    // templet: function (d) {
                    //     var len = d.amount;
                    //     var xx = d.symbol;
                    //     return len + '（'+xx+'）'
                    // }
                },  {
                    // symbol
                    sort:true,
                    field: 'zh_name',
                    title: '币种',
                    minWidth: 80,
                    // // templet: function (d) {
                    // //     var len = d.amount;
                    //     var xx = d.symbol;
                    //     return len + '（'+xx+'）'
                    // }
                },{
                    sort:true,
                    field: 'receipt_count',
                    title: '单据数',
                    minWidth: 80
                }
                // ,{
                //     sort:true,
                //     field: 'is_fixed_costs',
                //     title: '固定费用',
                //     minWidth: 100,
                //     templet: function (d) { 
                //         return d.is_fixed_costs==1?'是':'否';
                //     } 
                //}
                ,{
                    sort:true,
                    field: 'liezhi_month',
                    unresize: true,
                    title: '列支年月',
                    minWidth: 110
                },  {
                    sort:true,
                    field: 'current_approval_user_name',
                    title: '当前审批人',
                    minWidth: 140,
                    // templet: function (d) { 
                    //     return d.is_group==1?'集团':d.current_approval_user_name;
                    // } 
                }, {
                    sort:true,
                    field: 'apply_result_desc',
                    title: '状态',
                    unresize: true,
                    minWidth: 130,
                },{
                        sort:true,
                        field: 'cancel_desc',
                        title: '取消状态',
                        width: 130,
                        // templet: function (d) {
                        //         console.log(d.is_cancel)
                        //     var resu=(d.is_cancel==1?'申请取消':(d.is_cancel==2?'已取消':' '))+'';
                        //         if(d.is_cancel !=0 &&d.parent_id == 0){
                        //             resu +=' | 原始单'
                        //         }
                        //         return resu
                        // } 
                    },  {
                    // field: '',
                    fixed: 'right',
                    title: '操作',
                    width: 210,
                    unresize: false,
                    templet: function (d) {
                        var len = Number(d.approval_history.length);
                        var qxsq ='';
                        // console.log(len)
                        // if(d.apply_result!=2&&d.is_cancel!=2){
                        //     qxsq ='<a  class="cancel layui-btn layui-btn-warm layui-btn-xs" lay-event="qxsq">取消申请</a>'
                        // }

                        // if(d.apply_result==0){//可编辑 可删除 len
                        //     if(d.is_yz_to_bx == 0 ){
                        //         var bjbtn='<a  class="detail layui-btn layui-btn-warm layui-btn-xs layui-btn-'+disabledBj+'" '+disabledBj+' '+(( d.is_cancel==1||len!=0)?"":"lay-event=\"edits\"")+'>编辑</a>';
                        //     }else{
                        //         var bjbtn=''
                        //     }

                        //     return  '<div><a  class="detail layui-btn layui-btn-warm layui-btn-xs"  lay-Event="detail">详情</a>'+bjbtn+'<a  class="detail layui-btn layui-btn-warm layui-btn-xs  layui-btn-'+lens+'" '+lens+' '+(len!=0?"":"lay-event=\"del\"")+' >删除</a>'+qxsq+'</div>'
                            
                        // }else if(d.apply_result==2){//只能取消
                            
                        //     if(d.can_yz_to_bx){
                        //         var btnToBX='<a  class="detail layui-btn layui-btn-warm layui-btn-xs"  lay-Event="toBX">转报销</a>'
                        //     }else{
                        //         var btnToBX='';
                        //     }
                        //     if(d.is_yz_to_bx == 0 ){                                                                                            //cashier_approval_result ==1 显示撤回
                        //         var qxbtn='<a  class="cancel layui-btn layui-btn-warm layui-btn-xs layui-btn-'+disabled+'" '+disabled+'  '+(d.is_cancel!=0?"":"lay-event=\"cancel\"")+'>撤回</a>';
                        //     }else{
                        //         var qxbtn=''
                        //     }

                        //     return  '<div><a  class="detail layui-btn layui-btn-warm layui-btn-xs"  lay-Event="detail">详情</a>'+qxbtn+btnToBX+''+qxsq+'</div>'
						// }else if(d.apply_result==1){//只能取消
						// 	return  '<div><a  class="detail layui-btn layui-btn-warm layui-btn-xs"  lay-Event="detail">详情</a>'+qxsq+'</div>'
                        // }
                        //取消申请
                        if(d.apply_result!=1&&d.cashier_approval_result ==0&&d.is_cancel!=2&&len!=0){
                            var qxsq ='<a  class="cancel layui-btn layui-btn-warm layui-btn-xs" lay-event="qxsq">取消</a>'
                        }else{
                            var qxsq=''
                        }
                        
                        //编辑                        
                        if(d.apply_result==0&&d.is_yz_to_bx==0&&len==0&&d.is_cancel!=1){
                            var bjbtn='<a  class="detail layui-btn layui-btn-warm layui-btn-xs" lay-event="edits">编辑</a>'
                        }else{
                            var bjbtn=''
                        }

                        //删除                        
                        if(d.apply_result==0&&len==0){
                            var delBtn='<a  class="detail layui-btn layui-bg-red layui-btn-xs" lay-event="del">删除</a>'
                        }else{
                            var delBtn=''
                        }

                        //转报销                        
                        if(d.apply_result==2&&d.can_yz_to_bx==1){//
                            var btnToBX='<a  class="detail layui-btn layui-btn-warm layui-btn-xs"  lay-Event="toBX">转报销</a>'
                        }else{
                            var btnToBX='';
                        }

                        //撤回   
                        // d.apply_result==2&&d.can_yz_to_bx==0&&d.is_cancel==0&&d.cashier_approval_result ==1
                     
                        if(d.apply_result == 2 && d.is_yz_to_bx !=1 && d.is_cancel==0 && d.cashier_approval_result ==1){//
                            var btnCancel='<a  class="detail layui-btn layui-btn-warm layui-btn-xs"  lay-Event="cancel">撤回</a>'
                        }else{
                            var btnCancel=' ';
                        }
                        // console.log(btnCancel)
                        return  '<div><a class="layui-btn layui-btn-xs"  lay-Event="detail">详情</a>'+qxsq+bjbtn+delBtn+btnToBX+btnCancel+'</div>'
						// return lenList
					},
                }]
            ],
            request: {
                pageName: 'currentIndex' //页码的参数名称，默认：page
                ,limitName: 'pageSize' //每页数据量的参数名，默认：limit
            },
            parseData: function (res) { //res 即为原始返回的数据
                return {
                    "status_code": res.status_code, //解析接口状态
                    "message": res.message, //解析提示文本
                    "count": res.data.total_count, //解析数据长度
                    "data": res.data.data_list, //解析数据列表
                    "curr": res.data.page_index
                };
            },
            done: function (rs) {
                // $("#myfinanDescSel").val(this.where.ApplyResult);
                form.render();
                if(dataId&&this.where.ID!=''){
                    $('.layui-table-body.layui-table-main a[lay-event="detail"]').click();
                }
            }
        });
        form.on('select(myfinanDescSel)', function (data) {
            var st=$('#sqSTime').val();
            var et=$('#sqETime').val();
            var ID=$('#ID').val();
            ReimTable.reload({
                where: {
                    ID:ID,
                    ApplyResult: data.value,
                    EndTime:et,
                    StartTime:st,
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                ,done: function (rs) {
                    $("#myfinanDescSel").val(this.where.ApplyResult);
                    form.render();
                    
                }
            });
        });
        table.on('tool(financialTable)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            var tr = obj.tr; //获得当前行 tr 的DOM对象
        
            if(layEvent === 'detail'){ //查看
            //do somehing
                var fid =obj.data.id;
                $.fetch({
                    url:"/gateway/financial/detail",
                    type: 'post',
                    data:{
                        ID:fid,
                    },
                    cb:function(rs){
                        // if(rs.is_fixed_costs==1){
                        //     var attachesUrl='/gateway/financial/downloadfixedcost/'
                        // }else{
                        //     var attachesUrl='/gateway/financial/download/'
                        // }
                        var attachesUrl='/gateway/financial/download/'
                        var details ='',attaches='',apprList='';
                        
                        for(var i=0;i<rs.details.length;i++){
                            details+='<tr><td>'+rs.details[i].fee_type_name+'</td><td class="expandingArea "><pre style="display:block;visibility:hidden;"><span>'+rs.details[i].remark+'</span><br></pre><textarea readonly  class="layui-textarea Remark">'+rs.details[i].remark+'</textarea></td><td>'+rs.details[i].receipt_count+'</td><td>'+rs.details[i].amount+'</td></tr>'
                        }
                        if(rs.attaches&&rs.attaches.length>0){
                            for(var j=0;j<rs.attaches.length;j++){
                                attaches+='<a  title="点击下载" target="_blank" href="'+attachesUrl+''+rs.attaches[j].id+'">'+rs.attaches[j].original_name+'</a>'
                            }
                        }else{
                            attaches='无附件'
                        }
                        
                        var approval =rs.approval_history;
                        if(approval.length==0){
                        apprList ='暂无';
                        }else{
                            for(var k=0;k< approval.length;k++){

                                var res='';
                                var classList = '';
                                var approvalCont = approval[k].content==null?' ':approval[k].content
                                if(approval[k].is_forward ==1){//是转发的
                                    res ='--转发-->';
                                apprList+='<p>【'+approval[k].username+''+res+ ''+approval[k].forward_username+''//名字
                                                //意见
                                            +'<em class='+classList+'> ' +approval[k].approval_time+'</em>】：'//时间
                                                +approvalCont+'</p>'//意见内容
        
                                }else{//是审批的
        
                                    if(approval[k].approval_result==1){
                                        res ="未批准";
                                        classList = "red";
                                    }else if(approval[k].approval_result==2){
                                        res ="已批准";
                                        classList = 'green';
                                    }
                                apprList+='<p><span> 【'+approval[k].username +'<em class='+classList+'>'+res+' '+approval[k].approval_time+'</em>'+'】</span>'+approvalCont+'</p>'
                                }
                            
                            };
                        }
                        var detailPop='<div class="layui-fluid">'
                                        +'<div class="layui-form" id="printHtml">'
                                            // +'<div class="layui-form-mid layui-word-aux">IP：'+rs.createor_ip+'</div>'
                                            // +'<div class="fr layui-word-aux" style="padding: 9px 0!important;">申请时间：'+rs.created_at+'</div>'
                                            +'<div class="layui-form-item">'
                                                +'<div class="layui-inline layui-word-aux">'
                                                    +'<label class="layui-form-label modify-layui-label ">申请时间</label>'
                                                    +'<div class="layui-input-block layui-input-lineHeight">'
                                                        +'<span>'+rs.created_at+'</span>'
                                                    +'</div>'
                                                +'</div>'
                                                // if(rs.is_fixed_costs==1){
                                                //     detailPop+='<div class="layui-inline layui-word-aux">'
                                                //         +'<label class="layui-form-label modify-layui-label ">开始日期</label>'
                                                //         +'<div class="layui-input-block layui-input-lineHeight">'
                                                //             +'<span>'+rs.fixed_cost_start_month+'</span>'
                                                //         +'</div>'
                                                //     +'</div>'
                                                //     +'<div class="layui-inline layui-word-aux">'
                                                //         +'<label class="layui-form-label modify-layui-label ">结束日期</label>'
                                                //         +'<div class="layui-input-block layui-input-lineHeight">'
                                                //             +'<span>'+rs.fixed_cost_end_month+'</span>'
                                                //         +'</div>'
                                                //     +'</div>'
                                                //     +'<div class="layui-inline layui-word-aux">'
                                                //         +'<label class="layui-form-label modify-layui-label">生效时间</label>'
                                                //         +'<div class="layui-input-block layui-input-lineHeight">'
                                                //             +'<span>'+rs.fixed_cost_job_date+'</span>'
                                                //         +'</div>'
                                                //     +'</div>'
                                                // }
                                                detailPop+='</div>'
                                            // +'<div class="layui-form-item">'
                                            //     +'<label class="layui-form-label modify-layui-label">列支科目</label>'
                                            //     +'<div class="layui-input-block layui-input-lineHeight">'
                                            //         +'<span>'+rs.liezhi_kemu+'</span>'
                                            //     +'</div>'
                                            // +'</div>'
                                            +'<div class="layui-form-item">'
                                                +'<div class="layui-inline">'
                                                    +'<label class="layui-form-label modify-layui-label">流程类型</label>'
                                                    +'<div class="layui-input-block layui-input-lineHeight">'
                                                    +'<span>'+(rs.is_yz_to_bx==1?'预支转':'')+rs.process_type_name+'</span>'
                                                    +'</div>'
                                                +'</div>'
                                                +'<div class="layui-inline">'
                                                    +'<label class="layui-form-label modify-layui-label">类型</label>'
                                                    +'<div class="layui-input-block layui-input-lineHeight">'
                                                        +'<span>'+rs.baoxiao_type_name+'</span>'
                                                    +'</div>'
                                                +'</div>'
                                                +'<div class="layui-inline">'
                                                    +'<label class="layui-form-label modify-layui-label">费用部门</label>'
                                                    +'<div class="layui-input-block layui-input-lineHeight">'
                                                        +'<span>'+(rs.finan_dept_name==null?'暂无':''+rs.finan_dept_name+'')+'</span>'
                                                    +'</div>'
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-form-item">'
                                                +'<label class="layui-form-label modify-layui-label">支付明细</label>'
                                                +'<div class="layui-input-block">'
                                                    +'<table class="layui-table" id="lzmFormData">'
                                                        +'<thead><tr></tr></thead>'
                                                        +'<tbody><tr><td>暂无</td></tr></tbody>'
                                                    +'</table>'
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-form-item">'
                                                +'<label class="layui-form-label">费用明细</label>'
                                                +'<div class="layui-input-block">'
                                                    +'<table class="layui-table">'
                                                        +'<colgroup><col width="150"><col><col width="150"><col width="150"><col width="130"></colgroup>'
                                                        +'<thead><tr><th>费用类型</th><th>费用摘要</th><th>单据数量</th><th>金额 '+rs.zh_name+'('+rs.short_code+')</th></tr></thead>'
                                                        +'<tbody>'+details+'</tbody>'
                                                    +'</table>'
                                                +'</div>'
                                            +'</div>'
                                            if(rs.financial_type_code=='FK'){
                                             detailPop+='<div class="layui-form-item">'
                                                        +'<label class="layui-form-label">付款信息</label>'
                                                        +'<div class="layui-input-block">'
                                                            +'<table class="layui-table">'
                                                                +'<tr><td>'
                                                                +'<div class="layui-form-item">'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label"><span class="red"> ＊</span>银行</label>'
                                                                        +'<div class="layui-input-inline"><input  type="text" readonly class="layui-input" name="BankName" id="BankName"   value="'+(rs.bank_name==null?'':rs.bank_name)+'"></div>'
                                                                    +'</div>'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label">开户支行</label>'
                                                                        +'<div class="layui-input-inline"> <input type="text" readonly  name="Branch" id="Branch" class="layui-input" value="'+(rs.branch==null?'':rs.branch)+'"></div>'
                                                                    +'</div>'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label"><span class="red"> ＊</span> 银行账号</label>'
                                                                        +'<div class="layui-input-inline"><input type="text" readonly  name="BankAccount" id="BankAccount"  class="layui-input" value="'+(rs.bank_account==null?'':rs.bank_account)+'"></div>'
                                                                    +'</div>'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label"><span class="red"> ＊</span> 开户人</label>'
                                                                        +'<div class="layui-input-inline"><input type="text" readonly  name="AccountName" id="AccountName"  class="layui-input" value="'+(rs.account_name==null?'':rs.account_name)+'"></div>'
                                                                    +'</div>'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label">省份</label>'
                                                                        +'<div class="layui-input-inline"><input type="text" readonly name="Province" id="Province" class="layui-input" value="'+(rs.province==null?'':rs.province)+'"></div>'
                                                                    +'</div>'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label">城市</label>'
                                                                        +'<div class="layui-input-inline"><input type="text" readonly name="City" id="City" class="layui-input" value="'+(rs.city==null?'':rs.city)+'"></div>'
                                                                    +'</div>'
                                                                +'</div>'
                                                            +'</td><tr>'
                                                            +'</table>'
                                                        +'</div>'
                                                    +'</div>'
                                            }
                                            detailPop+='<div class="layui-form-item">'
                                                +'<div class="layui-inline">'
                                                    +'<label class="layui-form-label modify-layui-label">'+(rs.is_yz_to_bx == 1?'预支':'')+'总金额</label>'
                                                    +'<div class="layui-input-block layui-input-lineHeight">'
                                                    +'<span>'+rs.short_code+' '+(rs.is_yz_to_bx == 1?((Number(rs.yz_real_amount)*100+Number(rs.yz_refund)*100)/100):rs.amount)+''+rs.symbol+'，'+rs.capital_amount+''+rs.zh_name+'</span>'
                                                        
                                                    +'</div>'
                                                +'</div>'
                                                
                                                +'<div class="layui-inline">'
                                                    +'<label class="layui-form-label modify-layui-label">单据总数</label>'
                                                    +'<div class="layui-input-block layui-input-lineHeight">'
                                                        +'<span>'+rs.receipt_count+'</span>'
                                                    +'</div>'
                                                +'</div>'
                                            +'</div>'
                                            if(rs.is_yz_to_bx == 1){
                                                detailPop+='<div class="layui-form-item">'
                                                    +'<div class="layui-inline">'
                                                        +'<label class="layui-form-label modify-layui-label">报销总金额</label>'
                                                        +'<div class="layui-input-block layui-input-lineHeight">'
                                                        +'<span>'+rs.short_code+' '+rs.yz_real_amount+''+rs.symbol+'，'+rs.capital_amount+''+rs.zh_name+'</span>'
                                                      
                                                        +'</div>'
                                                    +'</div>'
                                                    +'<div class="layui-inline">'
                                                        +'<label class="layui-form-label modify-layui-label">退回金额</label>'
                                                        +'<div class="layui-input-block layui-input-lineHeight">'
                                                        +'<span>'+rs.short_code+' '+rs.yz_refund+''+rs.symbol+'，'+rs.zh_name+'</span>'
                                                       
                                                        +'</div>'
                                                    +'</div>'
                                                    +'<div class="layui-inline">'
                                                        +'<label class="layui-form-label modify-layui-label">备注</label>'
                                                        +'<div class="layui-input-block layui-input-lineHeight">'
                                                            +'<span>'+rs.yz_remark+'</span>'
                                                        +'</div>'
                                                    +'</div>'
                                                    +'<div class="layui-inline">'
                                                        +'<button id="toYzDiat" class="layui-btn">查看预支详情</button>'
                                                    +'</div>'
                                                +'</div>'
                                            }
                                            detailPop+='<div class="layui-form-item">'
                                                +'<label class="layui-form-label modify-layui-label">附件</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight UploadNames-box">'
                                                    +attaches
                                                +'</div>'
                                            +'</div>'
                                            if(rs.cancel_remark!=null){
                                                detailPop+='<div class="layui-form-item">'
                                                    +'<label class="layui-form-label modify-layui-label">取消原因</label>'
                                                    +'<div class="layui-input-block layui-input-lineHeight UploadNames-box">'
                                                        +rs.cancel_remark
                                                    +'</div>'
                                                +'</div>'
                                            }

                                            detailPop+='<div class="layui-form-item">'
                                                +'<label class="layui-form-label modify-layui-label">审批记录</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight layui-overflow-lineHeight">'
                                                    +apprList
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-form-item">'
                                                +'<label class="layui-form-label modify-layui-label label-six">出纳审批记录</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight layui-overflow-lineHeight">'
                                                    if(rs.cashier_approval == null){
                                                        detailPop+='暂无'
                                                    }else{
                                                        detailPop+='<p><span>【'+rs.cashier_approval.name +':<em class="">'
                                                        +(rs.cashier_approval.approval_result==0?"待审批":(rs.cashier_approval.approval_result==1?"未通过":(rs.cashier_approval.approval_result==2?"已同意":"")))
                                                        +''+rs.cashier_approval.approval_time+'</em>】</span>'
                                                        +rs.cashier_approval.content+'</p>'
                                                    }
                                                    detailPop+='</div>'
                                            +'</div>'
                                        +'</div>'
                                        +'<div class="layui-form-item" style="margin-left:118px;">'
                                                    +'<div class="layui-input-blocklayui-input-lineHeight">'
                                                        +'<button id="printId" class="no-print layui-btn">打印</button><button id="closeId" class=" layui-btn layui-btn-primary">关闭</button>'
                                                    +'</div>'
                                                +'</div>'
                                    +'</div>'
                                 
                        layer.open({
                            title:''+(rs.is_yz_to_bx==1?'预支转报销':rs.process_name)+'单详情',
                            type: 1, 
                            content:detailPop,
                            area:['80%','80%'],
                            success:function(layero,index){
                                // console.log(data);//id 

                                $("#closeId").on("click",function(){
                                    layer.close(index)
                                })
                                $("#printId").on("click",function(){
                                    var index = layer.load(2, {time: 2000});
                                    $("#printHtml").jqprint({
                                        debug: false,
                                        importCSS: true,
                                        printContainer: true,
                                        operaSupport: false

                                    });  
                                })  
                                $.fetch({
                                    url:"/gateway/formtpl/getformdata",
                                    type: 'post',
                                    data:{
                                        ItemID:data.id,
                                        FormType:2,
                                    },
                                    cb:function(rs){
                                        //console.log(rs);
                                        if(rs&&rs.length>0){
                                            var th ='',td=''; 
                                            for(var i =0;i<rs.length;i++){
                                               th+='<th>'+rs[i].label+'</th>';
                                               td+='<td>'+JSON.parse(rs[i].value)+'</td>'
                                            }
                                            $("#lzmFormData thead tr").html(th);
                                            $("#lzmFormData tbody tr").html(td);
                                        }
                                    }
                                })
                                $("#toYzDiat").on("click",function(){
                                    $.fetch({
                                        url:"/gateway/financial/detail",
                                        type: 'post',
                                        data:{
                                            ID:data.parent_id,
                                            // FormType:2,
                                        },
                                        cb:function(rs){
                                            // console.log(rs);
                                            layer.open({
                                                title:'预支单详情', 
                                                // title:'修改报销付款单',
                                                type: 2, 
                                                content:'detailFinance.html',
                                                area:['80%','80%'],
                                                success:function(layero,index){
                                                    // console.log(data);//id 
                                                    var body = layer.getChildFrame('body', index);
                                                    var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                                                    iframeWin.res=rs;
                                                },
                                             
                                            })
                                        }
                                    })
                                })

                                //复制功能
                                // var clipboard = new Clipboard('.copyInputVal', {
                                //     text: function(trigger) {
                                //     }
                                // });
                           
                                // clipboard.on('success', function(e) {
                                //     layer.msg('复制成功', { time: 500 }, );

                                //     e.clearSelection();
                                // });

                                // clipboard.on('error', function(e) {
                                //     console.error('Action:', e.action);
                                //     console.error('Trigger:', e.trigger);
                                // });
                            }
                       
                        })
                    }
                });
            } else if(layEvent === 'edits'){
                layer.open({
                    title:''+(data.is_yz_to_bx==1?'预支转报销':data.process_type_name)+'单编辑', 
                    // title:'修改报销付款单',
                    type: 2, 
                    content:'editFinance.html',
                    area:['90%','90%'],
                    success:function(layero,index){
                        // console.log(data);//id 
                        var body = layer.getChildFrame('body', index);
                        var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                        iframeWin.listId=obj.data.id;
                    },
                    end:function(){
                        var ApplyResults = $("#myfinanDescSel").val();
                        var ID = $("#ID").val();
                        ReimTable.reload({
                            where:{
                                ID:ID,
                                ApplyResult:ApplyResults,
                                
                            }
                            ,done: function (rs) {
                                // $("#myfinanDescSel").val(this.where.ApplyResult);
                                form.render();
                            }
                        });
                    }
                })
            }  else if(layEvent === 'toBX'){
                layer.open({
                    title:'预支转报销',
                    type: 2, 
                    content:'toBXFinance.html',
                    area:['90%','90%'],
                    success:function(layero,index){
                        // console.log(data);//id 
                        var body = layer.getChildFrame('body', index);
                        var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                        iframeWin.listId=obj.data.id;
                    },
                    end:function(){
                        var ApplyResults = $("#myfinanDescSel").val();
                        var ID = $("#ID").val();
                        ReimTable.reload({
                            where:{
                                ID:ID,
                                ApplyResult:ApplyResults,
                                
                            }
                            ,done: function (rs) {
                                // $("#myfinanDescSel").val(this.where.ApplyResult);
                                form.render();
                            }
                        });
                    }
                })
            }else if(layEvent === 'del'){
                layer.confirm('确定删除?', function (index) {
                    $.fetch({
                        url: "/gateway/financial/delapply",
                        type: 'post',
                        data: {
                            ID: data.id,
                        },
                        cb: function (rs) {
                            layer.msg("删除成功");
                            var ApplyResults = $("#myfinanDescSel").val();
                            var ID = $("#ID").val();
                            ReimTable.reload({
                                where:{
                                    ID:ID,
                                    ApplyResult:ApplyResults,
                                    
                                }
                                ,done: function (rs) {
                                    $("#myfinanDescSel").val(this.where.ApplyResult);
                                    form.render();
                                }
                            });
                        }
                    })
                });
            } else if(layEvent === 'cancel'){
                $.fetch({//新建报销预支单初始化数据
                    url: '/gateway/financial/getapprovaluser',
                    type: 'post',
                    data:{
                        financialTypeId:obj.data.fee_type,
                        step:1,
                        itemId:0,
                        departmentId:window.userInfo.dapartId,
                        applyuserId:window.userInfo.userId,
                    },
                    cb:function(rs){
                        var apprHtml ='';

                        // if(rs.userList.length==0){
                        //     apprHtml+='<option value="">无审核人</option>';
                        //     layer.msg("未设置审批人或审批人与当前提交用户为同一人,无法提交。",{icon:5});
                        //     $("#subFinanForm").attr("disabled","disabled").addClass("layui-disabled");
                        // }else{
                        //     for(var i=0;i<rs.userList.length;i++){
                        //         apprHtml+='<option value="'+rs.userList[i].id+'">'+rs.userList[i].name+'</option>'
                        //     }
                        //     $("#subFinanForm").removeAttr("disabled","disabled").removeClass("layui-disabled");
                        // }
                        var isSpecial=obj.data.is_special;
                        if(isSpecial==0){
                            if (rs.dept_list.length == 0) {
                                apprHtml += '<option value="">无审核人</option>';
                                layer.msg("未设置审批人或审批人与当前提交用户为同一人,无法提交。", {
                                    icon: 5
                                });
                                $("#subFinanForm").attr("disabled", "disabled").addClass("layui-disabled");
                            } else {
                                for (var i = 0; i < rs.dept_list.length; i++) {
                                    apprHtml += '<option value="' + rs.dept_list[i].id + '">' + rs.dept_list[i].name + '</option>'
                                }
                                $("#subFinanForm").removeAttr("disabled", "disabled").removeClass("layui-disabled");
                            }
                        }else if(isSpecial==1){
                            if (rs.userList.length == 0) {
                                apprHtml += '<option value="">无审核人</option>';
                                layer.msg("未设置审批人或审批人与当前提交用户为同一人,无法提交。", {
                                    icon: 5
                                });
                                $("#subFinanForm").attr("disabled", "disabled").addClass("layui-disabled");
                            } else {
                                for (var i = 0; i < rs.userList.length; i++) {
                                    apprHtml += '<option value="' + rs.userList[i].id + '">' + rs.userList[i].name + '</option>'
                                }
                                $("#subFinanForm").removeAttr("disabled", "disabled").removeClass("layui-disabled");
                            }
                        }
                        var htmls ='<div class="layui-card">'
								+'<div class="reviewCont layui-card-body">'
								+    '<div class="layui-form" action="">'
								+        '<div class="layui-form-item">'
								+            '<label class="layui-form-label modify-layui-label">撤回原因：</label>'
								+            '<div class="layui-input-block">'
								+                '<textarea id="Content" name="Content" class="layui-textarea" cols="50" rows="4" ></textarea>'
								+            '</div>'
                                +        '</div>'
                                // if(obj.data.is_group!=1){
                                   
                                //     htmls +=        '<div class="layui-form-item">'
                                //     +            '<label class="layui-form-label modify-layui-label">审批人：</label>'
                                //     +            '<div class="layui-input-block">'
                                //     +                '<div class="layui-input-inline">'
                                //     +                    '<select name="nextDacApp" lay-verify="required" id="nextDacApp">'+apprHtml+'</select>'
                                //     +                '</div>'
                                //     +            '</div>'
                                //     +        '</div>'
                                // } 
                                    
								htmls+=        '<div class="layui-form-item">'
								+            '<div class="layui-input-block">'
								+               ' <button id="appCancel" class=" layui-btn"> 确认</button>'
								+            '</div>'
								+        '</div>'
								+    '</div>'
								+'</div>'
								+'</div>'
                                var layerOpenCanel=function(){
                                    layer.open({
                                        title:'撤回申请',
                                        type: 1, 
                                        content:htmls,
                                        area: ['450px', 'auto'],
                                        success:function(layero,index){
                                            // console.log(data);//id 
                                            form.render();
                                            $("#appCancel").on("click",function(){
                                                var NextApprovalUserID = $("#nextDacApp").val();
                                                var Content = $("#Content").val();
                                                $.fetch({
                                                    url: "/gateway/financial/cancelapply",
                                                    type: 'post',
                                                    data: {
                                                        ApplyID: data.id,
                                                        Content:Content,
                                                        // NextApprovalUserID:NextApprovalUserID,
                                                        // NextApprovalStep: rs.step,
                                                    },
                                                    cb: function (rs) {
                                                        layer.close(index);
                                                        layer.msg("提交成功");
                                                        var ApplyResults = $("#myfinanDescSel").val();
                                                        var ID = $("#ID").val();
                                                        ReimTable.reload({
                                                            where:{
                                                                ID:ID,
                                                                ApplyResult:ApplyResults,
                                                                
                                                            }
                                                            ,done: function (rs) {
                                                                $("#myfinanDescSel").val(this.where.ApplyResult);
                                                                form.render();
                                                            }
                                                        });
                                                    }

                                                })
                                            })
                                        }
                                    })

                                }
                                if(obj.data.is_yz==1){
                                    layer.confirm('如果当前预支单已转报销,则对应的报销单会被删除,确认撤回吗?', {icon: 3, title:'提示'}, function(index){
                                    //do something
                                        layerOpenCanel()
                                        layer.close(index);
                                    }); 

                                }else{
                                    layerOpenCanel()
                                    
                                }
                        } 
                    });
                    
                }else if(layEvent ==="qxsq"){
                    layer.confirm('取消后将不可恢复,确认撤回吗?', {icon: 3, title:'提示'}, function(index){
                    //do something
                        $.fetch({
                            url: "/gateway/financial/quxiaoapply",
                            type: 'post',
                            data: {
                                ItemID: data.id,
                               
                            },
                            cb: function (rs) {
                                layer.close(index);
                                layer.msg("取消成功");
                                var ApplyResults = $("#myfinanDescSel").val();
                                var ID = $("#ID").val();
                                ReimTable.reload({
                                    where:{
                                        ID:ID,
                                        ApplyResult:ApplyResults,
                                        
                                    }
                                    ,done: function (rs) {
                                        $("#myfinanDescSel").val(this.where.ApplyResult);
                                        form.render();
                                    }
                                });
                            }
                        })
                        layer.close(index);
                    }); 
                }
        });
    })
})
</script>
</html>
