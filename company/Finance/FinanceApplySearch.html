<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>财务申请查询</title>
<link rel="stylesheet" type="text/css" href="../../css/iconFont/iconfont.css">
<link rel="stylesheet" type="text/css" href="../../layui/css/layui.css">
<link rel="stylesheet" type="text/css" href="../../layui/css/admin.css">
<script src="../../js/jquery.min.js"></script>
</head>
	
<body layadmin-themealias="default">
    <div class="layui-fluid">
        <div class="layui-card">
                            
                <div class="layui-card-header">财务申请查询</div>
            <!-- <div class="layui-tab layui-tab-brief" lay-filter="component-tabs-brief"> -->
                <!-- <ul class="layui-tab-title">
                    <li class="layui-this">待审批报销付款单</li>
                    <li>已审批报销付款单</li>                
                    <li>我的转发</li>                
                </ul> -->
                <div class="layui-card-body">
                    <div class="layui-form">
                        <div class="layui-form-item layui-show">
                        
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width: 60px;">选择状态</label>
                                <div class="layui-input-inline">
                                        <select class="slct"  name="myfinanDescSel" lay-filter="myfinanDescSel"  id="myfinanDescSel"><option value="-1">全部</option><option value="0">待审批</option><option value="1">未批准</option><option value="2">已批准</option></select>
                                </div>
                            </div>

                            <div class="layui-inline">
                                <label class="layui-form-label" style="width: 60px;">申请时间</label>
                                <div class="layui-input-inline">
                                    <input type="text" class="layui-input" id="sqSTime">
                                </div>
                                <span  class="layui-inline" style="float: left;line-height: 38px;"> ~ </span> 
                                <div class="layui-input-inline">
                                    <input type="text" class="layui-input" id="sqETime">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width: 60px;">ID</label>
                                <div class="layui-input-inline">
                                    <input type="text" class="layui-input" id="ID" name="ID"
                                        placeholder="请输入ID">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width: 60px;">申请人</label>
                                <div class="layui-input-inline">
                                    <input type="text" class="layui-input" id="ApplyUserName" name="ApplyUserName"
                                        placeholder="请输入用户名">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width: 60px;">流程类型</label>
                                <div class="layui-input-inline">
                                    <select class="slct" name="processTypeName" lay-filter="processTypeName"
                                        id="processTypeName"></select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label" style="width: 60px;">类型</label>
                                <div class="layui-input-inline">
                                    <select class="slct" name="finaType" lay-filter="finaType"
                                        id="finaType"></select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                    <label class="layui-form-label" style="width: 60px;">子类型</label>
                                    <div class="layui-input-inline">
                                        <select class="slct" name="FeeType" lay-filter="FeeType"
                                            id="FeeType"></select>
                                    </div>
                                </div>
                            <!-- <div class="layui-inline">
                                <label class="layui-form-label" style="width: 60px;">子类型</label>
                                <div class="layui-input-inline">
                                    <select class="slct" name="feeTypeName" lay-filter="feeTypeName"
                                        id="feeTypeName"></select>
                                </div>
                            </div> -->
                            <div class="layui-inline">
                                <button class="layui-btn layui-btn-sm"  lay-filter="filterTabelSel" id="filterTabelSel" title="查询">
                                    <i class="iconfont icon-sousuo"></i>
                                </button>
                                <!-- <button class="layui-btn layui-btn-sm"  lay-filter="closeLayer"
                                    id="closeLayer">
                                    返回
                                </button> -->
                                <button class="layui-btn layui-btn-sm layui-btn-primary" style="display: none;" lay-filter="returnTabel"
                                    id="returnTabel">
                                    返回
                                </button>
                            </div>

                        </div>
                    </div>
                    <div class="layui-tab-item layui-show layui-form ">
                        <table class="layui-table" lay-filter="finanListTable" id="finanListTable">
           
                        </table>
                    </div>
                  
                </div>
            </div>
        <!-- </div> -->
    </div>
</body>
<style>
pre{
    display:block;
    visibility:hidden;
}
.expandingArea textarea.layui-textarea{
    position:absolute;
    top:0;
    left:0;
    border:none;
    height:100% !important;
}
.expandingArea{
    position:relative;
}
.expandingArea .layui-textarea{
    min-height:auto;
}
</style>
<script src="../../layui/layui.js"></script>
<script src="../../js/jquery.jqprint-0.3.js?v=201902190"></script>
<!-- <script src="../../js/clipboard.min.js"></script> -->
<script src="../../js/common.js?v=20190105"></script>
<script>
    
    layui.config({
        base: '../../../layui/' //静态资源所在路径
    }).extend({
        index: 'index' //主入口模块
    }).use(['index','table','laydate','form','laypage','upload'], function(){
        var $ = layui.$
        ,admin = layui.admin
        ,element = layui.element
        ,upload=layui.upload
        ,router = layui.router();
        element.render();

        var laydate = layui.laydate
        ,form = layui.form
        ,layer = layui.layer
        ,table=layui.table
        ,laypage=layui.laypage;
        laydate.render({ 
            elem: '#sqSTime'
            ,type: 'datetime'
        });
    
        laydate.render({ 
            elem: '#sqETime'
            ,type: 'datetime'
        });
        // var tableNowPage={
        //     ApplyResult:0,
        //     currentIndex:1,
        //     pageSize:10,
        // }
        var urlTab = location.href.split('?tab=')[1]?location.href.split('?tab=')[1]:false;
        var tabId=urlTab?urlTab.split('?')[0]:false;
        var dataId = location.href.split('?id=')[1]?location.href.split('?id=')[1]:false;

        if(dataId){
            var tableSub={
                ApplyResult:'-1',
                ID:dataId
            }
            
        }else{
            var tableSub={
                ApplyResult:'-1'
            }
        }
        // 修正浮动栏高度
        // @param tableElem 表格显示div
        function autoFixed(tableElem) {
            var $tableView = tableElem || $(".layui-table-view");
            var dataIndex ,trHeight;
            $tableView.each(function() {
                // 获取两侧浮动栏
                var $fixed = $(this).find(".layui-table-fixed");
                // 同步表头高度
                $fixed.find(".layui-table-header tr").height($(this).find(".layui-table-header tr").eq(0).height());
                // 遍历tr 修正浮动栏行高
                $(this).find(".layui-table-main tr").each(function() {
                    dataIndex = $(this).attr("data-index");
                    trHeight = $(this).css("height");
                    $fixed.find("tr[data-index=" + dataIndex + "]").css("height", trHeight);
                })
            });
        }
        // 监听浏览器窗口大小变化
        var resizeTimer;
        $(window).resize(function() {
            if (resizeTimer) {
                clearTimeout(resizeTimer);
            }
            resizeTimer = setTimeout(function() {
                resizeTimer = null;
                autoFixed();
            },
            200);
        });

        // 监听表头鼠标按下事件
        $(document).on('mousedown', 'thead',
        function(e) {
            var that = $(this);
            $(document).one('mouseup',
            function() {
                autoFixed(that.parents('.layui-table-view'));
            })
        });

        // 数据表格
        var noticrTable1 = table.render({
            elem: '#finanListTable',
            url:urls+"/gateway/financial/alllist",//
            contentType: 'application/json',
            method: 'post',
            where: tableSub,
            page: true, //开启分页
            limit: 10,
            loading: true,
            text: {
                none: '暂无数据' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
            },
            limits:[10,20,30,40,50,60,70,80,90,100,200,500,1000,5000],
            toolbar:true,
            defaultToolbar: ['filter', 'print', 'exports'],
            cols: [
                [ //标题栏
                    {sort: true,
                        field: 'id',
                        title: 'ID',
                        width: 100
                    },
                    {sort: true,
                        field: 'apply_user_name',
                        title: '申请人',
                        width: 100
                    },
                    {
                        sort:true,
                        field: 'created_at',
                        title: '申请时间',
                        minWidth:160,
                        unresize: true
                    },{
                        sort:true,
                        field: 'process_type_name',
                        unresize: true,
                        minWidth: 100,
                        title: '流程类型'
                    },{sort: true,
                        field: 'yz_to_bx_desc',
                        title: '预支转报销',
                        minWidth: 125,
                        
                    }, {sort: true,
                        field: 'yizhuan_bx_desc',
                        title: '已转报销',
                        minWidth: 130,
                        
                    },{
                        sort:true,
                        field: 'baoxiao_type_name',
                        unresize: true,
                        minWidth: 90,
                        title: '类型'
                    }, {//
                        sort:true,
                        field: 'fee_type_name',
                        unresize: true,
                        minWidth: 90,
                        title: '子类型'
                    },{//
                    sort:true,
                    field: 'finan_dept_name',
                    unresize: true,
                    minWidth: 90,
                    title: '费用部门'
                },{
                        // symbol
                        sort:true,
                        field: 'amount',
                        title: '金额',
                        minWidth: 110,
                        // templet: function (d) {
                        //     var len = d.amount;
                        //     var xx = d.symbol;
                        //     return len + '（'+xx+'）'
                        // }
                    }, {
                        sort:true,
                        field: 'yz_to_bx_total_amount',
                        title: '预支总金额',
                        minWidth: 110,
                    }, {
                        // symbol
                        sort:true,
                        field: 'zh_name',
                        title: '币种',
                        minWidth: 80,
                        // // templet: function (d) {
                        // //     var len = d.amount;
                        //     var xx = d.symbol;
                        //     return len + '（'+xx+'）'
                        // }
                    }
                    // ,{
                    //     sort:true,
                    //     field: 'receipt_count',
                    //     title: '单据数',
                    //     minWidth: 80
                    // }
                    // ,{
                    //     sort:true,
                    //     field: 'is_fixed_costs',
                    //     title: '固定费用',
                    //     minWidth: 100,
                    //     templet: function (d) { 
                    //         return d.is_fixed_costs==1?'是':'否';
                    //     } 
                    //}
                    ,{
                        sort:true,
                        field: 'liezhi_month',
                        unresize: true,
                        title: '列支年月',
                        minWidth: 110
                    },  {
                        sort:true,
                        field: 'current_approval_user_name',
                        title: '当前审批人',
                        minWidth: 140,
                        // templet: function (d) { 
                        //     return d.is_group==1?'集团':d.current_approval_user_name;
                        // } 
                    }, {
                        sort:true,
                        field: 'apply_result_desc',
                        title: '状态',
                        unresize: true,
                        minWidth: 130,
                    },{
                        sort:true,
                        field: 'cancel_desc',
                        title: '取消状态',
                        width: 130,
                        // templet: function (d) {
                        //         console.log(d.is_cancel)
                        //     var resu=(d.is_cancel==1?'申请取消':(d.is_cancel==2?'已取消':' '))+'';
                        //         if(d.is_cancel !=0 &&d.parent_id == 0){
                        //             resu +=' | 原始单'
                        //         }
                        //         return resu
                        // } 
                    }, {
                        fixed: 'right',
                        title: '操作',
                        width: 160,
                        templet:function(d){
                            var apprSh = '<button data-appr="' + d.id + '" class="detail layui-btn layui-btn-warm layui-btn-xs" lay-event="detail" id="detail">详情</button>'
                            if(d.apply_result== 2&&d.parent_id== 0){
                                apprSh += '<button data-appr="' + d.id + '" class="detail layui-btn layui-btn-xs" lay-event="edit" id="edit">设置类型</button>'
                            }
                            return apprSh
                        },
                    }
                ]
            ],
            request: {
                pageName: 'currentIndex' //页码的参数名称，默认：page
                ,limitName: 'pageSize' //每页数据量的参数名，默认：limit
            },
            parseData: function (res) { //res 即为原始返回的数据
                return {
                    "status_code": res.status_code, //解析接口状态
                    "message": res.message, //解析提示文本
                    "count": res.data.total_count, //解析数据长度
                    "data": res.data.data_list, //解析数据列表
                    "curr": res.data.page_index
                };
            },
            done: function () {
                //console.log(dataId);
                if(dataId&&this.where.ID!=''){
                    $('.layui-table-body.layui-table-main button[lay-event="detail"]').click();
                }
                autoFixed($(this.elem[0]).next());
                // $("#myfinanDescSel").val(this.where.ApplyResult);
            }
        })
        form.on('select(myfinanDescSel)', function (data) {
            var ApplyUserName=$("#ApplyUserName").val();
            var st=$('#sqSTime').val();
            var et=$('#sqETime').val();
            // if (data.value == 2) {
            //     noticrTable1.reload({
            //         url: urls + "/gateway/financial/forwardlist",
            //         where: {
            //             ID:'',    
            //             ApplyUserName:ApplyUserName,   
            //             EndTime:et,
            //             StartTime:st,                         
            //             // ApplyResult: data.value,
            //         },
            //         page: {
            //             curr: 1 //重新从第 1 页开始
            //         },
            //         done: function () {
            //             autoFixed($(this.elem[0]).next());
            //             // $("#myfinanDescSel").val(this.where.ApplyResult);
            //         }
            //     });
            // } else {
                // tableNowPage.ApplyResult = data.index;
                var st=$('#sqSTime').val();
                var et=$('#sqETime').val();
                var ID=$("#ID").val();
                                                        
                noticrTable1.reload({
                    url:urls+"/gateway/financial/alllist",
                    where: {
                        ID:ID,
                        ApplyResult: data.value,
                        ApplyUserName:ApplyUserName,  
                        EndTime:et,
                        StartTime:st,                                                          
                    },
                    page: {
                        curr: 1 //重新从第 1 页开始
                    },
                    done: function () {
                        autoFixed($(this.elem[0]).next());
                        // $("#myfinanDescSel").val(this.where.ApplyResult);
                    }
                });
            // }
            });
        
        // 查询
        $.fetch({ //流程类型
            url: '/gateway/financial/newfinancialorder',
            type: 'post',
            cb:function(re){
                var finaStepHtml = '<option value="">请选择流程类型</option>';
                for (var i = 0; i < re.financialTypes.length; i++) {
                    var ischecked = i == 0 ? 'checked' : ''; //第一个默认选中
                    finaStepHtml += '<option data-code="'+re.financialTypes[i].code+'"  value="' + re.financialTypes[i].id + '"  ' + ischecked + '>' + re.financialTypes[i].name + '</option>'
                    // if(re.financialTypes[i].code==='BX'){
                    //     var yzId = -re.financialTypes[i].id;
                    // }
                }
                finaStepHtml += '<option data-code="BX"  value="3">预支</option>'
                
                $("#processTypeName").html(finaStepHtml);
                $("#finaType").html('<option value="">请选择类型</option');
                // $("#feeTypeName").html('<option value="">请选择子类型</option>');
                form.render('select');
            }
        })
       
        form.on('select(processTypeName)', function(data){
            
            if(data.value==3){
                var finaTypeHtml = '<option value="">请选择类型</option>';
                $.fetch({ //流程类型
                    url: '/gateway/financial/newfinancialorder',
                    type: 'post',
                    cb:function(re){
                        var subnodess = re.financialTypes[0].subnodes
                        if (subnodess && subnodess.length > 0) {
                            for (var j = 0; j < subnodess.length; j++) {
                                var ischecked = j == 0 ? 'checked' : ''; //第一个默认选中
                                finaTypeHtml += '<option name="finaType" value="' + subnodess[j].id + '"  ' + ischecked + '>' + subnodess[j].name + '</option>'
                            }
                        }
                        $("#finaType").html(finaTypeHtml)
                        form.render('select');
                        var payTypeHtml = '<option value="">请选先选择类型</option>';
                            $("#FeeType").html(payTypeHtml)
                            form.render('select');
                    }
                })
            }else{
                var finaTypeHtml = '<option value="">请选择类型</option>';
                $.fetch({ //流程类型
                    url: '/gateway/financial/newfinancialorder',///gateway/financialtype/subtypes
                    type: 'post',
                    cb:function(re){
                        for (var i = 0; i < re.financialTypes.length; i++) {
                            if (re.financialTypes[i].id==data.value) {
                                var subnodess = re.financialTypes[i].subnodes;
                                if (subnodess && subnodess.length > 0) {
                                    for (var j = 0; j < subnodess.length; j++) {
                                        var ischecked = j == 0 ? 'checked' : ''; //第一个默认选中
                                        finaTypeHtml += '<option name="finaType" value="' + subnodess[j].id + '"  ' + ischecked + '>' + subnodess[j].name + '</option>'
                                    }
                                }
                            }
                        }
                        $("#finaType").html(finaTypeHtml)
                        form.render('select');
                        // if(!data.value){
                            // console.log(data.value)
                            var payTypeHtml = '<option value="">请选先选择类型</option>';
                            $("#FeeType").html(payTypeHtml)
                            form.render('select');
                        // }
                    }
                })
            }
        
        })

        form.on('select(finaType)', function(data){
            // console.log(!data.value)
             if(data.value){
                $.fetch({  //子类型
                    url: '/gateway/financialtype/subtypes',
                    type: 'post',
                    data:{
                        pid:data.value,
                    },
                    cb:function(rs){
                        var payTypeHtml = '<option value="">请选择子类型</option>';
                        for (var i = 0; i < rs.length; i++) {
                            payTypeHtml += '<option value="'+rs[i].id+'" data-spec="'+rs[i].is_special+'">' + rs[i].name + '</option>'
                        }
                        $("#FeeType").html(payTypeHtml);
                        form.render('select');
                    }
                })
            }else{
                var payTypeHtml = '<option value="">请选择类型</option>';
                $("#FeeType").html(payTypeHtml);
                form.render();
            }
        });
        $("#filterTabelSel").on("click",function(){
            var ApplyUserName=$("#ApplyUserName").val();
            var ApplyResult=$("#myfinanDescSel").val();
            var ProcessType= $('#processTypeName').val();
            var BaoxiaoType = $('#finaType').val();
            var FeeType = $('#FeeType').val();
            var ID = $('#ID').val();
            if(ProcessType=='3'){
                var IsYZ = 1;
                var ProcessType= -1;
            }else{
                var IsYZ = 0;
            }
            
            // if(ApplyResult==2){
            //     var data={
            //             ID:'',
            //             // ApplyResult: ApplyResult,
            //             ApplyUserName:ApplyUserName,                                                            
            //         }
            //         noticrTable1.reload({
            //             url:urls+"/gateway/financial/forwardlist",
            //             where: data,
            //             page: {
            //                 curr: 1 //重新从第 1 页开始
            //             },
            //             done: function () {
            //                 autoFixed($(this.elem[0]).next());
            //                 // $("#myfinanDescSel").val(this.where.ApplyResult);
            //             }
            //         });
            // }else{
                var st=$('#sqSTime').val();
                var et=$('#sqETime').val();
                var data={
                        ID:ID,
                        ApplyResult:ApplyResult,
                        ApplyUserName:ApplyUserName,
                        ProcessType:ProcessType,
                        BaoxiaoType:BaoxiaoType,
                        FeeType:FeeType,
                        IsYZ:IsYZ,
                        EndTime:et,
                        StartTime:st,                                                        
                    }
                noticrTable1.reload({
                    url:urls+"/gateway/financial/alllist",
                    where: data,
                    page: {
                        curr: 1 //重新从第 1 页开始
                    },
                    done: function () {
                        autoFixed($(this.elem[0]).next());
                        // $("#myfinanDescSel").val(this.where.ApplyResult);
                    }
                });
            // }
            $("#returnTabel").show();
        })
        $("#returnTabel").on("click",function(){
            var ApplyResult=$("#myfinanDescSel").val();
            $('#processTypeName').val('');
            $('#finaType').val(' ');
            $('#FeeType').val(' ');
            $('#sqSTime').val('');
            $('#sqETime').val('');
            $('#ID').val('');
            form.render();
            noticrTable1.reload({
                url:urls+"/gateway/financial/alllist",
                where: {
                    ID:'',
                    ApplyResult: ApplyResult,
                    ApplyUserName:'',
                    ProcessType:'-1',
                    BaoxiaoType:'-1',
                    FeeType:'-1',
                    EndTime:'',
                    StartTime:'',                                                     
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                },
                done: function () {
                    autoFixed($(this.elem[0]).next());
                    $("#returnTabel").hide();
                    $("#ApplyUserName").val('');
                    $("#myfinanDescSel").val(ApplyResult);
                }
            });
        });
                
        // 详情和审核
        table.on('tool(finanListTable)', function (obj) {
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
            // //console.log($(this),"-1-1-1")
            var fid =$(".apprAlert").attr("data-appr");
            var step =$(".apprAlert").attr("data-step");
            var uid =$(".apprAlert").attr("data-user");
            var depid =$(".apprAlert").attr("data-depa");
            var tabelData =data;
            var contApprFun = function(){
                $.fetch({
                    url:"/gateway/financial/getapprovaluser",
                    type: 'post',
                    data:{
                        financialTypeId:data.fee_type,                        
                        itemId: fid,
                        step:step,
                        departmentId:depid,
                        applyuserId:uid,
                    },
                    cb:function(rs){
                        var oplist = '',forwar='';
                        if(rs.userList&&rs.userList.length>0){
                            oplist+='<div class="layui-form-item" id="finaApprUser">'
                                        +'<div class="layui-inline">'
                                            +'<label class="layui-form-label modify-layui-label">指定审核人</label>'
                                            +'<div class="layui-input-block layui-input-lineHeight">'
                                                +'<select name="finaApprUser" lay-verify="required">'
                            for(var i=0;i<rs.userList.length;i++){
                                oplist+='<option value="'+rs.userList[i].id+'">'+rs.userList[i].name+'</option>'
                            }
                            oplist+='</select></div></div></div>';
                            
                        }else{
                            oplist='';
                        }

                        if(rs.forwardUsers&&rs.forwardUsers.length>0){
                            forwar+='<div class="layui-form-item" id="finaForwUser">'
                                        +'<div class="layui-inline">'
                                            +'<label class="layui-form-label modify-layui-label">转发给</label>'
                                            +'<div class="layui-input-block layui-input-lineHeight">'
                                                +'<select name="finaForwUser"  lay-verify="required">'
                            for(var i=0;i<rs.forwardUsers.length;i++){
                                forwar+='<option value="'+rs.forwardUsers[i].id+'">'+rs.forwardUsers[i].name+'</option>'
                            }
                            forwar+='</select></div></div><div class="layui-inline"><button id="forwardTo" class="layui-btn">转发</button></div></div>'
                        }else{
                            forwar='';
                        }    
                       // //console.log(rs,data)
                        var contAppr='<div class="layui-fluid">'
                                        +'<div class="layui-card">'
                                            +'<div class="layui-card-body">'
                                                +'<div class="layui-form">'
                                                    +'<div class="layui-form-item">'
                                                        +'<label class="layui-form-label modify-layui-label">审核说明</label>'
                                                        +'<div class="layui-input-block layui-input-lineHeight">'
                                                            +'<textarea id="contentAppr" name="contentAppr" class="layui-textarea"></textarea>'
                                                        +'</div>'
                                                    +'</div>'
                                                    +'<div class="layui-form-item">'
                                                        +'<label class="layui-form-label modify-layui-label">审核结果</label>'
                                                        +'<div class="layui-input-block layui-input-lineHeight" id="result">'
                                                            +'<input type="radio" name="ApprYn" lay-filter="ApprYn" value="2" title="审核通过" checked>'
                                                            +'<input type="radio" name="ApprYn" lay-filter="ApprYn" value="1" title="审核不通过">'
                                                        +'</div>'
                                                    +'</div>'
                                                    +'<div class="layui-form-item">'
                                                        +'<label class="layui-form-label modify-layui-label">附件</label>'
                                                        +'<div class="layui-input-block">'
                                                            +'<button type="button" class="layui-btn layui-btn-primary" id="finaAttach" style="float:left;">'
                                                                +'<i class="layui-icon">&#xe67c;</i>上传附件'
                                                            +'</button>'
                                                            // +'<div class="layui-form-mid layui-word-aux" style="margin-left: 15px">（注：再次点击，可多次上传）</div>'
                                                            +'<div id="finaFiles" class="UploadNames-box UploadFl layui-input-lineHeight"></div>'
                                                        +'</div>'
                                                    +'</div>'
                                                    +oplist
                                                    if(data.is_special==0){
                                                        if(data.next_step==7){
                                                            contAppr+=''
                                                        }else{
                                                            contAppr+=forwar
                                                        }

                                                    }else{
                                                        contAppr+=forwar
                                                    }
                                                    contAppr+='<div class="layui-form-item">'
                                                        +'<div class="layui-input-block">'
                                                            +'<button id="subFinanApprForm" data-stpe="'+rs.step+'" lay-submit class="layui-btn" lay-filter="subFinanApprForm">提交</button>'
                                                            +'<button id="backApprList" class="layui-btn layui-btn-primary">返回</button>'
                                                        +'</div>'
                                                    +'</div>'
                                                +'</div>'
                                            +'</div>'
                                        +'</div>'
                                    +'</div>'
                        
                        layer.open({
                                title:''+(data.is_yz_to_bx==1?'预支转报销':data.process_type_name)+'单审批', 
                                type: 1, 
                                content:contAppr,
                                area:['60%','61%'],
                                success:function(layero,index){
                                    form.render(); 
                                    form.on('radio(ApprYn)', function(data){
                                        if(data.value==1){
                                            $("#finaApprUser").hide();
                                            $("#finaForwUser").hide();
                                        }else if(data.value==2){
                                            $("#finaApprUser").show();
                                            $("#finaForwUser").show();
                                        }
                                    });
                                    
                                    var financialObj = { //保存财务相关数据的对象
                                        finaFiles: [], //附件id数组
                                    }
                                    var uploadInst = upload.render({ //上传附件
                                        elem: '#finaAttach' //绑定元素
                                            ,
                                        url: window.urls + "/gateway/financial/approvaladdattach" //上传接口
                                            ,
                                        accept: 'file',
                                        data:{
                                            OrderID:data.id
                                        },
                                        before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                                            layer.load(); //上传loading
                                        },
                                        done: function (res) {
                                            //上传完毕回调
                                            layer.closeAll('loading'); //关闭loading
                                            $("#finaFiles").append('<a><span class="currentName">' + res.data.attachName + '</span><i data-file="' + res.data.attachId + '" class="del iconfont icon-guanbi"></i></a>')
                                            financialObj.finaFiles.push(res.data.attachId);
                                        },
                                        error: function () {
                                            layer.closeAll('loading'); //关闭loading
                                            //请求异常回调
                                        }
                                    });
                                    $("#finaFiles").on("click", 'i.del', function () { //删除附件
                                        var delId = $(this).attr("data-file");
                                        var elem = $(this).parent("a");
                                        //layer.load();
                                        $.fetch({
                                            url: '/gateway/financial/delattach',
                                            type: 'post',
                                            data: {
                                                AttachId: delId
                                            },
                                            cb: function (rs) {
                                                financialObj.finaFiles.splice($.inArray(delId, financialObj.finaFiles), 1);
                                                elem.remove();
                                            }
                                        });
                                    })
                                    
                                    //附件回显
                                    // var fid = $("#detail").attr("data-appr");
                                    $.fetch({
                                        url:"/gateway/financial/detail",
                                        type: 'post',
                                        data:{
                                        ID:tabelData.id,
                                        },
                                        cb:function(rs){
                                            var attaches='';
                                            // if(rs.is_fixed_costs==1){
                                            //     var attachesUrl='/gateway/financial/downloadfixedcost/'
                                            // }else{
                                            //     var attachesUrl='/gateway/financial/download/'
                                            // }
                                            var attachesUrl='/gateway/financial/download/'
                                            if(rs.attaches&&rs.attaches.length>0){
                                                for(var j=0;j<rs.attaches.length;j++){
                                                    attaches+='<a  title="点击下载" target="_blank" href="'+attachesUrl+''+rs.attaches[j].id+'">'+rs.attaches[j].original_name+'</a>'
                                                }
                                            }
                                            $("#finaFiles").append(attaches)
                                        }
                                    })
                                
                                    
                                    form.on('submit(subFinanApprForm)', function(data){
                                        var stpeId =$("#subFinanApprForm").attr("data-stpe");
                                        if(data.field.finaApprUser==undefined){
                                            var nextApprovalUserID=0;
                                        }else{
                                            var nextApprovalUserID=data.field.finaApprUser;
                                        }
                                        
                                        var vllue = $("#result input[name='ApprYn']:checked").val();
                                        
                                        if(vllue=='1'){
                                            if(data.field.contentAppr==''){
                                                layer.msg('审批意见不能为空！');
                                                return false
                                            }else{
                                                var pram={
                                                    ItemID:tabelData.id,
                                                    NextApprovalUserID:nextApprovalUserID,
                                                    Content:data.field.contentAppr,
                                                    IsAgree:data.field.ApprYn,
                                                    NextApprovalStep:stpeId,
                                                }
                                                $.fetch({
                                                    url: '/gateway/financial/approval',
                                                    type: 'post',
                                                    data:pram,
                                                    cb:function(rs){
                                                        layer.msg('提交成功');
                                                        var ApplyResults=$("#myfinanDescSel").val();
                                                        // financialList(tableNowPage,0);
                                                        var st=$('#sqSTime').val();
                                                        var et=$('#sqETime').val();
                                                        var ApplyUserName=$("#ApplyUserName").val();
                                                        var ID=$("#ID").val();
                                                        var ProcessType= $('#processTypeName').val();
                                                        var BaoxiaoType = $('#finaType').val();
                                                        var FeeType = $('#FeeType').val();
           
                                                        noticrTable1.reload({
                                                            where: {
                                                                ID:ID,
                                                                ApplyResult:ApplyResults,
                                                                ApplyUserName:ApplyUserName,
                                                                ProcessType:ProcessType,
                                                                BaoxiaoType:BaoxiaoType,
                                                                FeeType:FeeType,
                                                                EndTime:et,
                                                                StartTime:st,
                                                            },
                                                            page: {
                                                                curr: 1 //重新从第 1 页开始
                                                            },
                                                            done: function () {
                                                                autoFixed($(this.elem[0]).next());
                                                                $("#myfinanDescSel").val(this.where.ApplyResult);
                                                            }
                                                        });
                                                        layer.closeAll();
                                                    } 
                                                });
                                            }
                                        }else if(vllue=='2'){
                                            layer.confirm('是否提交?',{title:' '},function(index_1){
                                                var pram={
                                                    ItemID:tabelData.id,
                                                    NextApprovalUserID:nextApprovalUserID,
                                                    Content:data.field.contentAppr,
                                                    IsAgree:data.field.ApprYn,
                                                    NextApprovalStep:stpeId,
                                                }
                                                $.fetch({
                                                    url: '/gateway/financial/approval',
                                                    type: 'post',
                                                    data:pram,
                                                    cb:function(rs){
                                                        layer.msg('提交成功');
                                                        var st=$('#sqSTime').val();
                                                        var et=$('#sqETime').val();
                                                        // financialList(tableNowPage,0);
                                                        var ApplyResults=$("#myfinanDescSel").val();
                                                        var ApplyUserName=$("#ApplyUserName").val();
                                                        var ID=$("#ID").val();
                                                        var ProcessType= $('#processTypeName').val();
                                                        var BaoxiaoType = $('#finaType').val();
                                                        var FeeType = $('#FeeType').val();
           
                                                        noticrTable1.reload({
                                                            where: {
                                                                ID:ID,
                                                                ApplyResult:ApplyResults,
                                                                ApplyUserName:ApplyUserName,
                                                                ProcessType:ProcessType,
                                                                BaoxiaoType:BaoxiaoType,
                                                                FeeType:FeeType,
                                                                EndTime:et,
                                                                StartTime:st,
                                                            },
                                                            page: {
                                                                curr: 1 //重新从第 1 页开始
                                                            },
                                                            done: function () {
                                                                autoFixed($(this.elem[0]).next());
                                                                $("#myfinanDescSel").val(this.where.ApplyResult);
                                                            }
                                                        });
                                                        layer.closeAll();
                                                    } 
                                                });
                                            })
                                        }  
                                        return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                                    });
                                
                                    $("#forwardTo").on("click",function(){
                                        var fowid= $("#finaForwUser select").val();
                                        var ctext =$("#contentAppr").val();
                                        var vllue = $("#result input[name='ApprYn']:checked").val();
                                        if(vllue=='1'){
                                            if(ctext==''){
                                                layer.msg('审批意见不能为空！');
                                                return false
                                            }
                                        }else if(vllue=='2'){
                                            layer.confirm('是否提交?',{title:' '},function(index_1){
                                                $.fetch({
                                                    url: '/gateway/financial/forward',
                                                    type: 'post',
                                                    data:{
                                                        ForwardUserID:fowid,
                                                        Content:ctext,
                                                        ItemID:fid,
                                                    },
                                                    cb:function(rs){
                                                        layer.msg('转发成功');
                                                        var ApplyResults=$("#myfinanDescSel").val();
                                                        // financialList(tableNowPage,0);
                                                        var st=$('#sqSTime').val();
                                                        var et=$('#sqETime').val();
                                                        var ApplyUserName=$("#ApplyUserName").val();
                                                        var ID=$("#ID").val();
                                                        var ProcessType= $('#processTypeName').val();
                                                        var BaoxiaoType = $('#finaType').val();
                                                        var FeeType = $('#FeeType').val();
           
                                                        noticrTable1.reload({
                                                            where: {
                                                                ID:ID,
                                                                ApplyResult:ApplyResults,
                                                                ApplyUserName:ApplyUserName,
                                                                ProcessType:ProcessType,
                                                                BaoxiaoType:BaoxiaoType,
                                                                FeeType:FeeType,
                                                                EndTime:et,
                                                                StartTime:st,
                                                            },
                                                            page: {
                                                                curr: 1 //重新从第 1 页开始
                                                            },
                                                            done: function () {
                                                                autoFixed($(this.elem[0]).next());
                                                                $("#myfinanDescSel").val(this.where.ApplyResult);
                                                            }
                                                        });
                                                            // financialList(tableNowPage,0);
                                                            layer.close(index);
                                                    } 
                                                });
                                            })
                                        }
                                        // var ctext =$("#contentAppr").val();
                                        // if(ctext==''){
                                        //     $("#contentAppr").focus().addClass('layui-form-danger');
                                        //     layer.msg('审核说明不能为空',{icon:5,anim: 6},function(){

                                        //     })
                                        //     return false
                                        // }
                                        
                                    });
                                    $("#backApprList").on("click",function(){
                                        layer.close(index);
                                    })
                                }
                            })
                    }
                });
            }
            if(layEvent == 'appr'){
                contApprFun()
            }else if(layEvent == 'edit'){
                var cont='<div class="layui-card-body">'
                            +'<div class="layui-form">'
                            +'<div class="layui-form-item">'
                            +'    <div class="layui-inline">'
                            +'        <label class="layui-form-label">流程类型</label>'
                            +'        <div class="layui-inline" style="padding: 7px 0px;">'
                            +'           '+data.process_name+''
                            +'        </div>'
                            +'    </div>'
                            +'</div>'
                            +'<div class="layui-form-item">'
                            +'    <div class="layui-inline">'
                            +'        <label class="layui-form-label">类型</label>'
                            +'        <div class="layui-inline">'
                            +'            <select id="finaTypes"  lay-filter="finaTypes" name="finaTypes" class="layui-input-inline"></select>'
                            // +data.baoxiao_type_name
                            +'        </div>'
                            +'    </div>'
                            +'</div>'
                            +'<div class="layui-form-item">'
                            +'    <div class="layui-inline">'
                            +'        <label class="layui-form-label">子类型</label>'
                            +'        <div class="layui-inline">'
                            +'            <select lay-verify="required" id="payType" name="payType" lay-filter="payType"  class="layui-input-inline"></select>' 
                            +'        </div>'
                            +'    </div>'
                            +'</div>'
                            +'<div class="layui-form-item ">'
                            +'    <div class="layui-block">'
                                
                                    +'<button id="subBjType"  lay-submit lay-filter="subBjType"   class="layui-btn">确定</button>'
                                    +'<button id="backTypeList" class="layui-btn layui-btn-primary">返回</button>'
                                +'</div>'
                            +'</div>'
                    +'    </div>'
                    +'</div>'
                layer.open({
                    title: '修改财务类型',
                    type: 1, 
                    content:cont,
                    area:['50%','50%'],
                    success:function(layero,index){
                        // process_type
                        $.fetch({
                            url:"/gateway/financialtype/subtypes",
                            type: 'post',
                            data:{
                                pid:data.process_type,
                            },
                            cb:function(rs){
                                if(rs&&rs.length>0){
                                    var ophtml="";
                                    for(var i=0;i<rs.length;i++){
                                        ophtml+='<option value="'+rs[i].id+'">'+rs[i].name+'</option>'
                                    }
                                }
                                $("#finaTypes").html(ophtml);
                                if(data.baoxiao_type){
                                    $("#finaTypes").val(data.baoxiao_type);
                                    setTimeout(
                                        function(){
                                            $.fetch({
                                                url:"/gateway/financialtype/subtypes",
                                                type: 'post',
                                                data:{
                                                    pid:data.baoxiao_type,
                                                },
                                                cb:function(rs){
                                                    // console.log(rs)
                                                    if(rs&&rs.length>0){
                                                        var ophtml="";
                                                        for(var i=0;i<rs.length;i++){
                                                            ophtml+='<option value="'+rs[i].id+'">'+rs[i].name+'</option>'
                                                        }
                                                    }
                                                    $("#payType").html(ophtml);
                                                    if(data.fee_type){ $("#payType").val(data.fee_type);}
                                                    form.render();
                                                }
                                            })
                                        }
                                    )

                                }
                                form.render();
                                form.on('select(finaTypes)', function(datasel){
                                    $.fetch({
                                        url:"/gateway/financialtype/subtypes",
                                        type: 'post',
                                        data:{
                                            pid:datasel.value,
                                        },
                                        cb:function(rs){
                                            // console.log(rs)
                                            if(rs&&rs.length>0){
                                                var ophtml="";
                                                for(var i=0;i<rs.length;i++){
                                                    ophtml+='<option value="'+rs[i].id+'">'+rs[i].name+'</option>'
                                                }
                                            }
                                            $("#payType").html(ophtml);
                                            // $("#payType").val(data.fee_type);
                                            form.render();
                                        }
                                    })
                                });   
                            }
                        })
                        $("#subBjType").on("click",function(){
                            var payTypeId=$("#payType").val();
                            $.fetch({
                                url:"/gateway/financial/linktype",
                                type: 'post',
                                data:{
                                    OrderID:data.id,
                                    FinanTypeID:payTypeId
                                },
                                cb:function(rs){
                                    // console.log(rs)
                                    layer.msg("保存成功");
                                    layer.close(index);
                                    var ApplyResults=$("#myfinanDescSel").val();
                                    // financialList(tableNowPage,0);
                                    var st=$('#sqSTime').val();
                                    var et=$('#sqETime').val();
                                    var ApplyUserName=$("#ApplyUserName").val();
                                    var ID=$("#ID").val();
                                    var ProcessType= $('#processTypeName').val();
                                    var BaoxiaoType = $('#finaType').val();
                                    var FeeType = $('#FeeType').val();
                                    noticrTable1.reload({
                                        where: {
                                            ID:ID,
                                            ApplyResult:ApplyResults,
                                            ApplyUserName:ApplyUserName,
                                            ProcessType:ProcessType,
                                            BaoxiaoType:BaoxiaoType,
                                            FeeType:FeeType,
                                            EndTime:et,
                                            StartTime:st,
                                        },
                                        page: {
                                            curr: 1 //重新从第 1 页开始
                                        },
                                        done: function () {
                                            autoFixed($(this.elem[0]).next());
                                            $("#myfinanDescSel").val(this.where.ApplyResult);
                                        }
                                    });

                                }
                            })
                        })
                        $("#backTypeList").on("click",function(){
                            layer.close(index);
                        })
                    }
                })
            }else if(layEvent == 'detail'){
                 var fid =$(this).attr("data-appr");
                $.fetch({
                    url:"/gateway/financial/detail",
                    type: 'post',
                    data:{
                        ID:fid,
                    },
                    cb:function(rs){
                        // if(rs.is_fixed_costs==1){
                        //     var attachesUrl='/gateway/financial/downloadfixedcost/'
                        // }else{
                        //     var attachesUrl='/gateway/financial/download/'
                        // }
                        var attachesUrl='/gateway/financial/download/'
                        var details ='',attaches='',apprList='';
                        
                        for(var i=0;i<rs.details.length;i++){
                            details+='<tr><td>'+rs.details[i].fee_type_name+'</td><td class="expandingArea "><pre style="display:block;visibility:hidden;"><span>'+rs.details[i].remark+'</span><br></pre><textarea readonly  class="layui-textarea Remark">'+rs.details[i].remark+'</textarea></td><td>'+rs.details[i].receipt_count+'</td><td>'+rs.details[i].amount+'</td></tr>'
                        }
                        if(rs.attaches&&rs.attaches.length>0){
                            for(var j=0;j<rs.attaches.length;j++){
                                attaches+='<a  title="点击下载" target="_blank" href="'+attachesUrl+''+rs.attaches[j].id+'">'+rs.attaches[j].original_name+'</a>'
                            }
                        }else{
                            attaches='无附件'
                        }
                        var approval =rs.approval_history;
                        if(approval.length==0){
                            apprList ='暂无';
                        }else{
                            for(var k=0;k< approval.length;k++){
                                var res='';
                                var classList = '';
                                var approvalCont = approval[k].content==null?' ':approval[k].content
                                if(approval[k].is_forward ==1){//是转发的
                                    res ='--转发-->';
                                apprList+='<p>【'+approval[k].username+''+res+ ''//名字
                                                //意见
                                            +'<em class="green"> '+approval[k].forward_username+' '+approval[k].approval_time+'</em>】：'//时间
                                                +approvalCont+'</p>'//意见内容
        
                                }else{//是审批的
                                    if(approval[k].approval_result==1){
                                        res ="未批准";
                                        classList = "red";
                                    }else if(approval[k].approval_result==2){
                                        res ="已批准";
                                        classList = 'green';
                                    }
                                apprList+='<p><span> 【'+approval[k].username +'<em class='+classList+'>'+res+' '+approval[k].approval_time+'</em>'+'】</span>'+approvalCont+'</p>'
                                }
                            };
                        }
                        
                        var oplist = '',forwar='';
                        if(rs.userList&&rs.userList.length>0){
                            oplist+='<div class="layui-form-item" id="finaApprUser">'
                                        +'<div class="layui-inline">'
                                            +'<label class="layui-form-label modify-layui-label">指定审核人</label>'
                                            +'<div class="layui-input-block layui-input-lineHeight">'
                                                +'<select name="finaApprUser" lay-verify="required">'
                            for(var i=0;i<rs.userList.length;i++){
                                oplist+='<option value="'+rs.userList[i].id+'">'+rs.userList[i].name+'</option>'
                            }
                            oplist+='</select></div></div></div>';
                            
                        }else{
                            oplist='';
                        }

                        if(rs.forwardUsers&&rs.forwardUsers.length>0){
                            forwar+='<div class="layui-form-item" id="finaForwUser">'
                                        +'<div class="layui-inline">'
                                            +'<label class="layui-form-label modify-layui-label">转发给</label>'
                                            +'<div class="layui-input-block layui-input-lineHeight">'
                                                +'<select name="finaForwUser"  lay-verify="required">'
                            for(var i=0;i<rs.forwardUsers.length;i++){
                                forwar+='<option value="'+rs.forwardUsers[i].id+'">'+rs.forwardUsers[i].name+'</option>'
                            }
                            forwar+='</select></div></div><div class="layui-inline"><button id="forwardTo" class="layui-btn">转发</button></div></div>'
                        }else{
                            forwar='';
                        }  

                        // 审批按钮、
                        var Span = '';
                        // //console.log(data.approval_result,"1-1-1-",data)
                        var isNull = function(o){return (o==null||o=='')?'暂无':o}  
                        Span='<div class="layui-form-item">'
                             + '<div class="">'
                                 +'<button id="closeId" class=" layui-btn layui-btn-primary">关闭</button>'
                                 + '</div>'
                             + '</div>'
                        
                            var detailPop='<div class="layui-fluid">'
                                    +'<div class="layui-form" id="printHtml">'
                                        // +'<div class="layui-form-mid layui-word-aux">IP：'+rs.createor_ip+'</div>'
                                        // +'<div class="fr layui-word-aux" style="padding: 9px 0!important;">申请时间：'+rs.created_at+'</div>'
                                        +'<div class="layui-form-item">'
                                        +'<div class="layui-inline layui-word-aux">'
                                            +'<label class="layui-form-label modify-layui-label ">申请时间</label>'
                                            +'<div class="layui-input-block layui-input-lineHeight">'
                                                +'<span>'+rs.created_at+'</span>'
                                            +'</div>'
                                        +'</div>'
                                        // if(rs.is_fixed_costs==1){
                                        //     detailPop+='<div class="layui-inline layui-word-aux">'
                                        //         +'<label class="layui-form-label modify-layui-label ">开始日期</label>'
                                        //         +'<div class="layui-input-block layui-input-lineHeight">'
                                        //             +'<span>'+rs.fixed_cost_start_month+'</span>'
                                        //         +'</div>'
                                        //     +'</div>'
                                        //     +'<div class="layui-inline layui-word-aux">'
                                        //         +'<label class="layui-form-label modify-layui-label ">结束日期</label>'
                                        //         +'<div class="layui-input-block layui-input-lineHeight">'
                                        //             +'<span>'+rs.fixed_cost_end_month+'</span>'
                                        //         +'</div>'
                                        //     +'</div>'
                                        //     +'<div class="layui-inline layui-word-aux">'
                                        //         +'<label class="layui-form-label modify-layui-label">生效时间</label>'
                                        //         +'<div class="layui-input-block layui-input-lineHeight">'
                                        //             +'<span>'+rs.fixed_cost_job_date+'</span>'
                                        //         +'</div>'
                                        //     +'</div>'
                                        // }
                                        detailPop+='</div>'
                                        +'<div class="layui-form-item">'
                                            +'<div class="layui-inline">'
                                                +'<label class="layui-form-label modify-layui-label">姓名</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight">'
                                                    +'<span>'+rs.creator+'</span>'
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-inline">'
                                                +'<label class="layui-form-label modify-layui-label">部门</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight">'
                                                    +'<span>'+rs.dept_name+'</span>'
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-inline">'
                                                +'<label class="layui-form-label modify-layui-label">列支年月</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight">'
                                                    +'<span>'+rs.liezhi_month+'</span>'
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-inline fr">'
                                                +'<button id="printId" class="no-print layui-btn">打印</button>'
                                            +'</div>'
                                            
                                        +'</div>'
                                        // +'<div class="layui-form-item">'
                                        //     +'<label class="layui-form-label modify-layui-label">列支科目</label>'
                                        //     +'<div class="layui-input-block layui-input-lineHeight">'
                                        //         +'<span>'+rs.liezhi_kemu+'</span>'
                                        //     +'</div>'
                                        // +'</div>'
                                        +'<div class="layui-form-item">'
                                            +'<div class="layui-inline">'
                                                +'<label class="layui-form-label modify-layui-label">流程类型</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight">'
                                                +'<span>'+rs.process_type_name+'</span>'
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-inline">'
                                                +'<label class="layui-form-label modify-layui-label">类型</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight">'
                                                    +'<span>'+rs.baoxiao_type_name+'</span>'
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-inline">'
                                                +'<label class="layui-form-label modify-layui-label">费用部门</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight">'
                                                    +'<span>'+(rs.finan_dept_name==null?'暂无':''+rs.finan_dept_name+'')+'</span>'
                                                +'</div>'
                                            +'</div>'
                                        +'</div>'
                                        +'<div class="layui-form-item">'
                                        +'<label class="layui-form-label modify-layui-label">支付明细</label>'
                                            +'<div class="layui-input-block">'
                                                +'<table class="layui-table" id="lzmFormData">'
                                                    +'<thead><tr></tr></thead>'
                                                    +'<tbody><tr><td>暂无</td></tr></tbody>'
                                                +'</table>'
                                            +'</div>'
                                        +'</div>'
                                        +'<div class="layui-form-item">'
                                            +'<label class="layui-form-label">费用明细</label>'
                                            +'<div class="layui-input-block">'
                                                +'<table class="layui-table">'
                                                    +'<colgroup><col width="150"><col><col width="150"><col width="150"><col width="130"></colgroup>'
                                                    +'<thead><tr><th>费用类型</th><th>费用摘要</th><th>单据数量</th><th>金额 '+rs.zh_name+'('+rs.short_code+')</th></tr></thead>'
                                                    +'<tbody>'+details+'</tbody>'
                                                +'</table>'
                                            +'</div>'
                                        +'</div>'
                                        
                                        if(rs.financial_type_code=='FK'){
                                             detailPop+='<div class="layui-form-item">'
                                                        +'<label class="layui-form-label">付款信息</label>'
                                                        +'<div class="layui-input-block">'
                                                            +'<table class="layui-table">'
                                                                +'<tr><td>'
                                                                +'<div class="layui-form-item">'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label"><span class="red"> ＊</span>银行</label>'
                                                                        +'<div class="layui-input-inline"><input  type="text" readonly class="layui-input" name="BankName" id="BankName"   value="'+(rs.bank_name==null?'':rs.bank_name)+'"></div>'
                                                                    +'</div>'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label">开户支行</label>'
                                                                        +'<div class="layui-input-inline"> <input type="text" readonly  name="Branch" id="Branch" class="layui-input" value="'+(rs.branch==null?'':rs.branch)+'"></div>'
                                                                    +'</div>'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label"><span class="red"> ＊</span> 银行账号</label>'
                                                                        +'<div class="layui-input-inline"><input type="text" readonly  name="BankAccount" id="BankAccount"  class="layui-input" value="'+(rs.bank_account==null?'':rs.bank_account)+'"></div>'
                                                                    +'</div>'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label"><span class="red"> ＊</span> 开户人</label>'
                                                                        +'<div class="layui-input-inline"><input type="text" readonly  name="AccountName" id="AccountName"  class="layui-input" value="'+(rs.account_name==null?'':rs.account_name)+'"></div>'
                                                                    +'</div>'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label">省份</label>'
                                                                        +'<div class="layui-input-inline"><input type="text" readonly name="Province" id="Province" class="layui-input" value="'+(rs.province==null?'':rs.province)+'"></div>'
                                                                    +'</div>'
                                                                    +'<div class="layui-inline">'
                                                                        +'<label class="layui-form-label">城市</label>'
                                                                        +'<div class="layui-input-inline"><input type="text" readonly name="City" id="City" class="layui-input" value="'+(rs.city==null?'':rs.city)+'"></div>'
                                                                    +'</div>'
                                                                +'</div>'
                                                            +'</td><tr>'
                                                            +'</table>'
                                                        +'</div>'
                                                    +'</div>'
                                            }
                                            detailPop+='<div class="layui-form-item">'
                                           +'<div class="layui-inline">'
                                                +'<label class="layui-form-label modify-layui-label">'+(rs.is_yz_to_bx == 1?'预支':'')+'总金额</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight">'
                                                +'<span>'+rs.short_code+' '+(rs.is_yz_to_bx == 1?(toNonExponential((Number(rs.yz_real_amount)*100+Number(rs.yz_refund)*100)/100)):toNonExponential(rs.amount))+''+rs.symbol+'，'+rs.capital_amount+''+rs.zh_name+'</span>'
                                                    
                                                +'</div>'
                                            +'</div>'
                                                
                                            +'<div class="layui-inline">'
                                                +'<label class="layui-form-label modify-layui-label">单据总数</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight">'
                                                    +'<span>'+rs.receipt_count+'</span>'
                                                +'</div>'
                                            +'</div>'
                                        +'</div>'
                                        if(rs.is_yz_to_bx == 1){
                                                detailPop+='<div class="layui-form-item">'
                                                    +'<div class="layui-inline">'
                                                        +'<label class="layui-form-label modify-layui-label">实际费用</label>'
                                                        +'<div class="layui-input-block layui-input-lineHeight">'
                                                        +'<span>'+rs.short_code+' '+rs.yz_real_amount+''+rs.symbol+'，'+rs.capital_amount+''+rs.zh_name+'</span>'
                                                      
                                                        +'</div>'
                                                    +'</div>'
                                                    +'<div class="layui-inline">'
                                                        +'<label class="layui-form-label modify-layui-label">退回金额</label>'
                                                        +'<div class="layui-input-block layui-input-lineHeight">'
                                                        +'<span>'+rs.short_code+' '+rs.yz_refund+''+rs.symbol+'，'+rs.zh_name+'</span>'
                                                       
                                                        +'</div>'
                                                    +'</div>'
                                                    +'<div class="layui-inline">'
                                                        +'<label class="layui-form-label modify-layui-label">备注</label>'
                                                        +'<div class="layui-input-block layui-input-lineHeight">'
                                                            +'<span>'+rs.yz_remark+'</span>'
                                                        +'</div>'
                                                    +'</div>'
                                                    +'<div class="layui-inline">'
                                                        +'<button id="toYzDiat" class="layui-btn">查看预支详情</button>'
                                                    +'</div>'
                                                +'</div>'
                                            }
                                        detailPop+='<div class="layui-form-item">'
                                            +'<label class="layui-form-label modify-layui-label">附件</label>'
                                            +'<div class="layui-input-block layui-input-lineHeight UploadNames-box">'
                                                +attaches
                                            +'</div>'
                                        +'</div>'
                                        if(rs.cancel_remark!=null){
                                            detailPop+='<div class="layui-form-item">'
                                                +'<label class="layui-form-label modify-layui-label">取消原因</label>'
                                                +'<div class="layui-input-block layui-input-lineHeight UploadNames-box">'
                                                    +rs.cancel_remark
                                                +'</div>'
                                            +'</div>'
                                        }

                                        detailPop+='<div class="layui-form-item">'
                                            +'<label class="layui-form-label modify-layui-label layui-overflow-lineHeight">审批历史</label>'
                                            +'<div class="layui-input-block layui-input-lineHeight UploadNames-box layui-overflow-lineHeight">'
                                                +apprList
                                            +'</div>'
                                        +'</div>'
                                        +'<div class="layui-form-item">'
                                            +'<label class="layui-form-label modify-layui-label label-six">出纳审批记录</label>'
                                            +'<div class="layui-input-block layui-input-lineHeight layui-overflow-lineHeight">'
                                                if(rs.cashier_approval == null){
                                                    detailPop+='暂无'
                                                }else{
                                                    detailPop+='<p><span>【'+rs.cashier_approval.name +':<em class="">'
                                                    +(rs.cashier_approval.approval_result==0?"待审批":(rs.cashier_approval.approval_result==1?"未通过":(rs.cashier_approval.approval_result==2?"已同意":"")))
                                                    +''+rs.cashier_approval.approval_time+'</em>】</span>'
                                                    +rs.cashier_approval.content+'</p>'
                                                }
                                                detailPop+='</div>'
                                        +'</div>'
                                        // +htmlsAppr
                                    +'</div>'
                                    // +htmlApproval
                                    +Span
                                    // +'<div class="layui-form-item" style="margin-left:118px;">'
                                    //     +'<div class="layui-input-blocklayui-input-lineHeight">'
                                    //         +'<button id="closeId" class=" layui-btn layui-btn-primary">关闭</button>'
                                    //     +'</div>'
                                    // +'</div>'
                            +'</div>'
                            layer.open({
                            title: ''+(rs.is_yz_to_bx==1?'预支转报销':rs.process_type_name)+'单详情',
                            type: 1, 
                            content:detailPop,
                            area:['90%','85%'],
                            success:function(layero,index){
                                form.render();
                                //复制功能
                                // var clipboard = new Clipboard('.copyInputVal', {
                                //     text: function(trigger) {
                                //     }
                                // });
                           
                                // clipboard.on('success', function(e) {
                                //     layer.msg('复制成功', { time: 500 }, );

                                //     e.clearSelection();
                                // });

                                // clipboard.on('error', function(e) {
                                //     console.error('Action:', e.action);
                                //     console.error('Trigger:', e.trigger);
                                // });
                                // 详情审批
                                form.on('radio(ApprYn)', function(data){
                                    if(data.value==1){
                                        $("#finaApprUser").hide();
                                        $("#finaForwUser").hide();
                                    }else if(data.value==2){
                                        $("#finaApprUser").show();
                                        $("#finaForwUser").show();
                                    }
                                });
                                
                                var financialObj = { //保存财务相关数据的对象
                                    finaFiles: [], //附件id数组
                                }
                                var uploadInst = upload.render({ //上传附件
                                    elem: '#finaAttach' //绑定元素
                                        ,
                                    url: window.urls + "/gateway/financial/approvaladdattach" //上传接口
                                        ,
                                    accept: 'file',
                                    data:{
                                        OrderID:data.id
                                    },
                                    before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                                        layer.load(); //上传loading
                                    },
                                    done: function (res) {
                                        //上传完毕回调
                                        layer.closeAll('loading'); //关闭loading
                                        $("#finaFiles").append('<a><span class="currentName">' + res.data.attachName + '</span><i data-file="' + res.data.attachId + '" class="del iconfont icon-guanbi"></i></a>')
                                        financialObj.finaFiles.push(res.data.attachId);
                                    },
                                    error: function () {
                                        layer.closeAll('loading'); //关闭loading
                                        //请求异常回调
                                    }
                                });
                                $("#finaFiles").on("click", 'i.del', function () { //删除附件
                                    var delId = $(this).attr("data-file");
                                    var elem = $(this).parent("a");
                                    //layer.load();
                                    $.fetch({
                                        url: '/gateway/financial/delattach',
                                        type: 'post',
                                        data: {
                                            AttachId: delId
                                        },
                                        cb: function (rs) {
                                            financialObj.finaFiles.splice($.inArray(delId, financialObj.finaFiles), 1);
                                            elem.remove();
                                        }
                                    });
                                })
                                
                                //附件回显
                                // var fid = $("#detail").attr("data-appr");
                                var attaches='';
                                // if(rs.is_fixed_costs==1){
                                //     var attachesUrl='/gateway/financial/downloadfixedcost/'
                                // }else{
                                //     var attachesUrl='/gateway/financial/download/'
                                // }
                                var attachesUrl='/gateway/financial/download/'
                                if(rs.attaches&&rs.attaches.length>0){
                                    for(var j=0;j<rs.attaches.length;j++){
                                        attaches+='<a  title="点击下载" target="_blank" href="'+attachesUrl+''+rs.attaches[j].id+'">'+rs.attaches[j].original_name+'</a>'
                                    }
                                }
                                $("#finaFiles").append(attaches)
                                
                                form.on('submit(subFinanApprForm)', function(data){
                                    var stpeId =$("#subFinanApprForm").attr("data-stpe");
                                    if(data.field.finaApprUser==undefined){
                                        var nextApprovalUserID=0;
                                    }else{
                                        var nextApprovalUserID=data.field.finaApprUser;
                                    }
                                    
                                    var vllue = $("#resultAppr input[name='ApprYn']:checked").val();
                                    //console.log(data.field.contentAppr,data,"20-2-2-")
                                    if(vllue=='1'){
                                        if(data.field.contentAppr==''){
                                            layer.msg('审批意见不能为空！');
                                            return false
                                        }else{
                                            var pram={
                                                ItemID:tabelData.id,
                                                NextApprovalUserID:nextApprovalUserID,
                                                Content:data.field.contentAppr,
                                                IsAgree:data.field.ApprYn,
                                                NextApprovalStep:stpeId,
                                            }
                                            $.fetch({
                                                url: '/gateway/financial/approval',
                                                type: 'post',
                                                data:pram,
                                                cb:function(rs){
                                                    layer.msg('提交成功');
                                                    // financialList(tableNowPage,0);
                                                    var ApplyResults=$("#myfinanDescSel").val();
                                                        // financialList(tableNowPage,0);
                                                        var st=$('#sqSTime').val();                                          
                                                        var et=$('#sqETime').val();
                                                        var ApplyUserName=$("#ApplyUserName").val();
                                                        var ID=$("#ID").val();
                                                        var ProcessType= $('#processTypeName').val();
                                                        var BaoxiaoType = $('#finaType').val();
                                                        var FeeType = $('#FeeType').val();
           
                                                        noticrTable1.reload({
                                                            where: {
                                                                ID:ID,
                                                                ApplyResult:ApplyResults,
                                                                ApplyUserName:ApplyUserName,
                                                                ProcessType:ProcessType,
                                                                BaoxiaoType:BaoxiaoType,
                                                                FeeType:FeeType,
                                                                EndTime:et,
                                                                StartTime:st,
                                                            },
                                                            page: {
                                                                curr: 1 //重新从第 1 页开始
                                                            },
                                                            done: function () {
                                                                autoFixed($(this.elem[0]).next());
                                                                $("#myfinanDescSel").val(this.where.ApplyResult);
                                                            }
                                                    });
                                                    layer.closeAll();
                                                } 
                                            });
                                        }
                                    }else if(vllue=='2'){
                                        layer.confirm('是否提交?',{title:' '},function(index_1){
                                            var pram={
                                                ItemID:tabelData.id,
                                                NextApprovalUserID:nextApprovalUserID,
                                                Content:data.field.contentAppr,
                                                IsAgree:data.field.ApprYn,
                                                NextApprovalStep:stpeId,
                                            }
                                            $.fetch({
                                                url: '/gateway/financial/approval',
                                                type: 'post',
                                                data:pram,
                                                cb:function(rs){
                                                    layer.msg('提交成功');
                                                    // financialList(tableNowPage,0);
                                                    var ApplyResults=$("#myfinanDescSel").val();
                                                    var ApplyUserName=$("#ApplyUserName").val();
                                                        // financialList(tableNowPage,0);
                                                    var st=$('#sqSTime').val();
                                                    var et=$('#sqETime').val();
                                                    var ID=$("#ID").val();
                                                    var ProcessType= $('#processTypeName').val();
                                                    var BaoxiaoType = $('#finaType').val();
                                                    var FeeType = $('#FeeType').val();
           
                                                    noticrTable1.reload({
                                                        where: {
                                                            ID:ID,
                                                            ApplyResult:ApplyResults,
                                                            ApplyUserName:ApplyUserName,
                                                            ProcessType:ProcessType,
                                                            BaoxiaoType:BaoxiaoType,
                                                            FeeType:FeeType,
                                                            EndTime:et,
                                                            StartTime:st,
                                                        },
                                                        page: {
                                                            curr: 1 //重新从第 1 页开始
                                                        },
                                                        done: function () {
                                                            autoFixed($(this.elem[0]).next());
                                                            $("#myfinanDescSel").val(this.where.ApplyResult);
                                                        }
                                                    });
                                                    layer.closeAll();
                                                } 
                                            });
                                        })
                                    }  
                                    return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                                });
                            
                                $("#forwardTo").on("click",function(){
                                    var fowid= $("#finaForwUser select").val();
                                    var ctext =$("#contentAppr").val();
                                    var vllue = $("#resultAppr input[name='ApprYn']:checked").val();
                                    if(vllue=='1'){
                                        if(ctext==''){
                                            layer.msg('审批意见不能为空！');
                                            return false
                                        }
                                    }else if(vllue=='2'){
                                        layer.confirm('是否提交?',{title:' '},function(index_1){
                                            $.fetch({
                                                url: '/gateway/financial/forward',
                                                type: 'post',
                                                data:{
                                                    ForwardUserID:fowid,
                                                    Content:ctext,
                                                    ItemID:fid,
                                                },
                                                cb:function(rs){
                                                    layer.msg('转发成功');
                                                    var ApplyResults=$("#myfinanDescSel").val();
                                                    var ApplyUserName=$("#ApplyUserName").val();
                                                    var st=$('#sqSTime').val();
                                                    var et=$('#sqETime').val();
                                                        // financialList(tableNowPage,0);
                                                    var ID=$("#ID").val();
                                                    var ProcessType= $('#processTypeName').val();
                                                    var BaoxiaoType = $('#finaType').val();
                                                    var FeeType = $('#FeeType').val();
           
                                                    noticrTable1.reload({
                                                        where: {
                                                            ID:ID,
                                                            ApplyResult:ApplyResults,
                                                            ApplyUserName:ApplyUserName,
                                                            ProcessType:ProcessType,
                                                            BaoxiaoType:BaoxiaoType,
                                                            FeeType:FeeType,
                                                            EndTime:et,
                                                            StartTime:st,
                                                        },
                                                        page: {
                                                            curr: 1 //重新从第 1 页开始
                                                        },
                                                        done: function () {
                                                            autoFixed($(this.elem[0]).next());
                                                            $("#myfinanDescSel").val(this.where.ApplyResult);
                                                        }
                                                    });
                                                        // financialList(tableNowPage,0);
                                                        layer.close(index);
                                                } 
                                            });
                                        })
                                    }
                                    // var ctext =$("#contentAppr").val();
                                    // if(ctext==''){
                                    //     $("#contentAppr").focus().addClass('layui-form-danger');
                                    //     layer.msg('审核说明不能为空',{icon:5,anim: 6},function(){

                                    //     })
                                    //     return false
                                    // }
                                    
                                });
                                $("#backApprList").on("click",function(){
                                    layer.close(index);
                                })


                                $("#closeId").on("click",function(){
                                    layer.close(index)
                                })
                                $("#printId").on("click",function(){
                                    var index = layer.load(2, {time: 2000});
                                    $("#printHtml").jqprint({
                                        debug: false,
                                        importCSS: true,
                                        printContainer: true,
                                        operaSupport: false

                                    });  
                                })  
                                // //console.log(data);//id 
                                $.fetch({
                                    url:"/gateway/formtpl/getformdata",
                                    type: 'post',
                                    data:{
                                        ItemID:data.id,
                                        FormType:2,
                                    },
                                    cb:function(rs){
                                        if(rs&&rs.length>0){
                                            var th ='',td=''; 
                                            for(var i =0;i<rs.length;i++){
                                               th+='<th>'+rs[i].label+'</th>';
                                               td+='<td>'+JSON.parse(rs[i].value)+'</td>'
                                            }
                                            $("#lzmFormData thead tr").html(th);
                                            $("#lzmFormData tbody tr").html(td);
                                        }
                                    }
                                })
                                $("#toYzDiat").on("click",function(){
                                    $.fetch({
                                        url:"/gateway/financial/detail",
                                        type: 'post',
                                        data:{
                                            ID:data.parent_id,
                                            // FormType:2,
                                        },
                                        cb:function(rs){
                                          //  console.log(rs);
                                            layer.open({
                                                title:'预支单详情', 
                                                // title:'修改报销付款单',
                                                type: 2, 
                                                content:'detailFinance.html',
                                                area:['80%','80%'],
                                                success:function(layero,index){
                                                    // console.log(data);//id 
                                                    var body = layer.getChildFrame('body', index);
                                                    var iframeWin = window[layero.find('iframe')[0]['name']]; //得到iframe页的窗口对象，执行iframe页的方法：iframeWin.method();
                                                    iframeWin.res=rs;
                                                },
                                             
                                            })
                                        }
                                    })
                                })
                                $("#apprAlert").on("click",function(){
                                    contApprFun();
                                })
                            }
                        })
                        
                    }
                });
            }
        })
    })
</script>
<style>
    .layui-table-cell{
        height: auto !important;
    }
    .layui-table-view .layui-table{
        height: 100%;
    }
</style>
</html>
