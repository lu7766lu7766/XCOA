<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>新增人事变动</title>
    <link rel="stylesheet" type="text/css" href="../../css/iconFont/iconfont.css">
    <link rel="stylesheet" type="text/css" href="../../layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="../../css/formSelects-v4.css">
    <link rel="stylesheet" type="text/css" href="../../layui/css/admin.css">
    <link rel="stylesheet" type="text/css" href="../../css/dtree.css">
    <script src="../../js/jquery.min.js"></script>
</head>

<body layadmin-themealias="default">
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-card-header">
                新增人事变动
            </div>     
            <div class="layui-card-body">
                <div class=" layui-form" lay-filter="addRecord">
                    <div class="layui-form-item">
                         <div class="layui-block">
                            <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                                标题
                            </label>
                            <div class="layui-input-block"  style="margin-left: 130px;">
                                <input type="text" lay-verify="required" id="changeTitle" name="changeTitle" placeholder="" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item"> 
                        <div class="layui-block">
                            <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>变动选项</label>
                            <div class="layui-block" style="margin-left: 130px;">
                                <input type="radio" lay-filter="changeType" name="changeType" value="1" title="调动" checked>
                                <input type="radio" lay-filter="changeType" name="changeType" value="2" title="晋升">
                                <input type="radio" lay-filter="changeType" name="changeType" value="3" title="降职">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                             员工名字
                        </label>
                        <div class="layui-input-block" style="margin-left: 130px;">
                            <input class="layui-input" name="changerUid" type="text" id="changerUid" lay-filter="changerUid"  placeholder="选择奖惩用户" lay-verify="required" ts-selected="" readonly/>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                            原部门
                        </label>
                        <div class="layui-input-inline">
                            <input type="text"  id="changerOldDeptId" name="changerOldDeptId" placeholder="" autocomplete="off" class="layui-input">
                            <!-- <select type="text" xm-select="changerOldDeptId"  id="changerOldDeptId" name="changerOldDeptId" placeholder="" autocomplete="off" class="xm-input xm-select" xm-select-search="" xm-select-radio=""></select> -->
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                            原岗位
                        </label>
                        <div class="layui-input-inline">
                            <input type="text"  id="changerOldTitleId" name="changerOldTitleId" placeholder="" autocomplete="off" class="layui-input">
                            <!-- <select type="text"  id="changerOldTitleId" name="changerOldTitleId" placeholder="" autocomplete="off" class="layui-input"  xm-select="changerOldTitleId"  xm-select-search="" xm-select-radio=""></select> -->
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                            新部门
                        </label>
                        <div class="layui-input-block" style="margin-left: 130px;">
                            <select type="text" xm-select="changerNewDeptId"  id="changerNewDeptId" name="changerNewDeptId" placeholder="" autocomplete="off" class="xm-input xm-select" lay-verify="required" xm-select-search="" xm-select-radio=""></select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                            新岗位
                        </label>
                        <div class="layui-input-block" style="margin-left: 130px;">
                            <select type="text"  id="changerNewTitleId" name="changerNewTitleId" placeholder="" lay-verify="required" autocomplete="off" class="layui-input"  xm-select="changerNewTitleId"  xm-select-search="" xm-select-radio=""></select>
                        </div>
                    </div>
                    <div class="layui-form-item"> 
                        <div class="layui-block">
                            <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                                变动原因
                            </label>
                            <div class="layui-input-block" style="margin-left: 130px;">
                                <input type="text" lay-verify="required"  id="changeCause" name="changeCause" placeholder="" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item ">   
                        <div class="layui-inline">
                            <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                                调岗日期
                            </label>
                            <div class="layui-input-inline">
                                <input type="text" lay-verify="required" class="layui-input" id="changeDate" name="changeDate">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item jsShow "  style="display: none;">   
                        <div class="layui-block">
                            <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                                是否需要实习
                            </label>
                            <div class="layui-block" style="margin-left: 130px;">
                                <input type="radio"  lay-filter="isPractice" name="isPractice" value="1" title="是" checked>
                                <input type="radio"  lay-filter="isPractice" name="isPractice" value="0" title="否">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item sxShow"  style="display: none;">   
                        <div class="layui-block">
                            <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                                开始实习日期
                            </label>
                            <div class="layui-input-inline">
                                <input type="text"  class="layui-input" id="practiceStartdate" name="practiceStartdate">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item sxShow"  style="display: none;">   
                        <div class="layui-block">
                            <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                                预计实习周期
                            </label>
                            <div class="layui-input-inline">
                                <input type="tel"  class="layui-input" id="practiceMonth" name="practiceMonth" onkeypress="return (/[\d]/.test(String.fromCharCode(event.keyCode)))">
                            </div>
                            <div class="layui-form-mid layui-word-aux"> (单位: 月)</div>
                        </div>
                    </div>

                    <div class="layui-form-item">  
                        <div class="layui-inline">
                            <label class="layui-form-label" style="width: 100px"><span style="color:red">*</span>
                                生效日期
                            </label>
                            <div class="layui-input-inline">
                                <input type="text"  lay-verify="required" class="layui-input" id="effectiveDate" name="effectiveDate">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item layui-layout-admin">
                        <div class="layui-input-block">
                            <div class="layui-footer" style="left: 0;">
                                <button id="addRecord"  lay-submit  lay-filter="addRecord" class="layui-btn">提交</button>
                                <button class="layui-btn layui-btn-primary" id="closePage">关闭</button>
                            </div>
                        </div>
                    </div>    
                </div>
            </div>       
        </div>
    </div>
                           
</body>
<script src="../../layui/layui.js"></script>
<script src="../../js/common.js?v=20190218"></script>
<script>
    layui.config({
        base: '../../layui/' //静态资源所在路径
    }).extend({
        index: 'index' //主入口模块
    }).use(['index','form','laydate','table','tableSelect','formSelects'], function(){
        var $ = layui.$
        ,admin = layui.admin
        ,element = layui.element
        ,router = layui.router();
        element.render();
        var laydate = layui.laydate
        // ,dtree=layui.dtree
        ,form = layui.form
        ,layer = layui.layer
        ,table=layui.table
        ,formSelects=layui.formSelects
        ,tableSelect=layui.tableSelect;
        var recorderArr;
       
        laydate.render({ 
            elem: '#changeDate'
            ,type:'datetime'
        });
        laydate.render({ 
            elem: '#practiceStartdate'
            ,type:'datetime'
        });
        laydate.render({ 
            elem: '#effectiveDate'
            ,type:'datetime'
        });
        //用户列表
        tableSelect.render({
            elem: '#changerUid',	//定义输入框input对象 必填
            checkedKey: 'id', //表格的唯一建值，非常重要，影响到选中状态 必填
            searchKey: 'userName',	//搜索输入框的name值 默认keyword
            page:false,
            
            searchPlaceholder: '',	//搜索输入框的提示文字 默认关键词搜索
            table: {	//定义表格参数，与LAYUI的TABLE模块一致，只是无需再定义表格elem
                // limit:10000000
                method:'post'
                ,contentType: 'application/json'
                ,page:'-100'
                ,where:{
                    currentIndex:1,
                    pageSize:10000000,
                }
                ,loading:true
                ,url:urls+'/gateway/user/list'
                ,cols:  [[ //标题栏
                    {type:'radio'}
                    ,{field: 'id', title: '用户ID',width:80}
                    ,{field: 'name', title: '用户名'}
                    ,{field: 'department_name', title: '部门',sort: true }
                    ,{field: 'title_name', title: '岗位',sort: true }
                ]]
                ,request: {
                    pageName: 'currentIndex' //页码的参数名称，默认：page
                    ,limitName: 'pageSize' //每页数据量的参数名，默认：limit
                }
                ,parseData: function(res){ //res 即为原始返回的数据
                    return {
                        "status_code":res.status_code, //解析接口状态
                        "message": res.message, //解析提示文本
                        // "count": res.data.total_count, //解析数据长度
                        "data": res.data.data_list, //解析数据列表
                        // "curr":res.data.page_index
                    };
                }
                // ,done:function(){
                //     $(".layui-table-page").hide();
                // }
            },
            done:  function (elem, data) {
                var NEWJSON = [];
                recorderArr=[];
                console.log(elem, data)
                layui.each(data.data, function (index, item) {
                    NEWJSON.push(item.name);
                    recorderArr.push({
                        changerUid:item.id,
                        changerName:item.name,
                        changerOldDeptId:item.department_id,
                        changerOldTitleId:item.job_title_id,

                        recorderDeptName:item.department_name,
                        recorderTitleName:item.title_name,
                    })
                })
                elem.val(NEWJSON.join(","))
                // elem.val(data.data[0].name);
                // elem.attr('userId',''+data.data[0].id+'');
                $("#changerOldDeptId").val(recorderArr[0].recorderDeptName);
                $("#changerOldTitleId").val(recorderArr[0].recorderTitleName);
                // $("#recorderDeptId").attr('subVal',''+data.data[0].department_id+'');
                // $("#recorderTitleId").attr('subVal',''+data.data[0].job_title_id+'');

            }
        })
          //部门下拉
        $.fetch({//部门树列表
            url: "/gateway/department/tree",
            type: 'post',
            cb:function(rs){
                var formSelectsArr=rs[0].children[0].children;
                // formSelectsArr.unshift({'name':'全部','id':'-1'})
                //新
                formSelects.config('changerNewDeptId', {
                    keyName: 'name',
                    keyVal: 'id'
                })
                layui.formSelects.data('changerNewDeptId', 'local', {
                    radio: true,
                    arr:formSelectsArr
                });
                // formSelects.render('deptId', {
                //     radio: true,                    //是否设置为单选模式
                // });
            }
        });
        
        $.fetch({//岗位树列表
            url: "/gateway/jobTitle/tree",
            type: 'post',
            cb:function(rs){
                var formSelectsArr=rs;
                // formSelectsArr.unshift({'name':'全部','id':'-1'})
                //新
                formSelects.config('changerNewTitleId', {
                    keyName: 'title_name',
                    keyVal: 'id'
                })
                layui.formSelects.data('changerNewTitleId', 'local', {
                    radio: true,
                    arr:formSelectsArr
                });
            
            }
        });
        
        //联动必填事件
        //监听变动选项
        form.on('radio(changeType)', function(data){
            if(data.value==2){
                $('.jsShow').show();
                if($("input[name='isPractice']:checked").val()==1){
                    $('.sxShow').show();
                    $("#practiceStartdate").attr("lay-verify","required");
                    $("#practiceMonth").attr("lay-verify","required");
                    
                }else{
                    $('.sxShow').hide();
                    $("#practiceStartdate").removeAttr("lay-verify");
                    $("#practiceMonth").removeAttr("lay-verify");
                    
                }
            }else{
                $('.jsShow').hide();    
                $('.sxShow').hide(); 
                $("#practiceStartdate").removeAttr("lay-verify");
                $("#practiceMonth").removeAttr("lay-verify");
            }
        });  
        //监听是否实习
        form.on('radio(isPractice)', function(data){
            if(data.value==1){
                $('.sxShow').show();
                $("#practiceStartdate").attr("lay-verify","required");
                $("#practiceMonth").attr("lay-verify","required");
            }else{   
                $('.sxShow').hide();   
                $("#practiceStartdate").removeAttr("lay-verify");
                $("#practiceMonth").removeAttr("lay-verify");
            }
        }); 

        //提交
        form.on('submit(addRecord)', function(data){
            // changeTitle：【必填】，  changeType：【必填】，changerUid：【必填】，changerName：【必填】，changerOldDeptId：【必填】，changerNewDeptId：【必填】，changerOldTitleId：【必填】，changerNewTitleId：【必填】，changeCause：【必填】， changeDate：【必填】，effectiveDate：【必填】，isPractice：【changeType = 2 时，必填】，practiceStartdate：【isPractice = 1 时，必填】，practiceMonth：【isPractice = 1 时，必填】

            data.field['changerUid']=recorderArr[0].changerUid;
            data.field['changerName']=recorderArr[0].changerName;

            data.field['changerOldDeptId']=recorderArr[0].changerOldDeptId;
            data.field['changerOldTitleId']=recorderArr[0].changerOldTitleId;
            
            if(data.field.changeType!=2){
                data.field['isPractice']=''
                data.field['practiceMonth']=''
                data.field['practiceStartdate']=''
            }else{
                if(data.field.isPractice!=1){
                    data.field['practiceMonth']=''
                    data.field['practiceStartdate']=''
                }
            }
            $.fetch({
                url:"/gateway/userChange/addRecord",
                type: 'post',
                data:data.field,
                cb:function(rs){
                    layer.msg('提交成功')
                    setTimeout(function(){
                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                        parent.layer.close(index); //再执行关闭  
                    }, 300 );
                }
            });
            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });
        $("#closePage").on("click",function(){
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭  

        })
    })
</script>

</html>