<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>离职申请审批</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="../../css/iconFont/iconfont.css">
    <link rel="stylesheet" type="text/css" href="../../layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="../../layui/css/admin.css">
</head>

<body layadmin-themealias="default">
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-card-header">
                离职申请审批列表
            </div>
            <div class="layui-card-body">
                <div class="pz-10 layui-form">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">状态</label>
                            <div class="layui-inline">
                                <select id="status" name="status" lay-filter="status">
                                    <option value="3">全部</option>
                                    <option value="0">待审批</option>
                                    <option value="1">未通过</option>
                                    <option value="2">已通过</option>
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">离职人</label>
                            <div class="layui-input-inline">
                                <input id="userName" type="text" name="userName" placeholder="" autocomplete="off"
                                    class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">提交人</label>
                            <div class="layui-input-inline">
                                <input id="submitUserName" type="text" name="submitUserName" placeholder=""
                                    autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <button id="RecruiListUserFile" lay-submit lay-filter="RecruiListUserFile"
                                class="layui-btn layui-btn">
                                <i class="iconfont icon-sousuo"></i>
                            </button>
                            <button class="layui-btn layui-btn layui-btn-primary" lay-filter="closeLayer"
                                id="closeLayer">
                                返回
                            </button>
                        </div>
                    </div>
                </div>
                <table id="ResigTable" lay-filter="ResigTable"></table>
            </div>
        </div>
    </div>
    </div>
</body>
<script src="../../js/jquery.min.js"></script>
<script src="../../layui/layui.js"></script>
<script src="../../js/common.js?0.1" type="text/javascript"></script>
<script>
    layui.config({
        base: '../../layui/' //静态资源所在路径
    }).extend({
        index: 'index' //主入口模块
    }).use(['index', 'laydate', 'table', 'form','upload'], function () {
        var $ = layui.$,
            admin = layui.admin
        var laydate = layui.laydate,
            form = layui.form,
            upload = layui.upload,
            table = layui.table;
        //消息中心跳转来则传入id
        var urlTab = location.href.split('?tab=')[1]?location.href.split('?tab=')[1]:false;
        var tabId=urlTab?urlTab.split('?')[0]:false;
        var dataId = location.href.split('?id=')[1]?location.href.split('?id=')[1]:false;
        console.log(dataId);
        if(dataId){
            var tableSub={
                status:3,
                demissionId:dataId
            }
        }else{
            var tableSub={
                status:3
            }
        }

         // 消息表格
        var RecruiList = table.render({
            elem: '#ResigTable',
            url: urls + '/gateway/demission/approvalLists', //数据接口
            page: true, //开启分页
            method: 'post',
            where:tableSub,
            limits:[10,20,30,40,50,60,70,80,90,100,200,500,1000,5000],
            contentType: 'application/json',
            text: {
                none: '暂无数据' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
            },
            cols: [
                [ //表头
                    // {
                    //     field: 'department_name',
                    //     title: '申请部门',
                    //     minWidth:100,
                    // },
                    {
                        field: 'id',
                        title: 'ID',
                        minWidth:80,
                    },{
                        field: 'submit_username',
                        title: '提交人',
                        minWidth:90,
                        sort:true
                    },  {
                        field: 'from_name',
                        title: '离职人',
                        minWidth:90,
                        sort:true
                    
                    },  {
                        field: 'department_name',
                        title: '离职部门',
                        minWidth:160,
                        sort:true
                    
                    }, {
                        field: 'title_name',
                        title: '离职岗位',
                        minWidth:160,
                        sort:true
                    
                    }, {
                        field: 'last_work_time',
                        title: '最后工作日期',
                        minWidth:160,
                    },{
                        field: 'created_at',
                        title: '申请日期',
                        minWidth:160,
                    }, {
                        field: 'approval',
                        title: '审批人',
                        minWidth:100,
                        templet: function (d) {
                            return  d.approval==null?'暂无':d.approval.approval_name
                        }
                    },
                    {
                        field: '',
                        title: '审批结果',
                        minWidth:120,
                        templet: function (d) {
                           var htmlBtn = '<button class="'+["layui-btn layui-btn-primary layui-btn-xs","layui-btn layui-btn-warm layui-btn-xs","layui-btn layui-btn-primary layui-btn-xs layui-btn-disabled"][d.approval_result]+'">'+['待审批','未通过','已通过'][d.approval_result]+'</button>'
                        return htmlBtn
                        }
                    },
                    {
                        field: '',
                        title: '申请单状态',
                        minWidth:120,
                        templet: function (d) {
                           var htmlBtn = '<button class="'+["layui-btn layui-btn-primary layui-btn-xs","layui-btn layui-btn-warm layui-btn-xs","layui-btn layui-btn-primary layui-btn-xs layui-btn-disabled","","layui-btn layui-btn-primary layui-btn-xs layui-btn-disabled","layui-btn layui-btn-primary layui-btn-xs layui-btn-disabled"][d.approval_status]+'">'+['待审批','未通过','已通过','','待撤回','已撤回'][d.approval_status]+'</button>'
                            return htmlBtn
                        }
                    }, {
                        field: '',
                        fixed: 'right',
                        unresize: true,
                        title: '操作',
                        minWidth:180,
                        templet:function(d){
                            var btn ='<a class="layui-btn layui-btn-sm" lay-event="diat">查看详情</a>'
                            if(d.approval_result!=1&&d.approval_result!=2&&d.approval_status!=4){
                                btn+='<a class="layui-btn layui-btn-warm layui-btn-sm" lay-event="appr">审核</a>'
                            }else{
                                btn+='<button class="layui-btn layui-btn-disabled layui-btn-sm" >审核</button>'                                
                            }
                            if(d.approval_status==4){
                                btn+='<a class="layui-btn layui-btn-warm layui-btn-sm" lay-event="apprCanel">撤销审核</a>'
                            }
                            return btn
                        },
                    }
                ]
            ],
            request: {
                pageName: 'currentIndex' //页码的参数名称，默认：page
                    ,
                limitName: 'pageSize' //每页数据量的参数名，默认：limit
            },
            parseData: function (res) { //res 即为原始返回的数据
                return {
                    "status_code": res.status_code, //解析接口状态
                    "message": res.message, //解析提示文本
                    "count": res.data.total_count, //解析数据长度
                    "data": res.data.data_list, //解析数据列表
                    "curr": res.data.page_index
                };
            },
            done: function (res) {
                if(dataId&&this.where.demissionId!=''){
                    $('.layui-table-body.layui-table-main a[lay-event="diat"]').click();
                }
            }
        });

        // 筛选
        form.on('submit(RecruiListUserFile)', function(data){
        // $("#RecruiListUserFile").on("click",function(){
            // console.log($("#departmentId").val(),data)
            // var status = $("#status").val();
            data.field.departmentId=(data.field.departmentId== -1?' ':data.field.departmentId)
            RecruiList.reload({
                where:data.field,
                page: {
                    curr: 1 //重新从第 1 页开始
                },
            })
            $("#closeLayer").show();
        })
        // 返回
        $("#closeLayer").hide();
        $("#closeLayer").on("click",function(){
            $(this).hide();
            form.val("user-file-form", {
                "status": '3' // "name": "value"
                ,"userName":''
                ,"submitUserName":''
                
            })
            RecruiList.reload({
                where:{
                    status:3
                }
            })
        })
        
        //列表详情
        table.on('tool(ResigTable)', function(obj){
            var data = obj.data; //获得当前行数据
            var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event
            // console.log(data)
            if(layEvent == 'diat'){
                $.fetch({
                    url:'/gateway/demissionManage/detail',
                    type: 'post',
                    data:{
                        demissionId:data.id,
                        fromUid:data.from_uid
                    },
                    cb:function(rs){
                        var RScont = rs;
                        var shtml='';
                        if(rs.attach&&rs.attach!=''){
                            for(var i=0;i<rs.attach.length;i++){
                                // /gateway/companyrule/download/'+rs.attach[i].id+'
                                shtml+='<a class="seeXqOutIn cateID ml-10" href="'+urls+'/gateway/demissionAttach/download?demissionId='+rs.attach[i].demission_id+'&attachId='+rs.attach[i].id+'"><span>'+rs.attach[i].original_name+'</span></a>'
                            }
                        }else{
                            shtml+='<span>暂无附件</span>'
                        }
                        var fj = ''
                        if(rs.attach.length!=0){
                                fj = '<fieldset class="layui-elem-field">'
                                +'<legend>附件</legend>'
                                +'<div class="layui-field-box">'+shtml+'</div>'
                            +'</fieldset>'
                        }
                        // 审批反馈意见
                        var spfk = '';
                        var res ='';
                        var classList ='';
                        if(rs.approvalHistory&&rs.approvalHistory!=''){
                            // console.log("1111",rs.approvalHistory)
                            for (const i in rs.approvalHistory) {
                                if(rs.approvalHistory[i].approval_result==1){
                                    res ="不同意";
                                    classList = "red";
                                }else if(rs.approvalHistory[i].approval_result==2){
                                    res ="同意";
                                    classList = 'green';
                                }else if(rs.approvalHistory[i].approval_result==0){
                                    res ="待审批";
                                    classList = 'gray';
                                }
                                var updatedAt = rs.approvalHistory[i].updated_at==null?' ':rs.approvalHistory[i].updated_at
                                 var contEnt = rs.approvalHistory[i].content==null?'':rs.approvalHistory[i].content
                                spfk+='<p><span> 【 '+rs.approvalHistory[i].approval_name+''+(rs.approvalHistory[i].is_revocation==1?'<em class="red">[撤销审批]</em>':'')+'<em class='+classList+'>'+res+' '+updatedAt+'</em> 】</span>'+contEnt+'</p>'
                            }
                        }else{
                            shtml+='<span>暂无反馈</span>'
                        }

                        // 审批按钮、
                        var Span = '';
                        var contS ='';
                        $.fetch({ 
                            url: "/gateway/demission/managerList",
                            type: 'post',
                            data:{
                                step:data.nextStep,
                                departmentId:data.from_deptid,
                                applyuserId:data.from_uid,
                                itemId:data.id,
                                approvalType:12,
                                userType:6
                            },
                            cb:function(rs){
                                for(var i=0; i<rs.userList.length;i++){
                                    contS+='<option value="'+rs.userList[i].id+'">'+rs.userList[i].name+'</option>'
                                }
                                if(RScont.current_approval&&RScont.current_approval!=''){
                                    for(const i in RScont.current_approval){
                                        if(RScont.current_approval[i].approval_result==0){
                                            Span+='<div class="layui-card">'
                                                +'<div class="reviewCont layui-card-body">'
                                                    +'<div class="layui-form" action="">'
                                                        +'<div class="layui-form-item">'
                                                            +'<label class="layui-form-label">审批意见：</label>'
                                                            +'<div class="layui-input-block">'
                                                                +'<textarea id="appDacText" name="suggestion" class="layui-textarea" cols="50" rows="4" ></textarea>'
                                                            +'</div>'
                                                        +'</div>'
                                                        +'<div class="layui-form-item" id="approvalNo">'
                                                            +'<label class="layui-form-label">是否同意：</label>'
                                                            +'<div class="layui-input-block">'
                                                                +'<input type="radio" name="approvalYn" lay-filter="forCont" value="2" title="同意">'
                                                                +'<input type="radio" name="approvalYn" lay-filter="forCont" value="1" title="不同意" checked>'
                                                            +'</div>'
                                                        +'</div>'
                                                        if(rs.step!=7){
                                                            Span+='<div class="layui-form-item" id="xbshr">'
                                                                +'<label class="layui-form-label">下步审核人</label>'
                                                                +'<div class="layui-input-inline">'
                                                                    +'<select id="NextStep" lay-filter="NextStep">'+contS+'</select>'
                                                                +'</div>'
                                                            +'</div>'
                                                        }
                                                        Span+='<div class="layui-form-item" id="">'
                                                            +'<label class="layui-form-label">附件：</label>'
                                                            +'<div class="layui-input-block">'
                                                                +'<button type="button" class="layui-btn" id="test1">'
                                                                    +'<i class="layui-icon">&#xe67c;</i>上传'
                                                                +'</button>'
                                                                +'<div id="finaFiles" class="UploadNames-box UploadFl layui-input-lineHeight"></div>'
                                                            +'</div>'
                                                        +'</div>'
                                                        +'<div class="layui-form-item">'
                                                            +'<div class="layui-input-block">'
                                                                +' <button class="appOk layui-btn" data-item="'+data.id+'" id="appOk">确认</button>'
                                                                +' <button class="layui-btn layui-btn-primary" id="GbcloseId">关闭</button>'
                                                            +'</div>'
                                                        +'</div>'
                                                    +'</div>'
                                                +'</div>'
                                            +'</div>'
                                        }
                                    }
                                }else{
                                    Span+=''
                                }
                                
                                // 修改
                                var nullSubj =  RScont.subject==null?"无":RScont.subject;
                                var submitHtml =''
                                var htmlS = '';
                                var listS = RScont.demission_reason.split(",");
                                var contS = RScont.other_reason==null?'':RScont.other_reason
                                var b = []
                                var hasZero= listS.indexOf("0")>-1;
                                if(hasZero){
                                    listS=listS.filter(item=> item!=0)
                                }
                                var Submit =''
                                if(data.source==1){
                                    submitHtml +='<fieldset class="layui-elem-field">'
                                                        +'<legend>提交原因</legend>'
                                                        +'<div class="layui-field-box ">'+nullSubj+'</div>'
                                                    +'</fieldset>'
                                    
                                    for(var i=0;i<listS.length;i++){
                                        if(listS[i]==13){
                                            b.push(['资谴'])
                                        }else if(listS[i]==14){
                                            b.push(['开除'])
                                        }else{
                                            b.push(['其他'])
                                        }
                                    } 
                                    if(hasZero){
                                        b.push("其他：")
                                    }
                                    htmlS=b.join("，")+contS
                                    Submit+='<div class="layui-inline">'
                                                    +'<label class="layui-form-label">提交人：</label>'
                                                +'<div class="layui-input-inline cateID sqname">'
                                                        +'<span>'+RScont.submit_username+'</span>'
                                                +'</div>'
                                            +'</div>'
                                    
                                }else{
                                    submitHtml += '<fieldset class="layui-elem-field">'
                                                        +'<legend>你对工作单位有何建议/意见</legend>'
                                                        +'<div class="layui-field-box ">'+nullSubj+'</div>'
                                                    +'</fieldset>'

                                    for(var i=0;i<listS.length;i++){
                                        b.push(['其他','工资不符个人期望','福利不好','工作辛苦','工作压力','工作缺乏挑战','工作环境不好','没有发展空间','同事关系不融洽','公司文化不适','自寻创业','另谋职业','读书进修','个人健康','家庭原因'][listS[i]])
                                    
                                    }
                                    if(hasZero){
                                        b.push("其他：")
                                    }
                                    htmlS = b.join("，") +contS
                                }
                                var DataList = '<div class="layui-card-body">'
                                        +'<div class="layui-form" lay-filter="component-form-depar">'
                                        +'<div class="layui-form-item">'
                                            +Submit
                                            +'<div class="layui-inline">'
                                                +'<label class="layui-form-label">申请人：</label>'
                                                +'<div class="layui-input-inline cateID sqname">'
                                                    +'<span>'+RScont.from_name+'</span>'
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-inline">'
                                                +'<label class="layui-form-label">部门：</label>'
                                                +'<div class="layui-input-inline cateID bumen">'
                                                    +'<span>'+RScont.dept_name+'</span>'
                                                    +'</div>'
                                                +'</div>'
                                        +'</div>'
                                        +'<div class="layui-form-item">'
                                            +'<div class="layui-inline">'
                                                    +'<label class="layui-form-label">离职岗位：</label>'
                                                +'<div class="layui-input-inline cateID">'
                                                        +'<span>'+RScont.title_name+'</span>'
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-inline">'
                                                    +'<label class="layui-form-label modify-form-label">最后工作日期：</label>'
                                                +'<div class="layui-input-inline cateID">'
                                                        +'<span>'+RScont.last_work_time+'</span>'
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-inline">'
                                                    +'<label class="layui-form-label">离职原因：</label>'
                                                +'<div class="layui-input-inline cateID">'
                                                        +'<span>'+htmlS+'</span>'
                                                +'</div>'
                                            +'</div>'
                                        +'</div>'
                                    +'</div>'
                                    // +'<fieldset class="layui-elem-field">'
                                    //     +'<legend>附件</legend>'
                                    //     +'<div class="layui-field-box"></div>'
                                    // +'</fieldset>'
                                    +'<fieldset class="layui-elem-field">'
                                        +'<legend>工作交接清单(办公用品)</legend>'
                                        +'<div class="layui-field-box">'+RScont.office_list+'</div>'
                                        +'<legend>工作交接清单(资料文档)</legend>'
                                        +'<div class="layui-field-box">'+RScont.document_list+'</div>'
                                    +'</fieldset>'
                                    +submitHtml
                                    if(rs.approval_status==4||rs.approval_status==5){
                                        DataList+='<fieldset class="layui-elem-field">'
                                            +'<legend>撤销申请原因</legend>'
                                            +'<div class="layui-field-box ">'+rs.cancel_cause+'</div>'
                                        +'</fieldset>'
                                    }
                                    DataList+=fj
                                    +'<fieldset class="layui-elem-field">'
                                        +'<legend>审批意见反馈</legend>'
                                        +'<div class="layui-field-box ">'+spfk+'</div>'
                                    +'</fieldset>'
                                    +Span
                                +'</div>'
                                
                                layer.open({
                                    title:'离职详情信息',
                                    type: 1, 
                                    content:DataList,
                                    area:['100%', '100%'],
                                    success:function(layero,index){
                                        $("#GbcloseId").on("click",function(){
                                            layer.close(index)
                                        })
                                        // console.log(rs,"111-1-1-1-",data.approval_result,data.nextStep,'-2-2-2',data)
                                        var isAgree = $("#approvalNo").find(" input[name='approvalYn']:checked").val();
                                        if(isAgree==1){
                                                $("#xbshr").hide();
                                        }
                                        form.on('radio(forCont)', function(data){
                                            // console.log(data.elem); //得到radio原始DOM对象
                                            // console.log(data.value); //被点击的radio的value值
                                            if(data.value==1){
                                                $("#xbshr").hide();
                                            }else{
                                                $("#xbshr").show();
                                            }
                                        }); 
                                        var financialObj = { //保存财务相关数据的对象
                                            finaFiles: [], //附件id数组
                                        }
                                         //执行实例
                                        var uploadInst = upload.render({
                                            elem: '#test1' //绑定元素
                                            ,url: window.urls +'/gateway/demissionAttach/add' //上传接口
                                            ,accept:"file"
                                            ,data:{
                                                DemissionID:data.id
                                            }
                                            ,before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                                                layer.load(); //上传loading
                                            }
                                            ,done: function(res){
                                                //上传完毕回调
                                                layer.closeAll('loading'); //关闭loading
                                                $("#finaFiles").append('<a><span class="currentName">' + res.data.attachName + '</span><i data-file="' + res.data.attachId + '" class="del iconfont icon-guanbi"></i></a>')
                                                financialObj.finaFiles.push(res.data.attachId);
                                            }
                                            ,error: function(){
                                                //请求异常回调
                                                layer.closeAll('loading');
                                            }
                                        });
                                        $(".reviewCont").on("click", 'i.del', function () { //删除附件
                                            var delId = $(this).attr("data-file");
                                            var elem = $(this).parent("a");
                                            //layer.load();
                                            $.fetch({
                                                url: '/gateway/demissionAttach/del',
                                                type: 'post',
                                                data: {
                                                    demissionId:data.id,
                                                    attachId: delId
                                                },
                                                cb: function (rs) {
                                                    financialObj.finaFiles.splice($.inArray(delId, financialObj.finaFiles), 1);
                                                    elem.remove();
                                                }
                                            });
                                        })
                                        if(data.approval_result==0&&data.nextStep<=6){
                                            if(rs.step==7){
                                                $("#appOk").off("click").on("click",function(){
                                                    var content = $("#appDacText").val();
                                                    var isAgree = $("#approvalNo").find(" input[name='approvalYn']:checked").val();
                                                    var nextApproval = $("#NextStep").val();
                                                    if(content==''){
                                                        layer.msg("意见不能为空!");
                                                        return false
                                                    }
                                                    $.fetch({
                                                        url:"/gateway/demission/approval",
                                                        type: 'post',
                                                        data:{
                                                            demissionId: data.id,
                                                            trueStep: 6,
                                                            nextApprovalUid:-1,
                                                            approvalResult:isAgree,
                                                            approvalContent:content,
                                                        },
                                                        cb:function(rs){
                                                            layer.closeAll();
                                                            layer.msg("审批完成");
                                                            table.reload('ResigTable')
                                                        }
                                                    })
                                                })
                                            }else{
                                                $("#appOk").off("click").on("click",function(){
                                                    var content = $("#appDacText").val();
                                                    var isAgree = $("#approvalNo").find(" input[name='approvalYn']:checked").val();
                                                    var nextApproval = $("#NextStep").val();
                                                    if(content==''){
                                                        layer.msg("意见不能为空!");
                                                        return false
                                                    }
                                                    $.fetch({
                                                        url:"/gateway/demission/approval",
                                                        type: 'post',
                                                        data:{
                                                            demissionId: data.id,
                                                            trueStep: rs.step,
                                                            nextApprovalUid:nextApproval,
                                                            approvalResult:isAgree,
                                                            approvalContent:content,
                                                        },
                                                        cb:function(rs){
                                                            layer.closeAll();
                                                            layer.msg("审批完成");
                                                            table.reload('ResigTable')
                                                        }
                                                    })
                                                })
                                            }
                                            form.render();
                                        }else if(data.approval_result==0&&data.nextStep==7){
                                            // 审核确认
                                            $("#appOk").off("click").on("click",function(){
                                                var content = $("#appDacText").val();
                                                var isAgree = $("#approvalNo").find(" input[name='approvalYn']:checked").val();
                                                // console.log(data.hire_id,data.approval_result,isAgree)
                                                if(content==''){
                                                    layer.msg("意见不能为空!");
                                                    return false
                                                }
                                                $.fetch({
                                                    url:"/gateway/demission/approval",
                                                    type: 'post',
                                                    data:{
                                                        demissionId: data.id,
                                                        trueStep: 6,
                                                        nextApprovalUid:-1,
                                                        approvalResult:isAgree,
                                                        approvalContent:content,
                                                    },
                                                    cb:function(rs){
                                                        layer.closeAll();
                                                        layer.msg("审批完成");
                                                    table.reload('ResigTable')
                                                    }
                                                })
                                            })                                        
                                        }
                                        form.render();
                                    }
                                })
                            }
                        })
                    }
                })
            }else if(layEvent =='appr'){
             var uploadInstHtml='<div class="layui-form-item" id="">'
                            +'<label class="layui-form-label">附件：</label>'
                            +'<div class="layui-input-block">'
                                +'<button type="button" class="layui-btn" id="test1">'
                                    +'<i class="layui-icon">&#xe67c;</i>上传'
                                +'</button>'
                                +'<div id="finaFiles" class="UploadNames-box UploadFl layui-input-lineHeight"></div>'
                            +'</div>'
                        +'</div>'
                if(data.approval_result==0&&data.nextStep<=6){
                    $.fetch({ 
                        url: "/gateway/demission/managerList",
                        type: 'post',
                        data:{
                            step:data.nextStep,
                            departmentId:data.from_deptid,
                            applyuserId:data.from_uid,
                            itemId:data.id,
                            approvalType:12,
                            userType:6
                        },
                        cb:function(rs){
                            if(rs.step==7){
                                var htmlS = '<div class="layui-card">'
                                    +'<div class="reviewCont layui-card-body">'
                                        +'<div class="layui-form" action="">'
                                            +'<div class="layui-form-item">'
                                                +'<label class="layui-form-label">审批意见：</label>'
                                                +'<div class="layui-input-block">'
                                                    +'<textarea id="appDacText" name="suggestion" class="layui-textarea" cols="50" rows="4" ></textarea>'
                                                +'</div>'
                                            +'</div>'
                                            +'<div class="layui-form-item" id="approvalNo">'
                                                +'<label class="layui-form-label">是否同意：</label>'
                                                +'<div class="layui-input-block">'
                                                    +'<input type="radio" name="approvalYn" value="2" title="同意">'
                                                    +'<input type="radio" name="approvalYn" value="1" title="不同意" checked>'
                                                +'</div>'
                                            +'</div>'
                                            +uploadInstHtml
                                            +'<div class="layui-form-item">'
                                                +'<div class="layui-input-block">'
                                                    +' <button class="appOk layui-btn" data-item="'+data.id+'">确认</button>'
                                                +'</div>'
                                            +'</div>'
                                        +'</div>'
                                    +'</div>'
                                +'</div>'
                                layer.open({
                                    title:'离职审批',
                                    type: 1, 
                                    content:htmlS,
                                    id:'ApprovalAdd',
                                    area:['60%', 'auto'],
                                    success:function(layero,index){
                                        var financialObj = { //保存财务相关数据的对象
                                            finaFiles: [], //附件id数组
                                        }
                                        //执行实例
                                        var uploadInst = upload.render({
                                            elem: '#test1' //绑定元素
                                            ,accept:"file"
                                            ,url: window.urls+'/gateway/demissionAttach/add' //上传接口
                                            ,data:{
                                                DemissionID:data.id
                                            }
                                            ,before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                                                layer.load(); //上传loading
                                            }
                                            ,done: function(res){
                                                //上传完毕回调
                                                layer.closeAll('loading'); //关闭loading
                                                $("#finaFiles").append('<a><span class="currentName">' + res.data.attachName + '</span><i data-file="' + res.data.attachId + '" class="del iconfont icon-guanbi"></i></a>')
                                                financialObj.finaFiles.push(res.data.attachId);
                                            }
                                            ,error: function(){
                                                //请求异常回调
                                                layer.closeAll('loading');
                                            }
                                        });
                                        $(".reviewCont").on("click", 'i.del', function () { //删除附件
                                            var delId = $(this).attr("data-file");
                                            var elem = $(this).parent("a");
                                            //layer.load();
                                            $.fetch({
                                                url: '/gateway/demissionAttach/del',
                                                type: 'post',
                                                data: {
                                                    demissionId:data.id,
                                                    attachId: delId
                                                },
                                                cb: function (rs) {
                                                    financialObj.finaFiles.splice($.inArray(delId, financialObj.finaFiles), 1);
                                                    elem.remove();
                                                }
                                            });
                                        })
                                    }
                                })
                                // 审核确认
                                $("#ApprovalAdd .appOk").off("click").on("click",function(){
                                    var content = $("#appDacText").val();
                                    var isAgree = $("#approvalNo").find(" input[name='approvalYn']:checked").val();
                                    // console.log(data.hire_id,data.approval_result,isAgree)
                                    if(content==''){
                                        layer.msg("意见不能为空!");
                                        return false
                                    }
                                    $.fetch({
                                        url:"/gateway/demission/approval",
                                        type: 'post',
                                        data:{
                                            demissionId: data.id,
                                            trueStep: 6,
                                            nextApprovalUid:-1,
                                            approvalResult:isAgree,
                                            approvalContent:content,
                                        },
                                        cb:function(rs){
                                            layer.closeAll();
                                            layer.msg("审批完成");
                                            table.reload('ResigTable')
                                        }
                                    })
                                
                                })
                                form.render();
                            }else{
                                var contS ='';
                                for(var i=0; i<rs.userList.length;i++){
                                    contS+='<option value="'+rs.userList[i].id+'">'+rs.userList[i].name+'</option>'
                                }
                                var htmlS = '<div class="layui-card">'
                                        +'<div class="reviewCont layui-card-body">'
                                            +'<div class="layui-form" action="">'
                                                +'<div class="layui-form-item">'
                                                    +'<label class="layui-form-label">审批意见：</label>'
                                                    +'<div class="layui-input-block">'
                                                        +'<textarea id="appDacText" name="suggestion" class="layui-textarea" cols="50" rows="4" ></textarea>'
                                                    +'</div>'
                                                +'</div>'
                                                +'<div class="layui-form-item" id="approvalNo">'
                                                    +'<label class="layui-form-label">是否同意：</label>'
                                                    +'<div class="layui-input-block">'
                                                        +'<input type="radio" name="approvalYn" lay-filter="forCont" lay-filter="forCont" value="2" title="同意">'
                                                        +'<input type="radio" name="approvalYn" lay-filter="forCont" lay-filter="forCont" value="1" title="不同意" checked>'
                                                    +'</div>'
                                                +'</div>'
                                                +'<div class="layui-form-item" id="xbshr">'
                                                    +'<label class="layui-form-label">下步审核人</label>'
                                                    +'<div class="layui-input-inline">'
                                                        +'<select id="NextStep" lay-filter="NextStep">'+contS+'</select>'
                                                    +'</div>'
                                                +'</div>'
                                                +uploadInstHtml
                                                +'<div class="layui-form-item">'
                                                    +'<div class="layui-input-block">'
                                                        +' <button class="appOk layui-btn" data-item="'+data.id+'">确认</button>'
                                                        +' <button class="layui-btn layui-btn-primary" id="closeId">关闭</button>'
                                                    +'</div>'
                                                +'</div>'
                                            +'</div>'
                                        +'</div>'
                                    +'</div>'
                                    layer.open({
                                        title:'离职审批',
                                        type: 1, 
                                        content:htmlS,
                                        id:'ApprovalAdd',
                                        area:['60%', 'auto'],
                                        success:function(layero,index){
                                            // console.log(data);//id 
                                            $("#closeId").on("click",function(){
                                                layer.close(index)
                                            })

                                            var isAgree = $("#approvalNo").find(" input[name='approvalYn']:checked").val();
                                            if(isAgree==1){
                                                 $("#xbshr").hide();
                                            }

                                            var financialObj = { //保存财务相关数据的对象
                                                finaFiles: [], //附件id数组
                                            }
                                            //执行实例
                                            var uploadInst = upload.render({
                                                elem: '#test1' //绑定元素
                                                ,url: window.urls +'/gateway/demissionAttach/add' //上传接口
                                                ,accept:"file"
                                                ,data:{
                                                    DemissionID:data.id
                                                }
                                                ,before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                                                    layer.load(); //上传loading
                                                }
                                                ,done: function(res){
                                                    //上传完毕回调
                                                    layer.closeAll('loading'); //关闭loading
                                                    $("#finaFiles").append('<a><span class="currentName">' + res.data.attachName + '</span><i data-file="' + res.data.attachId + '" class="del iconfont icon-guanbi"></i></a>')
                                                    financialObj.finaFiles.push(res.data.attachId);
                                                }
                                                ,error: function(){
                                                    //请求异常回调
                                                    layer.closeAll('loading');
                                                }
                                            });
                                            $(".reviewCont").on("click", 'i.del', function () { //删除附件
                                                var delId = $(this).attr("data-file");
                                                var elem = $(this).parent("a");
                                                //layer.load();
                                                $.fetch({
                                                    url: '/gateway/demissionAttach/del',
                                                    type: 'post',
                                                    data: {
                                                        demissionId:data.id,
                                                        attachId: delId
                                                    },
                                                    cb: function (rs) {
                                                        financialObj.finaFiles.splice($.inArray(delId, financialObj.finaFiles), 1);
                                                        elem.remove();
                                                    }
                                                });
                                            })
                                            form.on('radio(forCont)', function(data){
                                                // console.log(data.elem); //得到radio原始DOM对象
                                                // console.log(data.value); //被点击的radio的value值
                                                if(data.value==1){
                                                    $("#xbshr").hide();
                                                }else{
                                                    $("#xbshr").show();
                                                }
                                            });  
                                        }
                                    })
                                    // 审核确认
                                    $("#ApprovalAdd .appOk").off("click").on("click",function(){
                                        var content = $("#appDacText").val();
                                        var isAgree = $("#approvalNo").find(" input[name='approvalYn']:checked").val();
                                        var nextApproval = $("#NextStep").val();
                                        // console.log(data.hire_id,data.approval_result,isAgree)
                                        if(content==''){
                                            layer.msg("意见不能为空!");
                                            return false
                                        }
                                        $.fetch({
                                            url:"/gateway/demission/approval",
                                            type: 'post',
                                            data:{
                                                demissionId: data.id,
                                                trueStep: rs.step,
                                                nextApprovalUid:nextApproval,
                                                approvalResult:isAgree,
                                                approvalContent:content,
                                            },
                                            cb:function(rs){
                                                layer.closeAll();
                                                layer.msg("审批完成");
                                            table.reload('ResigTable')
                                            }
                                        })
                                
                                    })
                                        form.render();
                                    }
                        
                                }
                        })
                }else if(data.approval_result==0&&data.nextStep==7){
                            var htmlS = '<div class="layui-card">'
                                        +'<div class="reviewCont layui-card-body">'
                                            +'<div class="layui-form" action="">'
                                                +'<div class="layui-form-item">'
                                                    +'<label class="layui-form-label">审批意见：</label>'
                                                    +'<div class="layui-input-block">'
                                                        +'<textarea id="appDacText" name="suggestion" class="layui-textarea" cols="50" rows="4" ></textarea>'
                                                    +'</div>'
                                                +'</div>'
                                                +'<div class="layui-form-item" id="approvalNo">'
                                                    +'<label class="layui-form-label">是否同意：</label>'
                                                    +'<div class="layui-input-block">'
                                                        +'<input type="radio" name="approvalYn" value="2" title="同意">'
                                                        +'<input type="radio" name="approvalYn" value="1" title="不同意" checked>'
                                                    +'</div>'
                                                +'</div>'
                                                +uploadInstHtml
                                                +'<div class="layui-form-item">'
                                                    +'<div class="layui-input-block">'
                                                        +' <button class="appOk layui-btn" data-item="'+data.id+'">确认</button>'
                                                         +' <button class="layui-btn layui-btn-primary" id="closeId">关闭</button>'
                                                    +'</div>'
                                                +'</div>'
                                            +'</div>'
                                        +'</div>'
                                    +'</div>'
                            layer.open({
                                title:'离职审批',
                                type: 1, 
                                content:htmlS,
                                id:'ApprovalAdd',
                                area:['60%', 'auto'],
                                success:function(layero,index){
                                    // console.log(data);//id 
                                    $("#closeId").on("click",function(){
                                        layer.close(index)
                                    })

                                    var financialObj = { //保存财务相关数据的对象
                                        finaFiles: [], //附件id数组
                                    }
                                    //执行实例
                                    var uploadInst = upload.render({
                                        elem: '#test1' //绑定元素
                                        ,url: window.urls +'/gateway/demissionAttach/add' //上传接口
                                        ,accept:"file"
                                        ,data:{
                                            DemissionID:data.id
                                        }
                                        ,before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                                            layer.load(); //上传loading
                                        }
                                        ,done: function(res){
                                            //上传完毕回调
                                            layer.closeAll('loading'); //关闭loading
                                            $("#finaFiles").append('<a><span class="currentName">' + res.data.attachName + '</span><i data-file="' + res.data.attachId + '" class="del iconfont icon-guanbi"></i></a>')
                                            financialObj.finaFiles.push(res.data.attachId);
                                        }
                                        ,error: function(){
                                            //请求异常回调
                                            layer.closeAll('loading');
                                        }
                                    });
                                    $(".reviewCont").on("click", 'i.del', function () { //删除附件
                                        var delId = $(this).attr("data-file");
                                        var elem = $(this).parent("a");
                                        //layer.load();
                                        $.fetch({
                                            url: '/gateway/demissionAttach/del',
                                            type: 'post',
                                            data: {
                                                demissionId:data.id,
                                                attachId: delId
                                            },
                                            cb: function (rs) {
                                                financialObj.finaFiles.splice($.inArray(delId, financialObj.finaFiles), 1);
                                                elem.remove();
                                            }
                                        });
                                    })
                                }
                            })
                            // 审核确认
                            $("#ApprovalAdd .appOk").off("click").on("click",function(){
                                var content = $("#appDacText").val();
                                var isAgree = $("#approvalNo").find(" input[name='approvalYn']:checked").val();
                                // console.log(data.hire_id,data.approval_result,isAgree)
                                if(content==''){
                                    layer.msg("意见不能为空!");
                                    return false
                                }
                                $.fetch({
                                    url:"/gateway/demission/approval",
                                    type: 'post',
                                    data:{
                                        demissionId: data.id,
                                        trueStep: 6,
                                        nextApprovalUid:-1,
                                        approvalResult:isAgree,
                                        approvalContent:content,
                                    },
                                    cb:function(rs){
                                        layer.closeAll();
                                        layer.msg("审批完成");
                                    table.reload('ResigTable')
                                    }
                                })
                            
                            })
                            form.render();
                        }
            }else if(layEvent =='apprCanel'){
                 var htmlS = '<div class="layui-fluid">'
                             +'<div class="reviewCont layui-card-body">'
                                 +'<div class="layui-form" action="">'
                                     +'<div class="layui-form-item">'
                                         +'<label class="layui-form-label">撤销原因：</label>'
                                         +'<div class="layui-block" style="padding:9px 0;">'
                                             +data.cancel_cause
                                         +'</div>'
                                     +'</div>'
                                     +'<div class="layui-form-item">'
                                         +'<label class="layui-form-label">审批意见：</label>'
                                         +'<div class="layui-input-block">'
                                             +'<textarea id="appDacText" name="suggestion" class="layui-textarea" cols="50" rows="4" ></textarea>'
                                         +'</div>'
                                     +'</div>'
                                     +'<div class="layui-form-item" id="approvalNo">'
                                         +'<label class="layui-form-label">是否同意：</label>'
                                         +'<div class="layui-input-block">'
                                             +'<input type="radio" name="approvalYn" value="2" title="同意">'
                                             +'<input type="radio" name="approvalYn" value="1" title="不同意" checked>'
                                         +'</div>'
                                     +'</div>'
                                    +'<div class="layui-form-item" id="">'
                                        +'<label class="layui-form-label">附件：</label>'
                                        +'<div class="layui-input-block">'
                                            +'<button type="button" class="layui-btn" id="test1">'
                                                +'<i class="layui-icon">&#xe67c;</i>上传'
                                            +'</button>'
                                            +'<div id="finaFiles" class="UploadNames-box UploadFl layui-input-lineHeight"></div>'
                                        +'</div>'
                                    +'</div>'
                                     +'<div class="layui-form-item">'
                                         +'<div class="layui-input-block">'
                                             +' <button class="appOk layui-btn" data-item="'+data.id+'">确认</button>'
                                         +'</div>'
                                     +'</div>'
                                 +'</div>'
                             +'</div>'
                         +'</div>'
                    layer.open({
                        title:'离职审批',
                        type: 1, 
                        content:htmlS,
                        id:'ApprovalAdd',
                        area:['60%', 'auto'],
                        success:function(layero,index){

                            var financialObj = { //保存财务相关数据的对象
                                finaFiles: [], //附件id数组
                            }
                            //执行实例
                            var uploadInst = upload.render({
                                elem: '#test1' //绑定元素
                                ,url: window.urls +'/gateway/demissionAttach/add' //上传接口
                                ,accept:"file"
                                ,data:{
                                    DemissionID:data.id
                                }
                                ,before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                                    layer.load(); //上传loading
                                }
                                ,done: function(res){
                                    //上传完毕回调
                                    layer.closeAll('loading'); //关闭loading
                                    $("#finaFiles").append('<a><span class="currentName">' + res.data.attachName + '</span><i data-file="' + res.data.attachId + '" class="del iconfont icon-guanbi"></i></a>')
                                    financialObj.finaFiles.push(res.data.attachId);
                                }
                                ,error: function(){
                                    //请求异常回调
                                    layer.closeAll('loading');
                                }
                            });
                            $(".reviewCont").on("click", 'i.del', function () { //删除附件
                                var delId = $(this).attr("data-file");
                                var elem = $(this).parent("a");
                                //layer.load();
                                $.fetch({
                                    url: '/gateway/demissionAttach/del',
                                    type: 'post',
                                    data: {
                                        demissionId:data.id,
                                        attachId: delId
                                    },
                                    cb: function (rs) {
                                        financialObj.finaFiles.splice($.inArray(delId, financialObj.finaFiles), 1);
                                        elem.remove();
                                    }
                                });
                            })
                            // 审核确认
                            $("#ApprovalAdd .appOk").off("click").on("click",function(){
                                var content = $("#appDacText").val();
                                var isAgree = $("#approvalNo").find(" input[name='approvalYn']:checked").val();
                                // console.log(data.hire_id,data.approval_result,isAgree)
                                if(content==''){
                                    layer.msg("意见不能为空!");
                                    return false
                                }
                                $.fetch({
                                    url:"/gateway/demission/doCancel",
                                    type: 'post',
                                    data:{
                                        demissionId: data.id,
                                        approvalResult:isAgree,
                                        approvalContent:content,
                                    },
                                    cb:function(rs){
                                        layer.close(index);
                                        layer.msg("审批完成");
                                        table.reload('ResigTable')
                                    }
                                })
                            
                            })
                            form.render();

                        }
                    })
            }

        }) 
        
    })
</script>

</html>