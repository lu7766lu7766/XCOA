<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>考勤审核</title>
<link rel="stylesheet" type="text/css" href="../../css/iconFont/iconfont.css">

<link rel="stylesheet" type="text/css" href="../../layui/css/layui.css">
<link rel="stylesheet" type="text/css" href="../../layui/css/admin.css">
<script src="../../js/jquery.min.js"></script>
<script src="../../js/bootstrap.min.js"></script>
<script src="../../js/common.js?0.1"  type="text/javascript"></script>
</head>
<body layadmin-themealias="default">
    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-tab layui-tab-brief" lay-filter="approval-tabs-brief">
                <ul class="layui-tab-title">
                    <li class="layui-this"  lay-id="1" ><i class="iconfont icon-suyaniconchanpinleibufenzuodaohangbufen87"></i>请假知悉</li>
                    <li  lay-id="2" ><i class="iconfont icon-suyaniconchanpinleibufenzuodaohangbufen87"></i>外出知悉</li>
                    <li  lay-id="3" ><i class="iconfont icon-suyaniconchanpinleibufenzuodaohangbufen87"></i>加班知悉</li>
                    <li  lay-id="4" ><i class="iconfont icon-suyaniconchanpinleibufenzuodaohangbufen87"></i>考勤补录知悉</li>
                </ul>
                <div class="layui-tab-content" id="approvalAll">
                    <!-- 请假 -->
                    <div class="layui-tab-item layui-show">
                        <div class="tab-pane Character modify-table-cell active" id="leaveAppr">
                            <div class="layui-form">
                                <div class="layui-form-item">
                                    
                                    <!-- <div class="layui-inline">
                                        <label class="layui-form-label">状态：</label>
                                        <div class="layui-input-block">
                                            <select name="leaveSelect" id="leaveSelect" lay-filter="leaveSelect">
                                                <option value="">全部</option>
                                                <option value="0">待知悉</option>
                                                <option value="1">不通过</option>
                                                <option value="2">已通过</option>
                                            </select>
                                        </div>
                                    </div> -->
                                    <div class="layui-inline">
                                        <label class="layui-form-label">用户名：</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="SurveyTit">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label">开始时间：</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="leaveStartItem" id="leaveStartItem" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label">结束时间：</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="leaveEndItem" id="leaveEndItem" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <button id="InquireSur" class="layui-btn" lay-event="InquireSur" title="查询"><i class="iconfont icon-sousuo"></i></button>
                                        <button id="InquireSurBack" class="layui-btn layui-btn-primary" style="display:none;"  lay-event="InquireSurBack">返回</button>
                                    </div>
                                </div>
                            </div>
                            <table class="layui-hide" id="leaveTable" lay-filter="leaveTable"></table>
                        </div>
                    </div>
                    <!-- 外出 -->
                    <div class="layui-tab-item">
                        <div class="tab-pane modify-table-cell Character" id="outgoAppr">
                            <div class="reviewCont">
                            </div>
                            <div class="layui-form">
                                <div class="layui-form-item">
                                    <!-- <div class="layui-inline">
                                        <label class="layui-form-label">状态：</label>
                                        <div class="layui-input-block">
                                            <select name="outgoSelect" id="outgoSelect" lay-filter="outgoSelect">
                                                <option value="">全部</option>
                                                <option value="0">待审批</option>
                                                <option value="1">不通过</option>
                                                <option value="2">已通过</option>
                                            </select>
                                        </div>
                                    </div> -->
                                    <div class="layui-inline">
                                        <label class="layui-form-label">用户名：</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="outgoTit">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label">开始时间：</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="outgoStartItem" id="outgoStartItem" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label">结束时间：</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="outgoEndItem" id="outgoEndItem" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <button id="outgoSur" class="layui-btn" lay-event="outgoSur" title="查询"><i class="iconfont icon-sousuo"></i></button>
                                        <button id="outgoSurBack" class="layui-btn layui-btn-primary" style="display:none;"  lay-event="outgoSurBack">返回</button>
                                    </div>
                                </div>
                            </div>
                            <table class="layui-hide" id="outgoTable" lay-filter="outgoTable"></table>
                        </div>
                    </div>
                    <!-- 加班 -->
                    <div class="layui-tab-item">
                        <div class="tab-pane modify-table-cell Character" id="overTimeAppr">
                            <div class="reviewCont">
                            </div>
                            <div class="layui-form">
                                <div class="layui-form-item">                                
                                    <!-- <div class="layui-inline">
                                        <label class="layui-form-label">状态：</label>
                                        <div class="layui-input-block">
                                            <select name="overTimeSelect" id="overTimeSelect" lay-filter="overTimeSelect">
                                                <option value="">全部</option>
                                                <option value="0">待审批</option>
                                                <option value="1">不通过</option>
                                                <option value="2">已通过</option>
                                            </select>
                                        </div>
                                    </div> -->
                                    <div class="layui-inline">
                                        <label class="layui-form-label">用户名：</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="overTimeTit">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label">开始时间：</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="overTimeStartItem" id="overTimeStartItem" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label">结束时间：</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="overTimeEndItem" id="overTimeEndItem" class="layui-input">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <button id="overTime" class="layui-btn" lay-event="overTime" title="查询"><i class="iconfont icon-sousuo"></i></button>
                                        <button id="overTimeBack" class="layui-btn layui-btn-primary" style="display:none;"  lay-event="overTimeBack">返回</button>
                                    </div>
                                </div>
                            </div>
                            <table class="layui-hide" id="overTimeTable" lay-filter="overTimeTable"></table>
                        </div>
                    </div>
                    <!-- 考勤补录 -->
                    <div class="layui-tab-item">
                        <div class="tab-pane modify-table-cell Character" id="danceAppr">
                            <div class="reviewCont">
                            </div>
                            <div class="layui-form">
                                <div class="layui-form-item">                                                                
                                    <!-- <div class="layui-inline">
                                        <label class="layui-form-label">状态：</label>
                                        <div class="layui-input-block">
                                            <select name="danceSelect" id="danceSelect" lay-filter="danceSelect">
                                                <option value="">全部</option>
                                                <option value="0">待审批</option>
                                                <option value="1">不通过</option>
                                                <option value="2">已通过</option>
                                            </select>
                                        </div>
                                    </div> -->
                                    <div class="layui-inline">
                                        <label class="layui-form-label">用户名：</label>
                                        <div class="layui-input-block">
                                            <input type="text" class="layui-input" id="danceTit">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                            <label class="layui-form-label">开始时间：</label>
                                            <div class="layui-input-inline">
                                                <input type="text" name="danceStartItem" id="danceStartItem" class="layui-input">
                                            </div>
                                        </div>
                                        <div class="layui-inline">
                                            <label class="layui-form-label">结束时间：</label>
                                            <div class="layui-input-inline">
                                                <input type="text" name="danceEndItem" id="danceEndItem" class="layui-input">
                                            </div>
                                        </div>
                                    <div class="layui-inline">
                                        <button id="danceSur" class="layui-btn" lay-event="danceSur" title="查询"><i class="iconfont icon-sousuo"></i></button>
                                        <button id="danceSurBack" class="layui-btn layui-btn-primary" style="display:none;"  lay-event="danceSurBack">返回</button>
                                    </div>
                                </div>
                            </div>
                            <table class="layui-hide" id="danceTable" lay-filter="danceTable"></table>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</body>
<script src="../../layui/layui.js"></script>
<script>
    //审批

$(function(){
    layui.config({
		base: '../../../layui/' //静态资源所在路径
	}).extend({
		index: 'index' //主入口模块
	}).use(['index','form','laypage','table','laydate'], function(){
        var $ = layui.$
        ,admin = layui.admin
        ,element = layui.element
        ,router = layui.router();
        element.render();
        var laydate = layui.laydate;
        var leavetypes;
        var popUrl,forwardUrl
            ,form = layui.form
            ,layer = layui.layer
            ,laypage = layui.laypage
            ,table=layui.table;

        
        laydate.render({ 
            elem: '#danceStartItem'
            ,type: 'datetime'
        });
        laydate.render({ 
            elem: '#danceEndItem'
            ,type: 'datetime'
        });

         laydate.render({ 
            elem: '#overTimeStartItem'
            ,type: 'datetime'
        });
        laydate.render({ 
            elem: '#overTimeEndItem'
            ,type: 'datetime'
        });

        laydate.render({ 
            elem: '#outgoStartItem'
            ,type: 'datetime'
        });
        laydate.render({ 
            elem: '#outgoEndItem'
            ,type: 'datetime'
        });

        laydate.render({ 
            elem: '#leaveStartItem'
            ,type: 'datetime'
        });
        laydate.render({ 
            elem: '#leaveEndItem'
            ,type: 'datetime'
        });
        // var layid = location.hash.replace(/^?test1=/, '');
        // //console.log(location.href.split('?tab='))
        // var tabId=location.href.split('?tab=')[1]?location.href.split('?tab=')[1]:false;
        var urlTab = location.href.split('?tab=')[1]?location.href.split('?tab=')[1]:false;
        var tabId=urlTab?urlTab.split('?')[0]:false;

        var dataId = location.href.split('?id=')[1]?location.href.split('?id=')[1]:false;
        if(dataId){
            if(tabId==1){
                var tableSub0={
                    ID:dataId
                }
            }
            if(tabId==2){
                var tableSub1={
                    ID:dataId
                }
            }
            if(tabId==3){
                var tableSub2={
                    ID:dataId
                }
            }
            if(tabId==4){
                var tableSub3={
                    ID:dataId
                }
            }
        }else{
            var tableSub0={}
            var tableSub1={}
            var tableSub2={}
            var tableSub3={}
        }
        // var dataId=urlTab?urlTab.split('?')[1]:false;
        // dataId=dataId?dataId.split('id=')[1]:false;

        // //console.log(tabId)
    
    // 修正浮动栏高度
    // @param tableElem 表格显示div
    function autoFixed(tableElem) {
        var $tableView = tableElem || $(".layui-table-view");
        var dataIndex ,trHeight;
        $tableView.each(function() {
            // 获取两侧浮动栏
            var $fixed = $(this).find(".layui-table-fixed");
            // 同步表头高度
            $fixed.find(".layui-table-header tr").height($(this).find(".layui-table-header tr").eq(0).height());
            // 遍历tr 修正浮动栏行高
            $(this).find(".layui-table-main tr").each(function() {
                dataIndex = $(this).attr("data-index");
                trHeight = $(this).css("height");
                $fixed.find("tr[data-index=" + dataIndex + "]").css("height", trHeight);
            })
        });
    }
    // 监听浏览器窗口大小变化
    var resizeTimer;
    $(window).resize(function() {
        if (resizeTimer) {
            clearTimeout(resizeTimer);
        }
        resizeTimer = setTimeout(function() {
            resizeTimer = null;
            autoFixed();
        },
        200);
    });

    // 监听表头鼠标按下事件
    $(document).on('mousedown', 'thead',
    function(e) {
        var that = $(this);
        $(document).one('mouseup',
        function() {
            autoFixed(that.parents('.layui-table-view'));
        })
    });
       
     
    //请假
    var leaveTable
    
    // 弹窗

    table.on('tool(leaveTable)', function (obj) {
        var tdata = obj.data; //获得当前行数据
        var layEvent = obj.event;
        if(layEvent=="Approval"){
            layer.confirm('确定知悉?',{title:' '}, function(indexs){
            //do something
                $.fetch({
                    url:"/gateway/attend/updateattendinform",
                    type: 'post',
                    data:{
                        ID:tdata.id,
                        DataType:forwardUrl,
                    },
                    cb:function(rs){
                        layer.close(indexs);
                        leaveTable.reload({
                            where:{
                                ID:'',
                            },
                            page: {
                                curr: 1 //重新从第 1 页开始
                            }
                            ,done:function(data){
                                for(var i =0; i<data.data.length; i++){
                                    if(data.data[i].can_approval==true){
                                        $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                                    }else{
                                        $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                                    }
                                    
                                }
                                form.render();
                            },
                        });
                    }
                })
            });    
        }else if(layEvent=="detail"){
            // //console.log("请假",tdata)
            $.fetch({ //默认打开显示未审批
                url: "/gateway/userleave/attachlist",
                type: 'post',
                data: {
                    LeaveApplyID: tdata.item_id,
                },
                cb: function (rs) {
                    // //console.log(rs);
                    var attach='暂无附件';
                    if(rs&&rs.length>0){
                        attach='';
                        for(var i=0;i<rs.length;i++){
                            attach+='<a title="点击下载" class="seeXqOutIn" target="_blank" href="/gateway/userleave/download/'+rs[i].id+'" >'+rs[i].original_name+'</a>'
                        }
                    }
                    var histry = '';
                    if (tdata.approval_history.length > 0) {
                        for (var k = 0; k < tdata.approval_history.length; k++) {
                            var res = '';
                            var classList = '';
                            if (tdata.approval_history[k].is_forward == 1) { //是转发的
                                res = '--转发-->';

                                histry += '<p>【' + tdata.approval_history[k].username + '' + res + '' + tdata.approval_history[k].forward_username + '' //名字
                                    //意见

                                    +
                                    '<em class=' + classList + '> ' +
                                    tdata.approval_history[k].approval_time + '</em>】：<span class="list" title=' + tdata.approval_history[k].content + '>' //时间
                                    +
                                    tdata.approval_history[k].content + '</p>' //意见内容

                            } else { //是审批的

                                if (tdata.approval_history[k].approval_result == 1) {
                                    res = '未通过';
                                    classList = "red";
                                } else if (tdata.approval_history[k].approval_result == 2) {
                                    res = '已通过';
                                    classList = "green";
                                }

                                histry += '<p>【' + tdata.approval_history[k].username + '<em class=' + classList + '>' //名字
                                    +
                                    res + '' //意见
                                    +
                                    tdata.approval_history[k].approval_time + '</em>】：<span class="list" title=' + tdata.approval_history[k].content + '>' //时间
                                    +
                                    tdata.approval_history[k].content + '</p>' //意见内容
                            }
                        }
                    } else {
                        histry = "暂无审批记录"
                    }
                    var Aware=''
                    if(tdata.status==0){
                        Aware+='<div class="layui-form-item" style="width: 170px;">'
                            // +'<div class="layui-form-label">确定知悉?</div>'
                            +'<div class="layui-layer-btn layui-layer-btn-">'
                                +'<a class="layui-layer-btn0 determine">知悉</a>'
                                +'<a class="layui-layer-btn1 cancel">返回</a>'
                            +'</div>'
                        +'</div>'
                    }

                    var htmls ='<div class="layui-card" style="min-height:300px">'
                        +'<div class="layui-card-body">'
                                +'<div class="reviewCont layui-card-body layui-form">'
                                    +'<div class="layui-form-item">'
                                        +'<div class="layui-inline">'
                                            +'<label class="layui-form-label">申请人：</label>'
                                            +'<div class="layui-input-inline cateID">'
                                                +'<span>'+tdata.apply_user_name+'</span>'
                                            +'</div>'
                                        +'</div>'
                                        +'<div class="layui-inline">'
                                            +'<label class="layui-form-label">申请时间：</label>'
                                            +'<div class="layui-input-inline cateID">'
                                                +'<span>'+tdata.apply_time+'</span>'
                                            +'</div>'
                                        +'</div>'

                                        +'<div class="layui-inline">'
                                            +'<label class="layui-form-label">请假类型：</label>'
                                            +'<div class="layui-input-inline cateID">'
                                                +'<span>'+leavetypes[tdata.leave_type]+''+(tdata.is_cancel==1?'(取消申请)':'')+'</span>'
                                            +'</div>'
                                        +'</div>'
                                        
                                    +'</div>'
                                    +'<div class="layui-form-item">'
                                        +'<label class="layui-form-label">请假时长：</label>'
                                        +'<div class="layui-input-block cateID ">'
                                            +'<span>'+$.diffTime(tdata.start_time,tdata.end_time)+'</span>'
                                        +'</div>'
                                    +'</div>'
                                    +'<div class="layui-form-item">'
                                        +'<label class="layui-form-label">请假时间：</label>'
                                        +'<div class="layui-input-block cateID ">'
                                            +'<span>'+tdata.start_time+'~'+tdata.end_time+'</span>'
                                        +'</div>'
                                    +'</div>'
                                    +'<div class="layui-form-item">'
                                        +'<label class="layui-form-label">请假原因：</label>'
                                        +'<div class="layui-input-block cateID">'
                                            +'<span>'+tdata.content+'</span>'
                                        +'</div>'
                                    +'</div>'
                                    // +'<div class="layui-form-item">'
                                    //     +'<label class="layui-form-label">状态：</label>'
                                    //     +'<div class="layui-input-block cateID">'
                                    //         +'<span>'+tdata.apply_result_desc +' '+(tdata.is_cancel==1?'<span class="green">(取消请假申请)</span>':'')+'</span>'
                                    //     +'</div>'
                                    // +'</div>'
                                +'</div>'
                                +'<fieldset class="layui-elem-field">'
                                    +'<legend>附件</legend>'
                                    +'<div class="layui-field-box">'+attach+'</div>'
                                +'</fieldset>'
                                +'<fieldset class="layui-elem-field">'
                                    +'<legend>审批历史</legend>'
                                    +'<div class="layui-field-box">'+histry+'</div>'
                                +'</fieldset>'
                                +Aware
                            +'</div>'
                            +'</div>'
                            //
                            
                    layer.open({
                        type: 1,
                        title: "请假详情",
                        area: ['auto'],
                        id:'',
                        content: htmls,
                        success:function(layero,index){
                            $(".determine").on('click',function(){
                                layer.confirm('确定知悉?',{title:' '}, function(indexs){
                                //do something
                                    $.fetch({
                                        url:"/gateway/attend/updateattendinform",
                                        type: 'post',
                                        data:{
                                            ID:tdata.id,
                                            DataType:forwardUrl,
                                        },
                                        cb:function(rs){
                                            layer.close(indexs);
                                            leaveTable.reload({
                                                where:{
                                                    ID:'',
                                                },
                                                page: {
                                                    curr: 1 //重新从第 1 页开始
                                                }
                                                ,done:function(data){
                                                    for(var i =0; i<data.data.length; i++){
                                                        if(data.data[i].can_approval==true){
                                                            $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                                                        }else{
                                                            $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                                                        }
                                                        
                                                    }
                                                    form.render();
                                                },
                                            });
                                        }
                                    })
                                });   
                            })
                            $('.cancel').on('click',function(){
                                layer.close(index);
                            })
                        },
                    })

                }
            })
								
        }
    })
    // 筛选
    $("#InquireSur").on("click",function(){
        var UserName = $("#SurveyTit").val();
        // var ApprovalResult = $("#leaveSelect").val();
        var  leaveEndItem = $("#leaveEndItem").val();
        var  leaveStartItem = $("#leaveStartItem").val();
  
        leaveTable.reload({
            where: {//记录搜索状态
                // ApprovalResult:ApprovalResult,
                ID:'',
                UserName: UserName,
                StartTime:leaveStartItem,
                EndTime:leaveEndItem,
            },
            page: {
                curr: 1 //重新从第 1 页开始
            }
            ,done:function(data){
                for(var i =0; i<data.data.length; i++){
                    if(data.data[i].can_approval==true){
                        $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                    }else{
                        $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                    }
                        
                }
                form.render();
            },
        });
        if (UserName !== "" || ApprovalResult !== "") {
            $("#InquireSurBack").css('display', 'inline-block');
        } else {
            $("#InquireSurBack").css('display', 'none');
        }
    })
    // 返回
    $("#InquireSurBack").on("click",function(){
        leaveTable.reload({
            where:{
                ID:'',
            },
            page: {
                curr: 1 //重新从第 1 页开始
            }
            ,done:function(data){
                for(var i =0; i<data.data.length; i++){
                     if(data.data[i].can_approval==true){
                        $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                    }else{
                        $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                    }
                 
                }
                form.render();
            },
        });
        $("#InquireSurBack").css('display', 'none');
    })
    // 外出
    var outgoTableFun=function(){
        var outgoTable = table.render({
            elem: '#outgoTable'
            ,url:urls+'/gateway/goout/informlist'
            ,contentType: 'application/json',
            content: '<div class="layui-card"><div class="layui-card-body layui-form modify-table-cell"><table lay-filter="overtime-History-table" class="layui-table" id="overtime-History-table"></table></div></div>',
            method: 'post',
            where:tableSub1,

            page: true, //开启分页
            // limits:false,
            limits:[10,20,30,40,50,60,70,80,90,100,200,500,1000,5000],
            toolbar:false,
            loading: true,
            toolbar: '',
            defaultToolbar: ''
            ,text: {
                none: '暂无数据' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
            }
            ,cols: [[
            {field:'depatment_name', minWidth:100, title: '部门'}
            ,{field:'apply_user_name', minWidth:80, title: '姓名'}
            ,{field:'start_time', minWidth:160, title: '开始时间'}
            ,{field:'end_time', title: '结束时间', minWidth: 160}
            ,{
                field:'experience', 
                minWidth:120, 
                title: '外出类型',
                templet:function(d){
                    var expCont = d.go_out_type==2?'出差':'外出';
                    return expCont+' '+(d.is_cancel==1?'<span class="green">(取消中)</span>':d.is_cancel==2?'<span class="green">(已取消)</span>':'')
                }
            }
            ,{field:'location', minWidth:120, title: '外出地点'}
            ,{field:'apply_time', minWidth:160, title: '申请时间'}
            ,{
                field:'content', 
                minWidth:120, 
                title: '外出原因',
            }
            ,{
                field:'approval_history', 
                minWidth:320, 
                title: '审批意见',
                templet:function(d){
                    var yj='';
                    if(d.approval_history.length==0){
                        yj ='暂无';
                    }else{
                        for(var k=0;k< d.approval_history.length;k++){
                            var res='';
                            var classList = '';
                            if(d.approval_history[k].is_forward ==1){//是转发的
                                res ='--转发-->';
                                yj+='<p>【'+d.approval_history[k].username+''+res+ ''+d.approval_history[k].forward_username+''//名字
                                                //意见
                                        +'<em class='+classList+'> ' +d.approval_history[k].approval_time+'</em>】：'//时间
                                            +d.approval_history[k].content+'</p>'//意见内容

                            }else{//是审批的
                                if(d.approval_history[k].approval_result==1){
                                    res ="未批准";
                                    classList = "red";
                                }else if(d.approval_history[k].approval_result==2){
                                    res ="已批准";
                                    classList = 'green';
                                }
                                yj+='<p><span> 【'+d.approval_history[k].username +'<em class='+classList+'>'+res+' '+d.approval_history[k].approval_time+'</em>'+'】</span>'+d.approval_history[k].content+'</p>'
                        
                            };
                        }
                    }
                    return yj
                }
            }
            ,{
                field:'apply_time', 
                fixed: 'right',
                minWidth:140, 
                title: '操作',
                templet:function(d){
                    var ss=(d.status==0?'<a class="layui-btn layui-btn-xs" lay-event="Approval">知悉</a>':'<a class="layui-btn layui-btn-xs layui-btn-disabled">知悉</a>')
                    +'<a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>'
                    return ss;
                }
            }

            ]],
                request: {
                pageName: 'currentIndex' //页码的参数名称，默认：page
                    ,
                limitName: 'pageSize' //每页数据量的参数名，默认：limit
            },
            parseData: function (res) { //res 即为原始返回的数据
                return {
                    "status_code": res.status_code, //解析接口状态
                    "message": res.message, //解析提示文本
                    "count": res.data.total_count, //解析数据长度
                    "data": res.data.data_list, //解析数据列表
                    "curr": res.data.page_index
                };
            },
            done:function(data){
                for(var i =0; i<data.data.length; i++){
                    if(data.data[i].can_approval==true){
                        $("#outgoAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                    }else{
                        $("#outgoAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                    }
                    
                }
                form.render();
                if(tableSub1&&tableSub1.ID&&this.where.ID!=''){
                    $('div#outgoAppr .layui-table-body.layui-table-main a[lay-event="detail"]').click();
                }
                autoFixed($(this.elem[0]).next());
            }
        })
        // 弹窗
        table.on('tool(outgoTable)', function (obj) {
            var tdata = obj.data; //获得当前行数据
            var layEvent = obj.event;
            //console.log(layEvent)
                var tdata = obj.data; //获得当前行数据
                var layEvent = obj.event;
                if(layEvent=="Approval"){
                    layer.confirm('确定知悉?',{title:' '}, function(index){
                    //do something
                        $.fetch({
                            url:"/gateway/attend/updateattendinform",
                            type: 'post',
                            data:{
                                ID:tdata.id,
                                DataType:forwardUrl,
                            },
                            cb:function(rs){
                                layer.close(index);
                                outgoTable.reload({
                                    where:{ID:'',},
                                    page: {
                                        curr: 1 //重新从第 1 页开始
                                    }

                                    ,done:function(data){
                                        for(var i =0; i<data.data.length; i++){
                                            if(data.data[i].can_approval==true){
                                                $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                                            }else{
                                                $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                                            }
                                            
                                        }
                                        form.render();
                                    },
                                });
                            }
                        })
                    });    
                }else if(layEvent=="detail"){
                    // //console.log("外出",tdata)
                    var histry = '';
                    if (tdata.approval_history.length > 0) {
                        for (var k = 0; k < tdata.approval_history.length; k++) {
                            var res = '';
                            var classList = '';
                            if (tdata.approval_history[k].is_forward == 1) { //是转发的
                                res = '--转发-->';

                                histry += '<p>【' + tdata.approval_history[k].username + '' + res + '' + tdata.approval_history[k].forward_username + '' //名字
                                    //意见

                                    +
                                    '<em class=' + classList + '> ' +
                                    tdata.approval_history[k].approval_time + '</em>】：<span class="list" title=' + tdata.approval_history[k].content + '>' //时间
                                    +
                                    tdata.approval_history[k].content + '</p>' //意见内容

                            } else { //是审批的

                                if (tdata.approval_history[k].approval_result == 1) {
                                    res = '未通过';
                                    classList = "red";
                                } else if (tdata.approval_history[k].approval_result == 2) {
                                    res = '已通过';
                                    classList = "green";
                                }

                                histry += '<p>【' + tdata.approval_history[k].username + '<em class=' + classList + '>' //名字
                                    +
                                    res + '' //意见
                                    +
                                    tdata.approval_history[k].approval_time + '</em>】：<span class="list" title=' + tdata.approval_history[k].content + '>' //时间
                                    +
                                    tdata.approval_history[k].content + '</p>' //意见内容
                            }
                        }
                    } else {
                        histry = "暂无审批记录"
                    }
                    var Aware=''
                    if(tdata.status==0){
                        Aware+='<div class="layui-form-item" style="width: 170px;">'
                            // +'<div class="layui-form-label">确定知悉?</div>'
                            +'<div class="layui-layer-btn layui-layer-btn-">'
                                +'<a class="layui-layer-btn0 determine">知悉</a>'
                                +'<a class="layui-layer-btn1 cancel">返回</a>'
                            +'</div>'
                        +'</div>'
                    }
                    var htmls ='<div class="layui-card" style="min-height:300px">'
                        +'<div class="layui-card-body">'
                                +'<div class="reviewCont layui-card-body layui-form">'
                                    +'<div class="layui-form-item">'
                                        +'<div class="layui-inline">'
                                            +'<label class="layui-form-label">申请人：</label>'
                                            +'<div class="layui-input-inline cateID">'
                                                +'<span>'+tdata.apply_user_name+'</span>'
                                            +'</div>'
                                        +'</div>'
                                        +'<div class="layui-inline">'
                                            +'<label class="layui-form-label">申请时间：</label>'
                                            +'<div class="layui-input-inline cateID">'
                                                +'<span>'+tdata.apply_time+'</span>'
                                            +'</div>'
                                        +'</div>'

                                        +'<div class="layui-inline">'
                                            +'<label class="layui-form-label">外出类型：</label>'
                                            +'<div class="layui-input-inline cateID">'
                                                +'<span>'+tdata.go_out_type_desc+'</span>'
                                            +'</div>'
                                        +'</div>'
                                        
                                    +'</div>'
                                    +'<div class="layui-form-item">'
                                        +'<label class="layui-form-label">外出时长：</label>'
                                        +'<div class="layui-input-block cateID ">'
                                            +'<span>'+$.diffTime(tdata.start_time,tdata.end_time)+' (天)</span>'
                                        +'</div>'
                                    +'</div>'
                                    +'<div class="layui-form-item">'
                                        +'<label class="layui-form-label">外出时间：</label>'
                                        +'<div class="layui-input-block cateID ">'
                                            +'<span>'+tdata.start_time+'~'+tdata.end_time+'</span>'
                                        +'</div>'
                                    +'</div>'
                                    +'<div class="layui-form-item">'
                                        +'<label class="layui-form-label">外出原因：</label>'
                                        +'<div class="layui-input-block cateID">'
                                            +'<span>'+tdata.content+'</span>'
                                        +'</div>'
                                    +'</div>'
                                    // +'<div class="layui-form-item">'
                                    //     +'<label class="layui-form-label">状态：</label>'
                                    //     +'<div class="layui-input-block cateID">'
                                    //         +'<span>'+tdata.apply_result_desc +' '+(tdata.is_cancel==1?'<span class="green">(取消请假申请)</span>':'')+'</span>'
                                    //     +'</div>'
                                    // +'</div>'
                                +'</div>'
                                +'<fieldset class="layui-elem-field">'
                                    +'<legend>审批历史</legend>'
                                    +'<div class="layui-field-box">'+histry+'</div>'
                                +'</fieldset>'
                                +Aware
                            +'</div>'
                            +'</div>'
                    layer.open({
                        type: 1,
                        title: "外出详情",
                        area: ['auto'],
                        content: htmls,
                        success:function(layero,index){
                            $(".determine").on('click',function(){
                                layer.confirm('确定知悉?',{title:' '}, function(indexs){
                                    $.fetch({
                                        url:"/gateway/attend/updateattendinform",
                                        type: 'post',
                                        data:{
                                            ID:tdata.id,
                                            DataType:forwardUrl,
                                        },
                                        cb:function(rs){
                                            layer.close(indexs);
                                            outgoTable.reload({
                                                where:{ID:'',},
                                                page: {
                                                    curr: 1 //重新从第 1 页开始
                                                }
                                                ,done:function(data){
                                                    for(var i =0; i<data.data.length; i++){
                                                        if(data.data[i].can_approval==true){
                                                            $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                                                        }else{
                                                            $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                                                        }
                                                        
                                                    }
                                                    form.render();
                                                },
                                            });
                                        }
                                    })
                                })
                            })
                            $('.cancel').on('click',function(){
                                layer.close(index);
                            })
                        }
                    })
                }
        })
        // 筛选
        $("#outgoSur").on("click",function(){
            var UserName = $("#outgoTit").val();
            // var ApprovalResult = $("#outgoSelect").val();

            var  outgoEndItem = $("#outgoEndItem").val();
            var  outgoStartItem = $("#outgoStartItem").val();
    
            outgoTable.reload({
                where: {//记录搜索状态
                    // ApprovalResult:ApprovalResult,
                    ID:'',
                    UserName: UserName,
                    StartTime:outgoStartItem,
                    EndTime:outgoEndItem,
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                ,done:function(data){
                    for(var i =0; i<data.data.length; i++){
                        if(data.data[i].can_approval==true){
                            $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                        }else{
                            $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                        }
                        
                    }
                    form.render();
                },
            });
            if (UserName !== "" || ApprovalResult !== "") {
                $("#outgoSurBack").css('display', 'inline-block');
            } else {
                $("#outgoSurBack").css('display', 'none');
            }
        })
        // 返回
        $("#outgoSurBack").on("click",function(){
            outgoTable.reload({
                where:{ID:'',},
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                ,done:function(data){
                    for(var i =0; i<data.data.length; i++){
                        if(data.data[i].can_approval==true){
                            $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                        }else{
                            $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                        }
                        
                    }
                    form.render();
                },
            });
            $("#outgoSurBack").css('display', 'none');
        })
    }
    // 加班
    var overTimeTableFun=function(){
        var overTimeTable = table.render({
            elem: '#overTimeTable'
            ,url:urls+'/gateway/overtime/informlist'
            ,contentType: 'application/json',
            content: '<div class="layui-card"><div class="layui-card-body layui-form modify-table-cell"><table lay-filter="overtime-History-table" class="layui-table" id="overtime-History-table"></table></div></div>',
            method: 'post',
            where: tableSub2,
            page: true, //开启分页
            // limits:false,
            limits:[10,20,30,40,50,60,70,80,90,100,200,500,1000,5000],
            toolbar:false,
            loading: true,
            toolbar: '',
            defaultToolbar: ''
            ,text: {
                none: '暂无数据' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
            }
            ,cols: [[
            {field:'depatment_name', minWidth:100, title: '部门'}
            ,{field:'apply_user_name', minWidth:80, title: '姓名'}
            ,{field:'start_time', minWidth:160, title: '开始时间'}
            ,{field:'end_time', title: '结束时间', minWidth: 160}
            ,{
                field:'overtime_type_desc', 
                title: '加班类型', 
                minWidth: 100,
                templet:function(d){
                    return d.overtime_type_desc+' '+(d.is_cancel==1?'<span class="green">(取消中)</span>':d.is_cancel==2?'<span class="green">(已取消)</span>':'')
                }
            }
            ,{
                field:'experience', 
                minWidth:160, 
                title: '加班时长',
                templet:function(d){
                    return $.diffTime(d.start_time,d.end_time)
                }
            }
            ,{field:'apply_time', minWidth:160, title: '申请时间'}
            ,{
                field:'content', 
                minWidth:120, 
                title: '加班原因',
            }
            ,{
                field:'approval_history', 
                minWidth:320, 
                title: '审批意见',
                templet:function(d){
                    var yj='';
                    if(d.approval_history.length==0){
                        yj ='暂无';
                    }else{
                        for(var k=0;k< d.approval_history.length;k++){
                            var res='';
                            var classList = '';
                            if(d.approval_history[k].is_forward ==1){//是转发的
                                res ='--转发-->';
                                yj+='<p>【'+d.approval_history[k].username+''+res+ ''+d.approval_history[k].forward_username+''//名字
                                                //意见
                                        +'<em class='+classList+'> ' +d.approval_history[k].approval_time+'</em>】：'//时间
                                            +d.approval_history[k].content+'</p>'//意见内容

                            }else{//是审批的
                                if(d.approval_history[k].approval_result==1){
                                    res ="未批准";
                                    classList = "red";
                                }else if(d.approval_history[k].approval_result==2){
                                    res ="已批准";
                                    classList = 'green';
                                }
                                yj+='<p><span> 【'+d.approval_history[k].username +'<em class='+classList+'>'+res+' '+d.approval_history[k].approval_time+'</em>'+'】</span>'+d.approval_history[k].content+'</p>'
                        
                            };
                        }
                    }
                    return yj
                }
            }
            ,{
                field:'apply_time', 
                fixed: 'right',
                minWidth:140, 
                title: '操作',
                templet:function(d){
                    var ss=(d.status==0?'<a class="layui-btn layui-btn-xs" lay-event="Approval">知悉</a>':'<a class="layui-btn layui-btn-xs layui-btn-disabled">知悉</a>')
                    +'<a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>'
                    return ss;
                }
            }

            ]],
            request: {
                pageName: 'currentIndex' //页码的参数名称，默认：page
                    ,
                limitName: 'pageSize' //每页数据量的参数名，默认：limit
            },
            parseData: function (res) { //res 即为原始返回的数据
                return {
                    "status_code": res.status_code, //解析接口状态
                    "message": res.message, //解析提示文本
                    "count": res.data.total_count, //解析数据长度
                    "data": res.data.data_list, //解析数据列表
                    "curr": res.data.page_index
                };
            },
            done:function(data){
                for(var i =0; i<data.data.length; i++){
                    if(data.data[i].can_approval==true){
                        $("#overTimeAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                    }else{
                        $("#overTimeAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                    }
                    
                }
                form.render();
                if(tableSub2&&tableSub2.ID&&this.where.ID!=''){
                    $('div#overTimeAppr .layui-table-body.layui-table-main a[lay-event="detail"]').click();
                }
                autoFixed($(this.elem[0]).next());
            }
        })
        // 弹窗
        table.on('tool(overTimeTable)', function (obj) {
            var tdata = obj.data; //获得当前行数据
            var layEvent = obj.event;
            //console.log(layEvent)
            if(layEvent=="Approval"){
                    layer.confirm('确定知悉?',{title:' '}, function(index){
                    //do something
                        $.fetch({
                            url:"/gateway/attend/updateattendinform",
                            type: 'post',
                            data:{
                                ID:tdata.id,
                                DataType:forwardUrl,
                            },
                            cb:function(rs){
                                layer.close(index);
                                overTimeTable.reload({
                                    where:{ID:'',},
                                    page: {
                                        curr: 1 //重新从第 1 页开始
                                    }
                                    ,done:function(data){
                                        for(var i =0; i<data.data.length; i++){
                                            if(data.data[i].can_approval==true){
                                                $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                                            }else{
                                                $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                                            }
                                            
                                        }
                                        form.render();
                                    },
                                });
                            }
                        })
                    });    
            }else if(layEvent=="detail"){
                // //console.log("加班",tdata)
                var histry = '';
                if (tdata.approval_history.length > 0) {
                    for (var k = 0; k < tdata.approval_history.length; k++) {
                        var res = '';
                        var classList = '';
                        if (tdata.approval_history[k].is_forward == 1) { //是转发的
                            res = '--转发-->';

                            histry += '<p>【' + tdata.approval_history[k].username + '' + res + '' + tdata.approval_history[k].forward_username + '' //名字
                                //意见

                                +
                                '<em class=' + classList + '> ' +
                                tdata.approval_history[k].approval_time + '</em>】：<span class="list" title=' + tdata.approval_history[k].content + '>' //时间
                                +
                                tdata.approval_history[k].content + '</p>' //意见内容

                        } else { //是审批的

                            if (tdata.approval_history[k].approval_result == 1) {
                                res = '未通过';
                                classList = "red";
                            } else if (tdata.approval_history[k].approval_result == 2) {
                                res = '已通过';
                                classList = "green";
                            }

                            histry += '<p>【' + tdata.approval_history[k].username + '<em class=' + classList + '>' //名字
                                +
                                res + '' //意见
                                +
                                tdata.approval_history[k].approval_time + '</em>】：<span class="list" title=' + tdata.approval_history[k].content + '>' //时间
                                +
                                tdata.approval_history[k].content + '</p>' //意见内容
                        }
                    }
                } else {
                    histry = "暂无审批记录"
                }
                var Aware=''
                if(tdata.status==0){
                    Aware+='<div class="layui-form-item" style="width: 170px;">'
                        // +'<div class="layui-form-label">确定知悉?</div>'
                        +'<div class="layui-layer-btn layui-layer-btn-">'
                            +'<a class="layui-layer-btn0 determine">知悉</a>'
                            +'<a class="layui-layer-btn1 cancel">返回</a>'
                        +'</div>'
                    +'</div>'
                }
                var htmls ='<div class="layui-card" style="min-height:300px">'
                    +'<div class="layui-card-body">'
                            +'<div class="reviewCont layui-card-body layui-form">'
                                +'<div class="layui-form-item">'
                                    +'<div class="layui-inline">'
                                        +'<label class="layui-form-label">申请人：</label>'
                                        +'<div class="layui-input-inline cateID">'
                                            +'<span>'+tdata.apply_user_name+'</span>'
                                        +'</div>'
                                    +'</div>'
                                    +'<div class="layui-inline">'
                                        +'<label class="layui-form-label">申请时间：</label>'
                                        +'<div class="layui-input-inline cateID">'
                                            +'<span>'+tdata.apply_time+'</span>'
                                        +'</div>'
                                    +'</div>'

                                    +'<div class="layui-inline">'
                                        +'<label class="layui-form-label">加班类型：</label>'
                                        +'<div class="layui-input-inline cateID">'
                                            +'<span>'+tdata.overtime_type_desc+'</span>'
                                        +'</div>'
                                    +'</div>'
                                    
                                +'</div>'
                                +'<div class="layui-form-item">'
                                    +'<label class="layui-form-label">加班时长：</label>'
                                    +'<div class="layui-input-block cateID ">'
                                        +'<span>'+$.diffTime(tdata.start_time,tdata.end_time)+' (天)</span>'
                                    +'</div>'
                                +'</div>'
                                +'<div class="layui-form-item">'
                                    +'<label class="layui-form-label">加班时间：</label>'
                                    +'<div class="layui-input-block cateID ">'
                                        +'<span>'+tdata.start_time+'~'+tdata.end_time+'</span>'
                                    +'</div>'
                                +'</div>'
                                +'<div class="layui-form-item">'
                                    +'<label class="layui-form-label">加班原因：</label>'
                                    +'<div class="layui-input-block cateID">'
                                        +'<span>'+tdata.content+'</span>'
                                    +'</div>'
                                +'</div>'
                                // +'<div class="layui-form-item">'
                                //     +'<label class="layui-form-label">状态：</label>'
                                //     +'<div class="layui-input-block cateID">'
                                //         +'<span>'+tdata.apply_result_desc +' '+(tdata.is_cancel==1?'<span class="green">(取消请假申请)</span>':'')+'</span>'
                                //     +'</div>'
                                // +'</div>'
                            +'</div>'
                            +'<fieldset class="layui-elem-field">'
                                +'<legend>审批历史</legend>'
                                +'<div class="layui-field-box">'+histry+'</div>'
                            +'</fieldset>'
                            +Aware
                        +'</div>'
                        +'</div>'
                layer.open({
                    type: 1,
                    title: "加班详情",
                    area: ['auto'],
                    content: htmls,
                    success:function(layero,index){
                        $(".determine").on('click',function(){
                            layer.confirm('确定知悉?',{title:' '}, function(index){
                    //do something
                                $.fetch({
                                    url:"/gateway/attend/updateattendinform",
                                    type: 'post',
                                    data:{
                                        ID:tdata.id,
                                        DataType:forwardUrl,
                                    },
                                    cb:function(rs){
                                        layer.close(index);
                                        overTimeTable.reload({
                                            where:{ID:'',},
                                            page: {
                                                curr: 1 //重新从第 1 页开始
                                            }
                                            ,done:function(data){
                                                for(var i =0; i<data.data.length; i++){
                                                    if(data.data[i].can_approval==true){
                                                        $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                                                    }else{
                                                        $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                                                    }
                                                    
                                                }
                                                form.render();
                                            },
                                        });
                                    }
                                })
                            });   
                        })
                        $('.cancel').on('click',function(){
                            layer.close(index);
                        })
                    }
                })
            }
        })
        // 筛选
        $("#overTime").on("click",function(){
            var UserName = $("#overTimeTit").val();
            // var ApprovalResult = $("#overTimeSelect").val();
            var  overTimeEndItem = $("#overTimeEndItem").val();
            var  overTimeStartItem = $("#overTimeStartItem").val();
    
            overTimeTable.reload({
                where: {//记录搜索状态
                    // ApprovalResult:ApprovalResult,
                    ID:'',
                    UserName: UserName,
                    StartTime:overTimeStartItem,
                    EndTime:overTimeEndItem,
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                ,done:function(data){
                    for(var i =0; i<data.data.length; i++){
                        if(data.data[i].can_approval==true){
                            $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                        }else{
                            $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                        }
                        
                    }
                    form.render();
                },
            });
            if (UserName !== "" || ApprovalResult !== "") {
                $("#overTimeBack").css('display', 'inline-block');
            } else {
                $("#overTimeBack").css('display', 'none');
            }
        })
        // 返回
        $("#overTimeBack").on("click",function(){
            overTimeTable.reload({
                where:{ID:'',},
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                ,done:function(data){
                    for(var i =0; i<data.data.length; i++){
                        if(data.data[i].can_approval==true){
                            $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                        }else{
                            $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                        }
                        
                    }
                    form.render();
                },
            });
            $("#overTimeBack").css('display', 'none');
        })
    }


   // 补录
    var danceTableFun=function(){
    
        var danceTable = table.render({
            elem: '#danceTable'
            ,url:urls+'/gateway/checkinoutapply/informlist'
            ,contentType: 'application/json',
            content: '<div class="layui-card"><div class="layui-card-body layui-form modify-table-cell"><table lay-filter="overtime-History-table" class="layui-table" id="overtime-History-table"></table></div></div>',
            method: 'post',
            where:tableSub3,
            page: true, //开启分页
            // limits:false,
            limits:[10,20,30,40,50,60,70,80,90,100,200,500,1000,5000],
            toolbar:false,
            loading: true,
            toolbar: '',
            defaultToolbar: ''
            ,text: {
                none: '暂无数据' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
            }
            ,cols: [[
            {field:'depatment_name', minWidth:100, title: '部门'}
            ,{field:'apply_user_name', minWidth:80, title: '姓名'}
            ,{
                field:'check_in_out_time', 
                minWidth:160, 
                title: '补录时间',
                templet:function(d){
                    var arr= d.check_in_out_time.split("|");
                    // //console.log(arr)
                    var arrHtml='';
                    for(var k=0;k<arr.length;k++){
                        arrHtml+='<p>'+arr[k]+'</p>'
                    }
                    return arrHtml
                }
            }
            ,{field:'apply_time', minWidth:160, title: '申请时间'}
            ,{field:'content', minWidth:160, title: '补录原因'}
            ,{
                field:'approval_history', 
                minWidth:320, 
                title: '审批意见',
                templet:function(d){
                    var yj='';
                    if(d.approval_history.length==0){
                        yj ='暂无';
                    }else{
                        for(var k=0;k< d.approval_history.length;k++){
                            var res='';
                            var classList = '';
                            if(d.approval_history[k].is_forward ==1){//是转发的
                                res ='--转发-->';
                                yj+='<p>【'+d.approval_history[k].username+''+res+ ''+d.approval_history[k].forward_username+''//名字
                                                //意见
                                        +'<em class='+classList+'> ' +d.approval_history[k].approval_time+'</em>】：'//时间
                                            +d.approval_history[k].content+'</p>'//意见内容

                            }else{//是审批的
                                if(d.approval_history[k].approval_result==1){
                                    res ="未批准";
                                    classList = "red";
                                }else if(d.approval_history[k].approval_result==2){
                                    res ="已批准";
                                    classList = 'green';
                                }
                                yj+='<p><span> 【'+d.approval_history[k].username +'<em class='+classList+'>'+res+' '+d.approval_history[k].approval_time+'</em>'+'】</span>'+d.approval_history[k].content+'</p>'
                        
                            };
                        }
                    }
                    return yj
                }
            }
            ,{
                field:'apply_time', 
                fixed: 'right',
                minWidth:140, 
                title: '操作',
                templet:function(d){
                    var ss=(d.status==0?'<a class="layui-btn layui-btn-xs" lay-event="Approval">知悉</a>':'<a class="layui-btn layui-btn-xs layui-btn-disabled">知悉</a>')
                    +'<a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>'
                    return ss;
                }
            }

            ]],
                request: {
                pageName: 'currentIndex' //页码的参数名称，默认：page
                    ,
                limitName: 'pageSize' //每页数据量的参数名，默认：limit
            },
            parseData: function (res) { //res 即为原始返回的数据
                return {
                    "status_code": res.status_code, //解析接口状态
                    "message": res.message, //解析提示文本
                    "count": res.data.total_count, //解析数据长度
                    "data": res.data.data_list, //解析数据列表
                    "curr": res.data.page_index
                };
            },
            done:function(data){
                for(var i =0; i<data.data.length; i++){
                    if(data.data[i].can_approval==true){
                        $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                    }else{
                        $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                    }
                    
                }
                form.render();
                //console.log(tableSub3.ID);
                if(tableSub3&&tableSub3.ID&&this.where.ID!=''){
                    $('div#danceAppr .layui-table-body.layui-table-main a[lay-event="detail"]').click();
                }
                autoFixed($(this.elem[0]).next());
            }
        })
        // 弹窗
        table.on('tool(danceTable)', function (obj) {
            var tdata = obj.data; //获得当前行数据
            var layEvent = obj.event;
            //console.log(layEvent)
            if(layEvent=="Approval"){
                layer.confirm('确定知悉?',{title:' '}, function(index){
                //do something
                    $.fetch({
                        url:"/gateway/attend/updateattendinform",
                        type: 'post',
                        data:{
                            ID:tdata.id,
                            DataType:forwardUrl,
                        },
                        cb:function(rs){
                            layer.close(index);
                            danceTable.reload({
                                where:{
                                    ID:'',
                                },
                                page: {
                                    curr: 1 //重新从第 1 页开始
                                }
                                ,done:function(data){
                                    for(var i =0; i<data.data.length; i++){
                                        if(data.data[i].can_approval==true){
                                            $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                                        }else{
                                            $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                                        }
                                        
                                    }
                                    form.render();
                                },
                            });
                        }
                    })
                });    
            }else if(layEvent=="detail"){
                // //console.log(tdata,"补录")
                var histry = '';
                if (tdata.approval_history.length > 0) {
                    for (var k = 0; k < tdata.approval_history.length; k++) {
                        var res = '';
                        var classList = '';
                        if (tdata.approval_history[k].is_forward == 1) { //是转发的
                            res = '--转发-->';

                            histry += '<p>【' + tdata.approval_history[k].username + '' + res + '' + tdata.approval_history[k].forward_username + '' //名字
                                //意见

                                +
                                '<em class=' + classList + '> ' +
                                tdata.approval_history[k].approval_time + '</em>】：<span class="list" title=' + tdata.approval_history[k].content + '>' //时间
                                +
                                tdata.approval_history[k].content + '</p>' //意见内容

                        } else { //是审批的

                            if (tdata.approval_history[k].approval_result == 1) {
                                res = '未通过';
                                classList = "red";
                            } else if (tdata.approval_history[k].approval_result == 2) {
                                res = '已通过';
                                classList = "green";
                            }

                            histry += '<p>【' + tdata.approval_history[k].username + '<em class=' + classList + '>' //名字
                                +
                                res + '' //意见
                                +
                                tdata.approval_history[k].approval_time + '</em>】：<span class="list" title=' + tdata.approval_history[k].content + '>' //时间
                                +
                                tdata.approval_history[k].content + '</p>' //意见内容
                        }
                    }
                } else {
                    histry = "暂无审批记录"
                }
                var Aware=''
                if(tdata.status==0){
                    Aware+='<div class="layui-form-item" style="width: 170px;">'
                        // +'<div class="layui-form-label">确定知悉?</div>'
                        +'<div class="layui-layer-btn layui-layer-btn-">'
                            +'<a class="layui-layer-btn0 determine">知悉</a>'
                            +'<a class="layui-layer-btn1 cancel">返回</a>'
                        +'</div>'
                    +'</div>'
                }
                var htmls ='<div class="layui-card" style="min-height:300px">'
                    +'<div class="layui-card-body">'
                            +'<div class="reviewCont layui-card-body layui-form">'
                                +'<div class="layui-form-item">'
                                    +'<div class="layui-inline">'
                                        +'<label class="layui-form-label">申请人：</label>'
                                        +'<div class="layui-input-inline cateID">'
                                            +'<span>'+tdata.apply_user_name+'</span>'
                                        +'</div>'
                                    +'</div>'
                                    +'<div class="layui-inline">'
                                        +'<label class="layui-form-label">申请时间：</label>'
                                        +'<div class="layui-input-inline cateID">'
                                            +'<span>'+tdata.apply_time+'</span>'
                                        +'</div>'
                                    +'</div>'

                                    // +'<div class="layui-inline">'
                                    //     +'<label class="layui-form-label">补录类型：</label>'
                                    //     +'<div class="layui-input-inline cateID">'
                                    //         +'<span>'+tdata.overtime_type_desc+'</span>'
                                    //     +'</div>'
                                    // +'</div>'
                                    
                                +'</div>'
                                // +'<div class="layui-form-item">'
                                //     +'<label class="layui-form-label">补录时长：</label>'
                                //     +'<div class="layui-input-block cateID ">'
                                //         +'<span>'+$.diffTime(tdata.start_time,tdata.end_time)+' (天)</span>'
                                //     +'</div>'
                                // +'</div>'
                                +'<div class="layui-form-item">'
                                    +'<label class="layui-form-label">补录时间：</label>'
                                    +'<div class="layui-input-block cateID ">'
                                        +'<span>'+tdata.check_in_out_time+'</span>'
                                    +'</div>'
                                +'</div>'
                                +'<div class="layui-form-item">'
                                    +'<label class="layui-form-label">补录原因：</label>'
                                    +'<div class="layui-input-block cateID">'
                                        +'<span>'+tdata.content+'</span>'
                                    +'</div>'
                                +'</div>'
                            +'</div>'
                            +'<fieldset class="layui-elem-field">'
                                +'<legend>审批历史</legend>'
                                +'<div class="layui-field-box">'+histry+'</div>'
                            +'</fieldset>'
                            +Aware
                        +'</div>'
                        +'</div>'
                layer.open({
                    type: 1,
                    title: "补录详情",
                    area: ['auto'],
                    content: htmls,
                    success:function(layero,index){
                        $(".determine").on('click',function(){
                            layer.confirm('确定知悉?',{title:' '}, function(index){
                //do something
                                $.fetch({
                                    url:"/gateway/attend/updateattendinform",
                                    type: 'post',
                                    data:{
                                        ID:tdata.id,
                                        DataType:forwardUrl,
                                    },
                                    cb:function(rs){
                                        layer.close(index);
                                        danceTable.reload({
                                            where:{
                                                ID:'',
                                            },
                                            page: {
                                                curr: 1 //重新从第 1 页开始
                                            }
                                            ,done:function(data){
                                                for(var i =0; i<data.data.length; i++){
                                                    if(data.data[i].can_approval==true){
                                                        $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                                                    }else{
                                                        $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                                                    }
                                                    
                                                }
                                                form.render();
                                            },
                                        });
                                    }
                                })
                            });  
                            // $.fetch({
                            //     url:"/gateway/attend/updateattendinform",
                            //     type: 'post',
                            //     data:{
                            //         ID:tdata.id,
                            //         DataType:forwardUrl,
                            //     },
                            //     cb:function(rs){
                            //         layer.close(index);
                            //         danceTable.reload({
                            //             where:{
                            //                 ID:'',
                            //             },
                            //             page: {
                            //                 curr: 1 //重新从第 1 页开始
                            //             }
                            //             ,done:function(data){
                            //                 for(var i =0; i<data.data.length; i++){
                            //                     if(data.data[i].can_approval==true){
                            //                         $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                            //                     }else{
                            //                         $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                            //                     }
                                                
                            //                 }
                            //                 form.render();
                            //             },
                            //         });
                            //     }
                            // })
                        })
                        $('.cancel').on('click',function(){
                            layer.close(index);
                        })
                    }
                })
            }
        })
        // 筛选
        $("#danceSur").on("click",function(){
            var UserName = $("#danceTit").val();
            var ApprovalResult = $("#danceSelect").val();

            var danceEndItem = $("#danceEndItem").val();
            var danceStartItem = $("#danceStartItem").val();
            danceTable.reload({
                where: {//记录搜索状态
                    ID:'',                    
                    ApprovalResult:ApprovalResult,
                    UserName: UserName,
                    StartTime:danceStartItem,
                    EndTime:danceEndItem,
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                },
                done:function(data){
                    for(var i =0; i<data.data.length; i++){
                        if(data.data[i].can_approval==true){
                            $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                        }else{
                            $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                        }
                        
                    }
                    form.render();
                },
            });
            if (UserName !== "" || ApprovalResult !== "") {
                $("#danceSurBack").css('display', 'inline-block');
            } else {
                $("#danceSurBack").css('display', 'none');
            }
        })
        // 返回
        $("#danceSurBack").on("click",function(){
            danceTable.reload({
                where:{
                    ID:'',                    
                },
                page: {
                    curr: 1 //重新从第 1 页开始
                }
                ,done:function(data){
                    for(var i =0; i<data.data.length; i++){
                        if(data.data[i].can_approval==true){
                            $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                        }else{
                            $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                        }
                        
                    }
                    form.render();
                },
            });
            $("#danceSurBack").css('display', 'none');
        })
    }
    var tabFun=function(tabIndex){
            // //console.log(tabIndex)
            var tabIndex = parseFloat(tabIndex)
            switch(tabIndex)
                {
                case 0:
                $.fetch({
                    url:"/gateway/userleave/leavetypes",
                    type: 'post',
                    cb:function(rs){
                        leavetypes=rs;
                                // popUrl = "/gateway/userleave/approval";
                                // forwardUrl="/gateway/userleave/forward";
                                // leaveTable()
                        leaveTable = table.render({
                            elem: '#leaveTable'
                            ,url:urls+'/gateway/userleave/informlist'
                            ,contentType: 'application/json',
                            content: '<div class="layui-card"><div class="layui-card-body layui-form modify-table-cell"><table lay-filter="overtime-History-table" class="layui-table" id="overtime-History-table"></table></div></div>',
                            method: 'post',
                            where: tableSub0,
                            page: true, //开启分页
                            // limits:false,
                            limits:[10,20,30,40,50,60,70,80,90,100,200,500,1000,5000],
                            toolbar:false,
                            loading: true,
                            toolbar: '',
                            defaultToolbar: ''
                            ,text: {
                                none: '暂无数据' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
                            }
                            ,cols: [[
                            {field:'depatment_name', minWidth:100, title: '部门'}
                            ,{field:'apply_user_name', minWidth:80, title: '姓名'}
                            ,{field:'day_count', minWidth:100, title: '请假天数'}
                            ,{field:'start_time', minWidth:160, title: '开始时间'}
                            ,{field:'end_time', title: '结束时间', minWidth: 160}
                            ,{
                                field:'experience', 
                                minWidth:130, 
                                title: '请假类型',
                                templet:function(d){
                                    // //console.log(leavetypes);
                                    return leavetypes[d.leave_type]+''+(d.is_cancel==1?'(取消申请)':'')
                                }
                            }
                            ,{field:'apply_time', minWidth:160, title: '申请时间'}
                            ,{field:'content', minWidth:100, title: '请假原因：'}
                            ,{
                                field:'approval_history', 
                                minWidth:320, 
                                title: '审批意见',
                                templet:function(d){
                                    var yj='';
                                    if(d.approval_history.length==0){
                                        yj ='暂无';
                                    }else{
                                        for(var k=0;k< d.approval_history.length;k++){
                                            var res='';
                                            var classList = '';
                                            if(d.approval_history[k].is_forward ==1){//是转发的
                                                res ='--转发-->';
                                                yj+='<p>【'+d.approval_history[k].username+''+res+ ''+d.approval_history[k].forward_username+''//名字
                                                                //意见
                                                        +'<em class='+classList+'> ' +d.approval_history[k].approval_time+'</em>】：'//时间
                                                            +d.approval_history[k].content+'</p>'//意见内容

                                            }else{//是审批的
                                                if(d.approval_history[k].approval_result==1){
                                                    res ="未批准";
                                                    classList = "red";
                                                }else if(d.approval_history[k].approval_result==2){
                                                    res ="已批准";
                                                    classList = 'green';
                                                }
                                                yj+='<p><span> 【'+d.approval_history[k].username +'<em class='+classList+'>'+res+' '+d.approval_history[k].approval_time+'</em>'+'】</span>'+d.approval_history[k].content+'</p>'
                                            }
                                        
                                        };
                                    }
                                    return yj
                                }
                            }
                            ,{
                                field:'apply_time', 
                                minWidth:120, 
                                title: '附件',
                                templet:function(d){
                                    var attachesArr =d.attaches;
                                    var attach='暂无附件';
                                    if(attachesArr&&attachesArr.length>0){
                                        attach='';
                                        for(var j=0;j<attachesArr.length;j++){
                                            attach+='<a title="点击下载" class="seeXqOutIn" target="_blank" href="/gateway/userleave/download/'+attachesArr[j].id+'" >'+attachesArr[j].original_name+'</a>'
                                        }
                                    }
                                    return attach
                                }
                            }
                            ,{
                                field:'apply_time', 
                                fixed: 'right',
                                minWidth:140, 
                                title: '操作',
                                templet:function(d){
                                    var ss=(d.status==0?'<a class="layui-btn layui-btn-xs" lay-event="Approval">知悉</a>':'<a class="layui-btn layui-btn-xs layui-btn-disabled">知悉</a>')
                                    +'<a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>'
                                    return ss;
                                }
                            }

                            ]],
                            request: {
                                pageName: 'currentIndex' //页码的参数名称，默认：page
                                ,limitName: 'pageSize' //每页数据量的参数名，默认：limit
                            },
                            parseData: function (res) { //res 即为原始返回的数据
                                return {
                                    "status_code": res.status_code, //解析接口状态
                                    "message": res.message, //解析提示文本
                                    "count": res.data.total_count, //解析数据长度
                                    "data": res.data.data_list, //解析数据列表
                                    "curr": res.data.page_index
                                };
                            },
                            done:function(data){
                                for(var i =0; i<data.data.length; i++){
                                    if(data.data[i].can_approval==true){
                                        $("#leaveAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
                                    }else{
                                        $("#leaveAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
                                    }
                                    
                                }
                                $("#SurveyTit").val(this.where.UserName);
                                $("#leaveSelect").val(this.where.ApprovalResult);
                                form.render();
                                if(tableSub0&&tableSub0.ID&&this.where.ID!=''){
                                    $('div#leaveAppr .layui-table-body.layui-table-main a[lay-event="detail"]').click();
                                }
                                autoFixed($(this.elem[0]).next());
                            }
                        })
                    
                    }
                });
                    popUrl = "/gateway/userleave/approval";
                    forwardUrl=1;
                    // leaveTable();
                    break;

                case 1:
                    popUrl = "/gateway/goout/approval";
                    forwardUrl=2;
                    // outgoTable();
                    outgoTableFun();
                    
                    break;

                case 2:
                    popUrl = "/gateway/overtime/approval";
                    forwardUrl=3;
                    // overTimeTable();
                    overTimeTableFun();
                    
                    break;

                case 3:
                    popUrl = "/gateway/checkinoutapply/approval";
                    forwardUrl=4;
                    // danceTable();
                    danceTableFun();
                    
                    break;

                }
    }
        // //console.log()
        if(tabId){
            element.tabChange('approval-tabs-brief', tabId);
            tabFun(tabId-1);

        }else{
            tabFun(0)
            var tableSub0={}
            var tableSub1={}
            var tableSub2={}
            var tableSub3={}
        }
        
        element.on('tab(approval-tabs-brief)', function(obj){
            var tabIndex =obj.index;
            tableSub0={ID:''}
            tableSub1={ID:''}
            tableSub2={ID:''}
            tableSub3={ID:''}
            // //console.log(tableSub3)
            tabFun(tabIndex)
        });

    //审核弹窗
    // var apprPopFun=function(elem,url,furl,TableID){
    //     //选择不同意所需 请勿删除
    //     var slectHtml=$("#nextDacApp").html();
    //     $("#approvPop").off("change").on("change","input[name='approvalYn']",function(){
    //         var vals =$("#approvPop").find(" input[name='approvalYn']:checked").val();
    //        if(vals ==1){
    //             $("#nextDacApp").html('<option value="0">无</option>');
    //        }else{
    //             $("#nextDacApp").html(slectHtml);
    //        }
    //     })
    //     $("#approvPop .appOk").off("click").on("click",function(){// 接口参数,删除的table item
    //         var itemID = $(this).attr("data-item");
    //         var nextApprovalUserID = $("#approvPop #nextDacApp").val();
    //         var isAgree = $("#approvPop").find(" input[name='approvalYn']:checked").val();
    //         var content = $("#appDacText").val();
    //         var nextApprovalStep =$("#approvPop #nextDacApp").attr('data-step');
    //         if(content==''){
    //             layer.msg("意见不能为空!");
    //             return false
    //         }
    //         $.fetch({
    //             url:url,
    //             type: 'post',
    //             data:{
    //                 ItemID:itemID,
    //                 NextApprovalUserID:nextApprovalUserID,
    //                 NextApprovalStep:nextApprovalStep,
    //                 IsAgree:isAgree,
    //                 Content:content,
    //             },
    //             cb:function(rs){
    //                 layer.closeAll();
    //                 table.reload(TableID,{
    //                     where:{},
    //                     done:function(data){
    //                         for(var i =0; i<data.data.length; i++){
    //                             if(data.data[i].can_approval==true){
    //                                 $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
    //                             }else{
    //                                 $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
    //                             }
                                
    //                         }
    //                         form.render();
    //                     }
    //                 })
    //                 layer.msg("审批完成");
    //             }
    //         })
    //     })

    //     $("#okForward").off('click').on("click",function(){// 接口参数,删除的table item
    //         var itemID = $(this).attr("data-item");
    //         var ForwardUserID =$("#dacAppForward").val();
    //         var content = $("#appDacText").val();
    //         if(content==''){
    //             layer.msg("意见不能为空!");
    //             return false
    //         }
    //         $.fetch({
    //             url:furl,
    //             type: 'post',
    //             data:{
    //                 ItemID:itemID,
    //                 ForwardUserID:ForwardUserID,
    //                 Content:content,
    //             },
    //             cb:function(rs){
    //                 layer.msg("转交完成");
    //                 layer.closeAll();
    //                 table.reload(TableID,{
    //                     where:{},
    //                     done:function(data){
    //                         for(var i =0; i<data.data.length; i++){
    //                             if(data.data[i].can_approval==true){
    //                                 $("#danceAppr .layui-table-main tr").eq(i).addClass("ColorPrompt")
    //                             }else{
    //                                 $("#danceAppr .layui-table-main tr").eq(i).removeClass("ColorPrompt")
    //                             }
                                
    //                         }
    //                         form.render();
    //                     }
    //                 })
    //                 elem.remove();
    //             }
    //         })
    //     })
    // }
    $("#offSelMember").on("click",function(){
        $("#approvPop").hide();
        $("#approvPop").find('textarea').val("");
    })
    $("#approvPop .appNone").on("click",function(){
        $("#approvPop").hide();
        $("#approvPop").find('textarea').val("");
    })

})
})
</script>
<dtml>
