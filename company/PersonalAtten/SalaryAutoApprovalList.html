<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>工资设置审批(自动计算)</title>
<link rel="stylesheet" type="text/css" href="../../css/iconFont/iconfont.css">
<link rel="stylesheet" type="text/css" href="../../layui/css/layui.css">
<link rel="stylesheet" type="text/css" href="../../layui/css/admin.css">
<link rel="stylesheet" type="text/css" href="../../css/formSelects-v4.css">
<script src="../../js/jquery.min.js"></script>
</head>
	
<body layadmin-themealias="default">
    <div class="layui-fluid">
        <div class="layui-card">
                            
                <div class="layui-card-header">工资设置审批(自动计算)</div>
            <!-- <div class="layui-tab layui-tab-brief" lay-filter="component-tabs-brief"> -->
                <!-- <ul class="layui-tab-title">
                    <li class="layui-this">待审批报销付款单</li>
                    <li>已审批报销付款单</li>                
                    <li>我的转发</li>                
                </ul> -->
                <div class="layui-card-body">
                    <div class="layui-form">
                        <div class="layui-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">用户名</label>
                                <div class="layui-input-inline">
                                    <input type="text"  class="layui-input" id="UserName" name="UserName">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">部门：</label>
                                <div class="layui-input-inline">
                                    <!-- <select id="DepartmentID" lay-filter="DepartmentID" name="DepartmentID"></select> -->
                                    <select type="text" xm-select="DepartmentID"  id="DepartmentID" name="DepartmentID" placeholder="全部" autocomplete="off" class="xm-input xm-select" xm-select-search="" xm-select-radio=""><option value="">全部</option></select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">岗位：</label>
                                <div class="layui-input-inline">
                                    <!-- <select id="JobTitleID" lay-filter="JobTitleID"  name="JobTitleID"></select> -->
                                    <select type="text"  id="JobTitleID" name="JobTitleID" placeholder="全部" autocomplete="off" class="layui-input"  xm-select="JobTitleID"  xm-select-search="" xm-select-radio=""><option value="">全部</option></select>
                                </div>
                            </div>
                            <div class="layui-inline" style="margin-top: 5px">
                                <label class="layui-form-label">状态：</label>
                                <div class="layui-input-inline">
                                    <select id="ApprovalResult" lay-filter="ApprovalResult"  name="ApprovalResult">
                                        <option value="-1">全部</option>
                                        <option value="0">待审批</option>
                                        <option value="1">未通过</option>
                                        <option value="2">已通过</option>
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <button class="layui-btn layui-btn-sm"  lay-filter="filterTabelSel" id="filterTabelSel" title="查询">
                                    <i class="iconfont icon-sousuo"></i>
                                </button>
                                <button class="layui-btn layui-btn-sm"  lay-filter="closeLayer" id="closeLayer">
                                    返回
                                </button>
								 <button class="layui-btn layui-btn-sm"  lay-filter="subAppr" id="subAppr">
                                    批量审批
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="layui-tab-item layui-show layui-form ">
                            <table class="layui-table" lay-filter="allUserList" id="allUserList"></table>

                    </div>
                  
                </div>
            </div>
        <!-- </div> -->
    </div>
</body>
<style>
    .xm-select-parent .xm-form-select dl{
        min-width: 220%;
    }
</style>
<script src="../../layui/layui.js"></script>
<script src="../../js/jquery.jqprint-0.3.js?v=201902190"></script>
<script src="../../js/common.js?v=20190105"></script>
<script>
    
    layui.config({
        base: '../../../layui/' //静态资源所在路径
    }).extend({
        index: 'index' //主入口模块
    }).use(['index','table','laydate','form','laypage','formSelects'], function(){
        var $ = layui.$
        ,admin = layui.admin
        ,element = layui.element
        ,upload=layui.upload
        ,router = layui.router();
        element.render();

        var laydate = layui.laydate
        ,form = layui.form
        ,layer = layui.layer
        ,table=layui.table
    	,formSelects = layui.formSelects
        ,laypage=layui.laypage;

        // var tableNowPage={
        //     ApplyResult:0,
        //     currentIndex:1,
        //     pageSize:10,
        // }
        var urlTab = location.href.split('?tab=')[1]?location.href.split('?tab=')[1]:false;
        var tabId=urlTab?urlTab.split('?')[0]:false;
        var dataId = location.href.split('?id=')[1]?location.href.split('?id=')[1]:false;

       
        // 修正浮动栏高度
        // @param tableElem 表格显示div
        // function autoFixed(tableElem) {
        //     var $tableView = tableElem || $(".layui-table-view");
        //     var dataIndex ,trHeight;
        //     $tableView.each(function() {
        //         // 获取两侧浮动栏
        //         var $fixed = $(this).find(".layui-table-fixed");
        //         // 同步表头高度
        //         $fixed.find(".layui-table-header tr").height($(this).find(".layui-table-header tr").eq(0).height());
        //         // 遍历tr 修正浮动栏行高
        //         $(this).find(".layui-table-main tr").each(function() {
        //             dataIndex = $(this).attr("data-index");
        //             trHeight = $(this).css("height");
        //             $fixed.find("tr[data-index=" + dataIndex + "]").css("height", trHeight);
        //         })
        //     });
        // }
        // 监听浏览器窗口大小变化
        // var resizeTimer;
        // $(window).resize(function() {
        //     if (resizeTimer) {
        //         clearTimeout(resizeTimer);
        //     }
        //     resizeTimer = setTimeout(function() {
        //         resizeTimer = null;
        //         autoFixed();
        //     },
        //     200);
        // });

        // // 监听表头鼠标按下事件
        // $(document).on('mousedown', 'thead',function(e) {
        //     var that = $(this);
        //     $(document).one('mouseup',
        //     function() {
        //         autoFixed(that.parents('.layui-table-view'));
        //     })
        // });
        $.fetch({//部门树列表
			url: "/gateway/department/tree",
			type: 'post',
			cb:function(rs){
			//	console.log(rs)
				var formSelectsArr=rs[0].children[0].children;
				// formSelectsArr.unshift({'name':'全部','id':'-1'})
				formSelects.config('DepartmentID', {
					keyName: 'name',
					keyVal: 'id'
				})
				layui.formSelects.data('DepartmentID', 'local', {
					radio: true,
					arr:formSelectsArr
				});
				
				// formSelects.render('deptId', {
				//     radio: true,                    //是否设置为单选模式
				// });
			}
		});
		$.fetch({//岗位树列表
			url: "/gateway/jobTitle/tree",
			type: 'post',
			cb:function(rs){
			//	console.log(rs)
				var formSelectsArr=rs;
				// formSelectsArr.unshift({'name':'全部','id':'-1'})
				formSelects.config('JobTitleID', {
					keyName: 'title_name',
					keyVal: 'id'
				})
				formSelects.data('JobTitleID', 'local', {
					radio: true,
					arr:formSelectsArr
				}); 
				// formSelects.render('deptId', {
				//     radio: true,                    //是否设置为单选模式
				// });
			}
        });
        var  userbasicsalaryFun =function(datas,fun){
								var userbasicsalaryName={
									air_tickets_deduct: 'AirTicketsDeduct'
									,basic_salary: 'BasicSalary'
									,deduction: 'Deduction'
									,rental_fees_jian:'RentalFeesJian'
									,guarantee_deduct: 'GuaranteeDeduct'
									,medicine_subsidy: 'MedicineSubsidy'
									,spring_festival_subsidy: 'SpringFestivalSubsidy'
									,temp_visa_deduct: 'TempVisaDeduct'
									,travel_visa_deduct: 'TravelVisaDeduct'
									,visa_deduct: 'VisaDeduct'
									,water_electricity_jian: 'WaterElectricityJian'
									,wrong_money_jian: 'WrongMoneyJian'
									
									,first_currency_amount: 'FirstCurrencyUnitID'
									,first_currency_unit_id: 'FirstCurrencyAmount'
									,ticheng_jia:'TiCheng'
									,xiangmu_jixiao_jia:'XiangMuJiXiao'
								}
								var userbasicsalaryUni={}
								// $('#setdeductionForm').addClass("mnlTable");
                        //		console.log(datas)
                        // apply_result
								$.fetch({
									url:'/gateway/usersalary/mnl/approvallist',
									type: 'post',
									data:datas,
									cb:function(rs){
										var cols= [
                                        {type:'checkbox',fixed:'left'},{fixed:'left',field:'user_name',title:'姓名',sort:true,align: 'center',minWidth:80},{fixed:'left',field:'dpt_name',title:'部门',align: 'center',sort:true,minWidth:110},{fixed:'left',field:'title_name',title:'岗位',sort:true,align: 'center',minWidth:110}
										// ,{field:'basic_salary',title:'基本薪资',align: 'center',sort:true,minWidth:110},
										
										// {field:'basic_currency_name',title:'基本薪资币种',align: 'center',sort:true,minWidth:110}
										];
										// for(var i=0;i<rs.columns.length;i++){
										// 	if(rs.columns[i].is_display){
										// 		cols.push({field:''+rs.columns[i].column_name+'',title:''+rs.columns[i].zh_name+'('+['','补贴','扣除'][rs.columns[i].calc_type] +')<br>币种：'+rs.columns[i].currency_unit_name+'',sort:true,align: 'center',minWidth:180},)//edit:'text',
										// 		userbasicsalaryUni[''+rs.columns[i].column_name+'']=rs.columns[i].currency_unit_id;
										// 	}
                                        // }
										cols.push(
											// {field:'auto_update_salary',title:'是否自动',align: 'center',fixed:'right',sort:true,minWidth:100,templet: function (d){return ['否','是',''][d.auto_update_salary==null?2:d.auto_update_salary]}},
											{field:'apply_result_desc',title:'状态',align: 'center',fixed:'right',sort:true,minWidth:110},{field:'',title:'操作',minWidth:130,fixed:'right',
                                            
                                            templet: function(d){
                                                var btn=d.apply_result==0?'<button class="layui-btn layui-btn-xs" lay-event="appr">审批</button>':'';
                                                return '<div>'+btn+'</div>'
                                            }
											
										})
										var data=rs.salary_list.data.data_list;
										var allStaList = table.render({
											elem: '#allUserList',
											limit:100000000,
											// limits:[10,20,30,40,50,60,70,80,90,100,200,500,1000,5000],
											// url: urls+'/gateway/usersalary/userbasicsalary',
											// method: 'post',
											// contentType: 'application/json',
											toolbar:'',
											defaultToolbar:'',
											page:false,
											text: {
												none: '暂无' 
											},
											size:'sm',
											even:true,
											initSort: {
												field: 'basic_salary' //排序字段，对应 cols 设定的各字段名
												,type: 'desc' //排序方式  asc: 升序、desc: 降序、null: 默认排序
											},
											height: 'full-235',
											cols: [cols],
											data:data,
											done:function(res){
												setTimeout(function() {
													if(dataId&&fun){
														$('.layui-table-body.layui-table-main button[lay-event="edit"]').click();
													}
												}, 1);
                                                 
												$("div[lay-id='allUserList'] div.layui-table-header th div").height(38)
												 if(data.length==0){
                                                     $("div[lay-id='allUserList'] .layui-table-body.layui-table-main").html('<div class="layui-none">暂无数据</div>')
												    $("div[lay-id='allUserList']  .layui-table-body.layui-table-main").height(56)
                                                     
												 }
												var mnlData=res.data;
												for(var i=0;i<mnlData.length;i++){
													if(mnlData[i].apply_result!==0){
														$("div[lay-id='allUserList']").find('td[data-field="user_name"]').each(function(){
															// console.log($(this).text())
															if($(this).text()==mnlData[i].user_name){
																$(this).siblings('td[data-field="0"]').children('div').html(' ');
															}
														})

													}
												}
											
											},
											// request: {
											//      pageName: 'currentIndex' //页码的参数名称，默认：page
											//      ,limitName: 'pageSize' //每页数据量的参数名，默认：limit
											// }
											// ,parseData: function(res){ //res 即为原始返回的数据
											// 	return {
											// 		"status_code":res.status_code, //解析接口状态
											// 		"message": res.message, //解析提示文本
											// 	"count": res.data.total_count, //解析数据长度
											// 		"data": res.data, //解析数据列表
											// "curr":res.data.page_index
											// 	};
											// }
										})
										window.yourFunction=function(){//解决列表定位列无高度问题
											var tableHeight=$(".layui-form.layui-border-box.layui-table-view").height();
											$(".layui-table-body.layui-table-main").height(tableHeight-29);
											$(".layui-table-fixed.layui-table-fixed-l .layui-table-body").height(tableHeight-46);
											
											// console.log(tableHeight)
										}
										setTimeout('window.yourFunction()',10);
										
							
										table.on('tool(allUserList)', function(obj){
										//	console.log(obj.tr) //得到当前行元素对象
										//	console.log(obj.data) //得到当前行数据
											var layEvent = obj.event;
										//	console.log(obj.data)
											if(layEvent === 'edit'){
												$.fetch({
													url:"/gateway/usersalary/mnl/rateinit",
													type:'post',
													cb:function(rate){
														var ophtml="";
														var rateD={};
														for(var i=0;i<rate.length;i++){
															ophtml+='<option value="'+rate[i].id+'">'+rate[i].zh_name+'('+rate[i].short_code+')</option>'
															rateD[rate[i].id]=rate[i].zh_name+'('+rate[i].short_code+')'
														}
														
														var conthtmls6input='';
													//	console.log(obj.data.user_id);
														var userbasicsalaryUid=obj.data.user_id;
														for(key in obj.data){
															// console.log($('th[data-field="'+key+'"]').text())
															var labelText=$('th[data-field="'+key+'"]').text();
														//	console.log(userbasicsalaryName[key])
															if(labelText!=''&&userbasicsalaryName[key]!=undefined&&key!='basic_salary'){
																conthtmls6input += '<div class="layui-inline">'
																				+'<label class="layui-form-label" style="width: 128px;">'+labelText+'</label>'
																					+'<div class="layui-input-inline">'
																						+'<input type="text" name="'+userbasicsalaryName[key]+'" value="'+(obj.data[key]==null?'':obj.data[key])+'" placeholder="请输入" autocomplete="off" class="layui-input num2" disabled="disabled">'
																					+'</div>'
																					+'<div class="layui-form-mid layui-word-aux" style=" width: 110px;">'+rateD[userbasicsalaryUni[key]]+'</div>'
																				+'</div>'
																				
															}
														}
															// $('#setdeductionForm').addClass("mnlTable");
													
														if(obj.data.is_all==null||obj.data.is_all==''){
															obj.data.is_all=0;
														}
														var conthtmls6 ='<div class="layui-card">'
																			+'<div class="layui-card-body layui-form">'
																					+'<div class="layui-form-item">'
																							+'<div class="layui-inline"><label class="layui-form-label" style="width: 128px;">姓名：</label><div class="layui-form-mid layui-word-aux">'+(obj.data.user_name==null?"暂无":obj.data.user_name)+'</div></div>'
																							+'<div class="layui-inline"><label class="layui-form-label" style="width: 128px;">部门：</label><div class="layui-form-mid layui-word-aux">'+(obj.data.dpt_name==null?"暂无":obj.data.dpt_name)+'</div></div>'
																							+'<div class="layui-inline"><label class="layui-form-label" style="width: 128px;">岗位：</label><div class="layui-form-mid layui-word-aux">'+(obj.data.title_name==null?"暂无":obj.data.title_name)+'</div></div>'
																							+'<div class="layui-inline"><label class="layui-form-label" style="width: 128px;">显示在工资列表：</label><div class="layui-form-mid layui-word-aux">'+(obj.data.is_show==1?"是":'否')+'</div></div>'
																					+'</div>'
																						
																					
																					+'<div class="layui-form-item">'
																						+'<div class="layui-inline">'
																								+'<label class="layui-form-label" style="width: 128px;"><span style="color:red">*</span>基本薪资</label>'
																								+'<div class="layui-input-inline"><input disabled="disabled" type="text" name="BasicSalary"  id="BasicSalary" value="'+(obj.data.basic_salary==null?'':obj.data.basic_salary)+'"  placeholder="请输入" autocomplete="off" class="layui-input num2"></div>'
																								+'<div class="layui-form-mid layui-word-aux" style=" width: 110px;"></div>'
																						+'</div>'
																						+'<div class="layui-inline">'
																							+'<label class="layui-form-label" style="width: 128px;"><span style="color:red">*</span>基本薪资币种</label>'
																							+'<div class="layui-input-inline"><select disabled="disabled" id="BasicSalaryCurrencyUnitID" name="BasicSalaryCurrencyUnitID">'+ophtml+'</select></div>'
																						+'</div>'
																						+conthtmls6input
																						+'<div class="layui-inline">'
																								+'<label class="layui-form-label" style="width: 128px;">是否房屋补贴</label>'
																								+'<div class="layui-input-inline">'
																									+'<input type="radio" lay-filter="HasHousingSubsidy" name="HasHousingSubsidy" value="1" disabled="disabled" title="是" '+(obj.data.has_housing_subsidy==1?'checked':'')+'>'
																									+'<input type="radio" lay-filter="HasHousingSubsidy" name="HasHousingSubsidy" value="0" disabled="disabled" title="否" '+(obj.data.has_housing_subsidy==0?'checked':'')+'>'
																								+'</div>'
																						+'</div>'
																					+'</div>'
																					+'<div class="layui-form-item">'
																						+'<div class="layui-inline">'
																								+'<label class="layui-form-label" style="width: 128px;">工资货币</label>'
																								+'<div class="layui-input-inline">'
																									+'<input type="radio" disabled="disabled" lay-filter="checkIsAll" name="checkIsAll" value="1" title="全" '+(obj.data.is_all==1?'checked':'')+'>'
																									+'<input type="radio" disabled="disabled" lay-filter="checkIsAll" name="checkIsAll" value="0" title="部分" '+(obj.data.is_all==0?'checked':'')+'>'
																								+'</div>'
																						+'</div>'
																						+'<div class="layui-inline">'
																								+'<label class="layui-form-label" style="width: 128px;">是否自动计算</label>'
																								+'<div class="layui-input-inline">'
																									+'<input type="radio"  disabled="disabled" lay-filter="AutoUpdateSalary" name="AutoUpdateSalary" value="1" title="是" '+(obj.data.auto_update_salary==1?'checked':'')+'>'
																									+'<input type="radio"  disabled="disabled" lay-filter="AutoUpdateSalary" name="AutoUpdateSalary" value="0" title="否" '+(obj.data.auto_update_salary==0?'checked':'')+'>'
																								+'</div>'
																						+'</div>'
																					+'</div>'

																					+'<div class="layui-form-item all">'
																						//领
																						+'<div class="layui-inline">'
																							+'<label class="layui-form-label" style="width: 128px;">打回币种</label> <div class="layui-input-inline"><select id="SecondCurrencyUnitID" disabled="disabled" name="SecondCurrencyUnitID">'+ophtml+'</select></div>'
																						+'</div>'
																					// +'</div>'

																					    +'<div class="layui-inline part '+(obj.data.is_all==1?'layui-hide':'')+'">'
																						// +'<div class="layui-inline">'
																							+'<label class="layui-form-label" style="width: 128px;">固定领取币种</label> <div class="layui-input-inline"><select  disabled="disabled" id="FirstCurrencyUnitID" name="FirstCurrencyUnitID">'+ophtml+'</select></div>'
																						+'</div>'
																					// +'</div>'
																					    +'<div class="layui-inline part '+(obj.data.is_all==1?'layui-hide':'')+'">'
																						//外币 打
																						// +'<div class="">'
																							+'<label class="layui-form-label" style="width: 128px;">固定领取金额</label> <div class="layui-input-inline"><input  disabled="disabled" type="text" id="FirstCurrencyAmount" name="FirstCurrencyAmount" placeholder="请输入" value="'+(obj.data.first_currency_amount==null?'':obj.data.first_currency_amount)+'" autocomplete="off" class="layui-input num2"></div>'
                                                                                        +'</div>'
                                                                                        

                                                                                    +'</div>'
                                                                                    if(obj.data.apply_result==0){

                                                                                    
                                                                                        conthtmls6+=' <div class="layui-form-item layui-form-text">'
                                                                                        +'     <label class="layui-form-label">审批意见</label>'
                                                                                        +'     <div class="layui-input-block">'
                                                                                        +'   <textarea name="Content" id="Content" placeholder="请输入内容" class="layui-textarea"></textarea>'  
                                                                                        +'    </div>' 
                                                                                        +' </div>'
                                                                                        +'<div class="layui-form-item">'
                                                                                            +'<div class="layui-inline">'
                                                                                                    +'<label class="layui-form-label">是否通过</label>'
                                                                                                    +'<div class="layui-input-inline">'
                                                                                                        +'<input type="radio" lay-filter="IsAgree" name="IsAgree" value="2" title="通过" >'
                                                                                                        +'<input type="radio" lay-filter="IsAgree" name="IsAgree" value="1" title="不通过" >'
                                                                                                    +'</div>'
                                                                                            +'</div>'
                                                                                        +'</div>'
                                                                                    } else {
                                                                                        conthtmls6+='<div class="layui-form-item">'
                                                                                        +'<div class="layui-input-block">'
                                                                                            
                                                                                        if(obj.data.approval_history&&obj.data.approval_history!=''&&obj.data.approval_history.length>0){
                                                                                            
                                                                                            for (var i=0; i< obj.data.approval_history.length;i++) {
                                                                                                var res ='';
                                                                                                var classList ='';
                                                                                                if(obj.data.approval_history[i].approval_result==1){
                                                                                                    res ="不同意";
                                                                                                    classList = "red";
                                                                                                }else if(obj.data.approval_history[i].approval_result==2){
                                                                                                    res ="同意";
                                                                                                    classList = 'green';
                                                                                                }else if(obj.data.approval_history[i].approval_result==0){
                                                                                                    res ="待审批";
                                                                                                    classList = 'gray';
                                                                                                }
                                                                                                var contEnt = obj.data.approval_history[i].content==null?'':obj.data.approval_history[i].content
                                                                                                var updatedAt = obj.data.approval_history[i].updated_at==null?' ':obj.data.approval_history[i].updated_at

                                                                                                conthtmls6 +='<p><span> 【 '+obj.data.approval_history[i].username+''+(obj.data.approval_history[i].is_revocation==1?'<em class="red">[撤销审批]</em>':'')+'<em class='+classList+'>'+res+' '+updatedAt+'</em> 】</span>'+contEnt+'</p>'
                                                                                            }
                                                                                        }else{
                                                                                                conthtmls6+='暂无审批历史'
                                                                                        }
                                                                                        conthtmls6+='</div>'
                                                                                        +'</div>'
                                                                                    }
																					conthtmls6+='<div class="layui-form-item">'
                                                                                                +'<div class="layui-input-block">'
                                                                                                if(obj.data.apply_result==0){
                                                                                                    conthtmls6+=' <button class=" layui-btn" id="subuserbasicsalary">提交</button>'
                                                                                                }   
                                                                                                conthtmls6+=' <button class=" layui-btn" id="backuserbasicsalary">取消</button>'
                                                                                                +'</div>'
																					        +'</div>'

																				+'</div>'
																		+'</div>'
															layer.open({
																title:'详情',
																type: 1, 
																id:"conthtmls6",
																content:conthtmls6,
																resize:false,            
																area:['90%', '90%'],   
																success:function(layero,index){
																	$("#backuserbasicsalary").on("click",function(){
																		layer.close(index);
																	})
																	form.on('radio(checkIsAll)', function(data){
																		if(data.value==1){
																			$(".part").addClass('layui-hide').removeClass('layui-show');
																		}else{
																			
																			$(".part").addClass('layui-show').removeClass('layui-hide');
																		}
																		
                                                                    }); 
																			
																	$("#BasicSalaryCurrencyUnitID").val(obj.data.basic_salary_currency_unit_id);
																	$("#FirstCurrencyUnitID").val(obj.data.first_currency_unit_id);
																	$("#SecondCurrencyUnitID").val(obj.data.second_currency_unit_id);
																	form.render();
																	$("#subuserbasicsalary").on("click",function(){
                                                                        var IsAgree=$("input[name='IsAgree']:checked").val();
																		
																	//	console.log(subData);
																		$.fetch({
																			url:'/gateway/usersalary/mnl/approval',
																			type: 'post',
																			data:{
                                                                                ID:obj.data.basic_salary_id,
                                                                                Content:$("#Content").val(),
                                                                                IsAgree:IsAgree,
                                                                            },
																			cb:function(rs){
																				layer.msg('审批成功');
																				layer.close(index);

																				var DepartmentID=formSelects.value('DepartmentID', 'valStr');
																				var JobTitleID=formSelects.value('JobTitleID', 'valStr');
                                                                                // console.log(DepartmentID,JobTitleID,000)
																				userbasicsalaryFun({
																					AutoUpdate:1,
																					UserName:$("#UserName").val(),
																					DepartmentID:DepartmentID==''?'-1':DepartmentID,
																					JobTitleID:JobTitleID==''?'-1':JobTitleID,
																					ApprovalResult:$("#ApprovalResult").val(),
																				},false)
																			}
																		})
																	})
																}
															})
															//obj.del(); //删除当前行
															//obj.update(fields) //修改当前行数据
														}
													})
															
													
												}else if(layEvent === 'appr'){
                                                    var conthtmlsappr ='<div class="layui-card-body layui-form">'
                                                                            +' <div class="layui-form-item layui-form-text">'
                                                                                 +'     <label class="layui-form-label">审批意见</label>'
                                                                                 +'     <div class="layui-input-block">'
                                                                                 +'   <textarea name="Content" id="Content" placeholder="请输入内容" class="layui-textarea"></textarea>'  
                                                                                        +'    </div>' 
                                                                                        +' </div>'
                                                                                        +'<div class="layui-form-item">'
                                                                                            +'<div class="layui-inline">'
                                                                                                    +'<label class="layui-form-label">是否通过</label>'
                                                                                                    +'<div class="layui-input-inline">'
                                                                                                        +'<input type="radio" lay-filter="IsAgree" name="IsAgree" value="2" title="通过" >'
                                                                                                        +'<input type="radio" lay-filter="IsAgree" name="IsAgree" value="1" title="不通过" >'
                                                                                                    +'</div>'
                                                                                            +'</div>'
                                                                                        +'</div>'
																					+'<div class="layui-form-item">'
                                                                                        +'<div class="layui-input-block">'
                                                                                        +' <button class=" layui-btn" id="subuserbasicsalary">提交</button>'
                                                                                
                                                                                        +' <button class=" layui-btn" id="backuserbasicsalary">取消</button>'
																						+'</div>'
																					+'</div>'

																				+'</div>'
                                                                layer.open({
                                                                    title:'审批',
                                                                    type: 1, 
                                                                    id:"conthtmlsappr",
                                                                    content:conthtmlsappr,
                                                                    resize:false,            
                                                                    area:['60%', '50%'],   
                                                                    success:function(layero,index){
                                                                        $("#backuserbasicsalary").on("click",function(){
                                                                            layer.close(index);
                                                                        })
                                                                        form.render();
                                                                        $("#subuserbasicsalary").on("click",function(){
                                                                            var IsAgree=$("input[name='IsAgree']:checked").val();
                                                                            
                                                                        //	console.log(subData);
                                                                            $.fetch({
                                                                                url:'/gateway/usersalary/mnl/approval',
                                                                                type: 'post',
                                                                                data:{
                                                                                    ID:obj.data.basic_salary_id,
                                                                                    Content:$("#Content").val(),
                                                                                    IsAgree:IsAgree,
                                                                                },
                                                                                cb:function(rs){
                                                                                    layer.msg('审批成功');
                                                                                    layer.close(index);

                                                                                    var DepartmentID=formSelects.value('DepartmentID', 'valStr');
                                                                                    var JobTitleID=formSelects.value('JobTitleID', 'valStr');
                                                                                    // console.log(DepartmentID,JobTitleID,000)
                                                                                    userbasicsalaryFun({
																						AutoUpdate:1,
                                                                                        UserName:$("#UserName").val(),
                                                                                        DepartmentID:DepartmentID==''?'-1':DepartmentID,
                                                                                        JobTitleID:JobTitleID==''?'-1':JobTitleID,
                                                                                        ApprovalResult:$("#ApprovalResult").val(),
                                                                                    },false)
                                                                                }
                                                                            })
                                                                        })
                                                                    }
                                                                })
                                                }
										});
										
										table.on('toolbar(allUserList)', function(obj){
										//	console.log(obj.tr) //得到当前行元素对象
										 	 //得到当前行数据
											var checkStatus = table.checkStatus(obj.config.id);
											if(checkStatus.data.length===0){
												layer.msg('无选中项，无法设置。');
												return false
											}
											var uNames='';
											var uIdsArr=[];
											for(var i =0;i<checkStatus.data.length;i++){
												uNames+='<li class="bg"><span>'+checkStatus.data[i].user_name+';</span><i data-id="'+checkStatus.data[i].user_id+'" class="layui-icon layui-unselect layui-tab-close">ဆ</i></li>';
												uIdsArr.push(checkStatus.data[i].user_id);
											}
											
											var SubUidsStr=uIdsArr.join(',');
											var userAmount=checkStatus.data.length;
											var firstData=checkStatus.data[0];
											var layEvent = obj.event;
											if(layEvent === 'editAll'){
												$.fetch({
													url:"/gateway/usersalary/mnl/rateinit",
													type:'post',
													cb:function(rate){
														var ophtml="";
														var rateD={};
														for(var i=0;i<rate.length;i++){
															ophtml+='<option value="'+rate[i].id+'">'+rate[i].zh_name+'('+rate[i].short_code+')</option>'
															rateD[rate[i].id]=rate[i].zh_name+'('+rate[i].short_code+')'
														}
														
														var conthtmls6input='';
													//	console.log(obj.data.user_id);
														// var userbasicsalaryUid=firstData.user_id;
														for(key in firstData){
															// console.log($('th[data-field="'+key+'"]').text())
															var labelText=$('th[data-field="'+key+'"]').text();
														//	console.log(userbasicsalaryName[key])
															if(labelText!=''&&userbasicsalaryName[key]!=undefined&&key!='basic_salary'){
																conthtmls6input += '<div class="layui-inline">'
																					+'<label class="layui-form-label" style="width: 128px;">'+labelText+'</label>'
																					+'<div class="layui-input-inline">'
																						+'<input type="text" name="'+userbasicsalaryName[key]+'" value="'+(firstData[key]==null?'':firstData[key])+'" placeholder="请输入" autocomplete="off" class="layui-input num2">'
																					+'</div>'
																					+'<div class="layui-form-mid layui-word-aux" style=" width: 110px;">'+rateD[userbasicsalaryUni[key]]+'</div>'
																				+'</div>'
																				
															}
														}
															// $('#setdeductionForm').addClass("mnlTable");
													
														if(firstData.is_all==null||firstData.is_all==''){
															firstData.is_all=0;
														}
														// console.log(uNames)
														
														var conthtmls6 ='<div class="layui-card">'
																			+'<div class="layui-card-body layui-form">'
																					+'<div class="layui-form-item">'
																							+'<div class="layui-inline"><label class="layui-form-label" style="width: 128px;">用户名：</label><ul class="layui-form-mid layui-word-aux user-list">'+(uNames==null?"暂无":uNames)+'</ul><div class="layui-form-mid layui-word-aux" style="display:none;"><button class="layui-btn layui-btn-xs" id="cancelDel">撤销删除</button></div></div>'
																							+'<div class="layui-inline"><label class="layui-form-label" style="width: 128px;">已选中：</label><div class="layui-form-mid layui-word-aux user-amount">'+(userAmount==null?"暂无":userAmount)+'人</div></div>'
																					+'</div>'
																						
																					
																					+'<div class="layui-form-item">'
																						+'<div class="layui-inline">'
																								+'<label class="layui-form-label" style="width: 128px;"><span style="color:red">*</span>基本薪资</label>'
																								+'<div class="layui-input-inline"><input type="text" name="BasicSalary"  id="BasicSalary" value="'+(firstData.basic_salary==null?'':firstData.basic_salary)+'"  placeholder="请输入" autocomplete="off" class="layui-input num2"></div>'
																								+'<div class="layui-form-mid layui-word-aux" style=" width: 110px;"></div>'
																						+'</div>'
																						+'<div class="layui-inline">'
																							+'<label class="layui-form-label" style="width: 128px;"><span style="color:red">*</span>基本薪资币种</label>'
																							+'<div class="layui-input-inline"><select id="BasicSalaryCurrencyUnitID" name="BasicSalaryCurrencyUnitID">'+ophtml+'</select></div>'
																						+'</div>'
																						+conthtmls6input
																						+'<div class="layui-inline">'
																								+'<label class="layui-form-label" style="width: 128px;">是否房屋补贴</label>'
																								+'<div class="layui-input-inline">'
																									+'<input type="radio" lay-filter="HasHousingSubsidy" name="HasHousingSubsidy" value="1" title="是" '+(firstData.has_housing_subsidy==1?'checked':'')+'>'
																									+'<input type="radio" lay-filter="HasHousingSubsidy" name="HasHousingSubsidy" value="0" title="否" '+(firstData.has_housing_subsidy==0?'checked':'')+'>'
																								+'</div>'
																						+'</div>'
																					+'</div>'
																					+'<div class="layui-form-item">'
																						+'<div class="layui-inline">'
																								+'<label class="layui-form-label" style="width: 128px;">工资货币</label>'
																								+'<div class="layui-input-inline">'
																									+'<input type="radio" lay-filter="checkIsAll" name="checkIsAll" value="1" title="全" '+(firstData.is_all==1?'checked':'')+'>'
																									+'<input type="radio" lay-filter="checkIsAll" name="checkIsAll" value="0" title="部分" '+(firstData.is_all==0?'checked':'')+'>'
																								+'</div>'
																						+'</div>'
																					+'</div>'

																					+'<div class="layui-form-item all">'
																						//领
																						+'<div class="layui-inline">'
																							+'<label class="layui-form-label" style="width: 128px;">打回币种</label> <div class="layui-input-inline"><select id="SecondCurrencyUnitID" name="SecondCurrencyUnitID">'+ophtml+'</select></div>'
																						+'</div>'
																					+'</div>'

																					+'<div class="layui-form-item part '+(firstData.is_all==1?'layui-hide':'')+'">'
																						+'<div class="layui-inline">'
																							+'<label class="layui-form-label" style="width: 128px;">固定领取币种</label> <div class="layui-input-inline"><select id="FirstCurrencyUnitID" name="FirstCurrencyUnitID">'+ophtml+'</select></div>'
																						+'</div>'
																					+'</div>'
																					+'<div class="layui-form-item part '+(firstData.is_all==1?'layui-hide':'')+'">'
																						//外币 打
																						+'<div class="layui-inline">'
																							+'<label class="layui-form-label" style="width: 128px;">固定领取金额</label> <div class="layui-input-inline"><input type="text" id="FirstCurrencyAmount" name="FirstCurrencyAmount" placeholder="请输入" value="'+(firstData.first_currency_amount==null?'':firstData.first_currency_amount)+'" autocomplete="off" class="layui-input num2"></div>'
																						+'</div>'
																					+'</div>'

																					+'<div class="layui-form-item">'
																						//领
																						+'<div class="layui-inline">'
																							+'<label class="layui-form-label" style="width: 128px;">审批人</label> <div class="layui-input-inline"><select id="ApprovalUserID" name="ApprovalUserID"></select></div>'
																						+'</div>'
																					+'</div>'

																					+'<div class="layui-form-item">'
																						+'<div class="layui-input-block">'
																							+' <button class=" layui-btn" id="subuserbasicsalary">保存</button>'
																							+' <button class=" layui-btn" id="backuserbasicsalary">取消</button>'
																						+'</div>'
																					+'</div>'

																				+'</div>'
																		+'</div>'
															layer.open({
																title:'基本工资设置',
																type: 1, 
																id:"conthtmls6",
																content:conthtmls6,
																resize:false,            
																area:['90%', '90%'],   
																success:function(layero,index){
																	//删除多选用户
																	$.fetch({
																		url: "/gateway/usersalary/mnl/getapprovaluser",
																		type: 'post',
																		data: {
																		    IsApprovalUser: 1
																		},
																		cb: function (rs) {
																			var op=''
																			if(rs&&rs.length>0){
																				for(var i=0;i<rs.length;i++){
																					op+='<option value="'+rs[i].id+'">'+rs[i].name+'</option>'
																				}
																			}else{
																				$("#subuserbasicsalary").attr('disabled','disabled').addClass('layui-btn-disabled');
																				layer.msg('未设置审批人,无法提交.');
																			}
																			$("#ApprovalUserID").html(op);
																			form.render();
																		}
        															})
																	if(userAmount==1){
																		$(".user-list li>.layui-tab-close").hide();
																	}else{
																		$(".user-list li>.layui-tab-close").show();
																		// $("#cancelDel").parent('div').show();
																	}
																	$(".user-list").on("click",'li>.layui-tab-close',function(){
																		var uid=$(this).attr('data-id');
																		$(this).parent("li").remove();
																		var SubUidsArr=SubUidsStr.split(',');
																		SubUidsArr.splice($.inArray(uid,SubUidsArr),1);
																		SubUidsStr=SubUidsArr.join(',');
																		userAmount=userAmount-1;
																		$(".user-amount").html(userAmount)
																		$("#cancelDel").parent('div').show();
																		if(userAmount==1){
																			$(".user-list li>.layui-tab-close").hide();
																		}else{
																			$(".user-list li>.layui-tab-close").show();
																			
																		}
																	})
																	 
																	$("#cancelDel").on("click",function(){
																		$(".user-list").html(uNames);
																		SubUidsStr=uIdsArr.join(',');
																		userAmount=uIdsArr.length;
																		$(".user-amount").html(userAmount)
																		$("#cancelDel").parent('div').hide();
																		
																		if(userAmount==1){
																			$(".user-list li>.layui-tab-close").hide();
																		}else{
																			$(".user-list li>.layui-tab-close").show();
																			
																		}
																	})

																	$("#backuserbasicsalary").on("click",function(){
																		layer.close(index);
																	})
																	form.on('radio(checkIsAll)', function(data){
																		if(data.value==1){
																			$(".part").addClass('layui-hide').removeClass('layui-show');
																			// $("#FirstCurrencyAmount").val()
																		}else{
																			
																			$(".part").addClass('layui-show').removeClass('layui-hide');
																			// $(".all").addClass('layui-hide').removeClass('layui-show');
																		}
																		
																	}); 
																	$("#conthtmls6").on('keyup','.layui-input.num2',function () {
																		NumberCheckten2x(this)
																	}).bind("paste", function () {  //CTR+V事件处理
																		NumberCheckten2x(this)
																		// $(this).val(NumberCheckten4($(this).val()));
																	}).css("ime-mode", "disabled"); //CSS设置输入法不可用
																			
																	$("#BasicSalaryCurrencyUnitID").val(firstData.basic_salary_currency_unit_id);
																	$("#FirstCurrencyUnitID").val(firstData.first_currency_unit_id);
																	$("#SecondCurrencyUnitID").val(firstData.second_currency_unit_id);
																	form.render();
																	$("#subuserbasicsalary").on("click",function(){
																		var subData={};
																		var BasicSalaryCurrencyUnitIDVal=$("#BasicSalaryCurrencyUnitID").val();
																		var BasicSalaryVal=$("#BasicSalary").val();
																		if(BasicSalaryCurrencyUnitIDVal==''||BasicSalaryCurrencyUnitIDVal==null){
																			layer.msg('基本薪资不能为空');
																			return false
																		}
																		if(BasicSalaryVal==''||BasicSalaryVal==null){
																			layer.msg('基本薪资币种不能为空');
																			return false															
																		}
																		$("#conthtmls6").find('input.layui-input.num2').each(function(){
																		//	console.log($(this).val())
																			var subName=$(this).attr("name");
																			subData[subName]=$(this).val();
																		})
																		subData['UserID']=SubUidsStr;						
																		// console.log($("input[name='checkIsAll']:checked").val())								
																		subData['IsAll']=$("input[name='checkIsAll']:checked").val();
																		subData['HasHousingSubsidy']=$("input[name='HasHousingSubsidy']:checked").val();
																		if(subData.IsAll==0){
																			subData['FirstCurrencyAmount']=$("#FirstCurrencyAmount").val();
																			subData['FirstCurrencyUnitID']=$("#FirstCurrencyUnitID").val();
																		}else if(subData.IsAll==1){
																			subData['FirstCurrencyAmount']=0;
																			subData['FirstCurrencyUnitID']='';
																		}
																		subData['BasicSalaryCurrencyUnitID']=$("#BasicSalaryCurrencyUnitID").val();
																		subData['SecondCurrencyUnitID']=$("#SecondCurrencyUnitID").val();
																		subData['ApprovalUserID']=$("#ApprovalUserID").val();
																		$.fetch({
																			url:'/gateway/usersalary/mnl/setbasicsalary',
																			type: 'post',
																			data:subData,
																			cb:function(rs){
																				layer.msg('保存成功');
																				layer.close(index);
																				var DepartmentID=formSelects.value('DepartmentID', 'valStr');
																				var JobTitleID=formSelects.value('JobTitleID', 'valStr');
																				// console.log(DepartmentID,JobTitleID,000)
																				userbasicsalaryFun({
																					AutoUpdate:1,
																					UserName:$("#UserName").val(),
																					DepartmentID:DepartmentID==''?'-1':DepartmentID,
																					JobTitleID:JobTitleID==''?'-1':JobTitleID,
																					IsShow:$("#IsShow").val(),
																				},false)
																			}
																		})
																	})
																}
															})
															//obj.del(); //删除当前行
															//obj.update(fields) //修改当前行数据
														}
													})
															
													
												}
												
										});
									}
								})
						
							}				
        if(dataId){
            var tableSub={
                ApprovalResult:'-1',
                ID:dataId,
                UserName:'',
                DepartmentID:'-1',
				AutoUpdate:1,
                JobTitleID:'-1',
            }
            userbasicsalaryFun(tableSub,true)
            
        }else{
            var tableSub={
                ID:'',
                ApprovalResult:'-1',
				AutoUpdate:1,
                UserName:'',
                DepartmentID:'-1',  
                JobTitleID:'-1',              
            }
            userbasicsalaryFun(tableSub,false)
            
        }
        $("#filterTabelSel").on("click",function(){
			// var datas=
			var DepartmentID=formSelects.value('DepartmentID', 'valStr');
			var JobTitleID=formSelects.value('JobTitleID', 'valStr');
	
          
            var wheres={ //设定异步数据接口的额外参数，任意设
				AutoUpdate:1,
                id:'',
                UserName:$("#UserName").val(),
                DepartmentID:DepartmentID==''?'-1':DepartmentID,
                JobTitleID:JobTitleID==''?'-1':JobTitleID,
                ApprovalResult:$("#ApprovalResult").val(),
                //…
            }
              
            userbasicsalaryFun(wheres,false)
            
		})
		$("#subAppr").on("click",function(){
			// var datas=
			// console.log(table.checkStatus('allUserList'))
			
			var checkStatus = table.checkStatus('allUserList').data;
			// console.log(checkStatus)
			var idArr=[],ids='';

			for(var i=0;i<checkStatus.length;i++){
				if(checkStatus[i].apply_result==0){
					idArr.push(checkStatus[i].basic_salary_id);
				}
			}

			if(idArr.length==0){
				layer.msg('请选择需要审批的人员');
				return false
			}else{
				ids=idArr.join(',');
			}
			// // var ids = checkStatus.map(v=>v.basic_salary_id).join(",")
			// if(!ids){
			// 	layer.msg('请选择需要审批的人员');
			// 	return false
			// }
			// console.log(checkStatus,ids)
			// 	return false
			
			var conthtmlsappr ='<div class="layui-card-body layui-form">'
                               +' <div class="layui-form-item layui-form-text">'
                                    +'     <label class="layui-form-label">审批意见</label>'
                                    +'     <div class="layui-input-block">'
                                    +'   <textarea name="Content" id="Content" placeholder="请输入内容" class="layui-textarea"></textarea>'  
                                           +'    </div>' 
                                           +' </div>'
                                           +'<div class="layui-form-item">'
                                               +'<div class="layui-inline">'
                                                       +'<label class="layui-form-label">是否通过</label>'
                                                       +'<div class="layui-input-inline">'
                                                           +'<input type="radio" lay-filter="IsAgree" name="IsAgree" value="2" title="通过" >'
                                                           +'<input type="radio" lay-filter="IsAgree" name="IsAgree" value="1" title="不通过" >'
                                                       +'</div>'
                                               +'</div>'
                                           +'</div>'
									+'<div class="layui-form-item">'
                                           +'<div class="layui-input-block">'
                                           +' <button class=" layui-btn" id="subuserbasicsalary">提交</button>'
                                   
                                           +' <button class=" layui-btn" id="backuserbasicsalary">取消</button>'
										+'</div>'
									+'</div>'
								+'</div>'
					layer.open({
						title:'批量审批',
						type: 1, 
						id:"conthtmlsappr",
						content:conthtmlsappr,
						resize:false,            
						area:['60%', '50%'],   
                        success:function(layero,index){
                               $("#backuserbasicsalary").on("click",function(){
                                   layer.close(index);
                               })
                               form.render();
                               $("#subuserbasicsalary").on("click",function(){
                                   var IsAgree=$("input[name='IsAgree']:checked").val();
                                   

                               //	console.log(subData);
                                   $.fetch({
                                       url:'/gateway/usersalary/mnl/approval',
                                       type: 'post',
                                       data:{
                                           ID:ids,
                                           Content:$("#Content").val(),
                                           IsAgree:IsAgree,
                                       },
                                       cb:function(rs){
                                           layer.msg('提交成功');
                                           layer.close(index);
                                           var DepartmentID=formSelects.value('DepartmentID', 'valStr');
                                           var JobTitleID=formSelects.value('JobTitleID', 'valStr');
                                           // console.log(DepartmentID,JobTitleID,000)
                                           userbasicsalaryFun({
												AutoUpdate:1,
												UserName:$("#UserName").val(),
												DepartmentID:DepartmentID==''?'-1':DepartmentID,
												JobTitleID:JobTitleID==''?'-1':JobTitleID,
												ApprovalResult:$("#ApprovalResult").val(),
                                           },false)
                                       }
                                   })
                               })
                           }
                       })
            
		})
   
		$("#closeLayer").on("click",function(){
			// var datas=
			layui.formSelects.value('DepartmentID', []); 
			layui.formSelects.value('JobTitleID', []); 
			$("#ApprovalResult").val('-1');
			$("#UserName").val('');
			form.render();
		
              var wheres={ //设定异步数据接口的额外参数，任意设
                    id:'',
                    UserName:'',
                    DepartmentID:'-1',
                    JobTitleID:'-1',
					AutoUpdate:1,
                    ApprovalResult:'-1',
                    //…
                }
              
            userbasicsalaryFun(wheres,false)
            
		})
   
    })
</script>
<style>
    /* .layui-table-cell{
        height: auto !important;
    }
    .layui-table-view .layui-table{
        height: 100%;
    }
    .layui-textarea{
        min-height:auto;
    } */
</style>
</html>
